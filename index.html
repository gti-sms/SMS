<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval' blob:">
    <title>Telefonia - Secretaria Municipal de Saúde PMPF</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ====== VARS & RESET ====== */
        :root{
            --primary:#2c6aa0;--primary-dark:#1e4a73;--secondary:#4caf50;
            --danger:#e74c3c;--warning:#f39c12;--light:#f8f9fa;
            --dark:#343a40;--gray:#6c757d;--border:#dee2e6;
            --shadow:0 4px 12px rgba(0,0,0,.1);--transition:all .3s ease;
            --radius:12px;--radius-sm:8px;
        }
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Arial,sans-serif}
        html,body{width:100%;height:100%;background:#f5f7fa;color:var(--dark);line-height:1.6;overflow-x:hidden}
        
        /* Container & Layout */
        .container{max-width:1400px;margin:0 auto;padding:0 20px;width:100%}
        
        /* Header Improvements */
        header{
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            color:#fff;padding:15px 0;box-shadow:var(--shadow);
            position:sticky;top:0;z-index:1000;backdrop-filter:blur(10px);
        }
        .header-content{display:flex;justify-content:space-between;align-items:center;width:100%}
        .logo{display:flex;align-items:center;gap:15px}
        .logo i{font-size:2.2rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
        .logo h1{font-size:1.8rem;font-weight:700;letter-spacing:-0.5px}
        .header-actions{display:flex;gap:12px;align-items:center}
        .theme-toggle,.admin-toggle{
            background:rgba(255,255,255,.25);border:0;color:#fff;
            width:44px;height:44px;border-radius:50%;cursor:pointer;
            display:flex;align-items:center;justify-content:center;
            transition:var(--transition);backdrop-filter:blur(10px);
        }
        .theme-toggle:hover,.admin-toggle:hover{
            background:rgba(255,255,255,.4);transform:scale(1.05);
        }
        
        /* Modal Improvements */
        .login-modal{
            display:none;position:fixed;inset:0;
            background:rgba(0,0,0,.6);z-index:2000;
            align-items:center;justify-content:center;backdrop-filter:blur(5px);
        }
        .login-modal.active{display:flex}
        .login-form{
            background:#fff;padding:35px;border-radius:var(--radius);
            box-shadow:0 20px 40px rgba(0,0,0,.3);width:100%;
            max-width:420px;transform:translateY(-20px);animation:slideUp .3s ease forwards;
        }
        @keyframes slideUp{to{transform:translateY(0)}}
        .login-form h2{margin-bottom:25px;color:var(--primary-dark);text-align:center;font-weight:600}
        
        /* Form Improvements */
        .form-group{margin-bottom:20px}
        .form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark)}
        .form-control{
            width:100%;padding:12px 16px;border:2px solid var(--border);
            border-radius:var(--radius-sm);font-size:1rem;transition:var(--transition);
            background:#fff;
        }
        .form-control:focus{
            outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(44,106,160,.15);
            transform:translateY(-1px);
        }
        .btn{
            padding:12px 24px;border:0;border-radius:var(--radius-sm);cursor:pointer;
            font-weight:600;transition:var(--transition);display:flex;
            align-items:center;gap:10px;font-size:0.95rem;
        }
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 4px 12px rgba(44,106,160,.3)}
        .btn-secondary{background:var(--gray);color:#fff}
        .btn-success{background:var(--secondary);color:#fff}
        .btn-success:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(76,175,80,.3)}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-warning{background:var(--warning);color:#fff}
        
        /* Admin Panel Improvements */
        .admin-panel{
            display:none;background:#fff;border-radius:var(--radius);
            padding:30px;margin:30px 0;box-shadow:var(--shadow);width:100%;
            border:1px solid rgba(0,0,0,.05);
        }
        .admin-panel.active{display:block;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0} to{opacity:1}}
        .admin-header{
            display:flex;justify-content:space-between;align-items:center;
            margin-bottom:25px;padding-bottom:20px;
            border-bottom:3px solid var(--primary);
        }
        .admin-title{font-size:1.6rem;font-weight:700;color:var(--primary-dark)}
        .admin-tabs{
            display:flex;gap:5px;margin-bottom:25px;border-bottom:2px solid var(--border);
            background:#f8f9fa;padding:5px;border-radius:var(--radius-sm);
        }
        .admin-tab{
            padding:12px 24px;cursor:pointer;border-radius:var(--radius-sm);
            transition:var(--transition);font-weight:500;flex:1;text-align:center;
        }
        .admin-tab.active{background:var(--primary);color:#fff;box-shadow:var(--shadow)}
        .admin-content{display:none}
        .admin-content.active{display:block;animation:slideIn .3s ease}
        @keyframes slideIn{from{transform:translateX(10px);opacity:0} to{transform:translateX(0);opacity:1}}
        .form-grid{
            display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
            gap:25px;margin-bottom:25px;
        }
        .form-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:30px}
        .units-list{display:flex;flex-direction:column;gap:15px;max-height:500px;overflow-y:auto;padding:5px}
        .unit-item{
            background:var(--light);border-radius:var(--radius-sm);padding:20px;
            border-left:5px solid var(--primary);display:flex;
            justify-content:space-between;align-items:center;transition:var(--transition);
        }
        .unit-item:hover{transform:translateX(5px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
        .unit-actions{display:flex;gap:10px}
        
        /* Search & Cards Improvements */
        .search-container{
            background:#fff;border-radius:var(--radius);padding:30px;
            margin:30px 0;box-shadow:var(--shadow);width:100%;
            border:1px solid rgba(0,0,0,.05);
        }
        .search-box{display:flex;gap:12px;margin-bottom:25px;width:100%}
        .search-input{
            flex:1;padding:16px 20px;border:2px solid var(--border);
            border-radius:var(--radius-sm);font-size:1rem;transition:var(--transition);
            background:#fff;
        }
        .search-input:focus{
            border-color:var(--primary);box-shadow:0 0 0 3px rgba(44,106,160,.15);
            transform:translateY(-1px);
        }
        .search-btn{
            background:var(--primary);color:#fff;border:0;
            border-radius:var(--radius-sm);padding:0 30px;cursor:pointer;
            transition:var(--transition);font-weight:600;font-size:1rem;
        }
        .search-btn:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 4px 12px rgba(44,106,160,.3)}
        .filter-options{display:flex;gap:12px;flex-wrap:wrap;width:100%}
        .filter-btn{
            background:#fff;border:2px solid var(--border);border-radius:25px;
            padding:10px 20px;cursor:pointer;display:flex;align-items:center;
            gap:8px;transition:var(--transition);font-weight:500;font-size:0.9rem;
        }
        .filter-btn.active{
            background:var(--primary);color:#fff;border-color:var(--primary);
            transform:translateY(-2px);box-shadow:0 4px 12px rgba(44,106,160,.2);
        }
        .filter-btn:hover:not(.active){border-color:var(--primary);transform:translateY(-1px)}
        .service-filters{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px;width:100%}
        
        /* Service Toggle Buttons */
        .service-toggle-btn{
            background:#fff;border:2px solid var(--border);border-radius:25px;
            padding:12px 20px;cursor:pointer;display:flex;align-items:center;
            gap:10px;transition:var(--transition);font-size:0.9rem;color:var(--gray);
            font-weight:500;
        }
        .service-toggle-btn.active{
            background:var(--primary);color:#fff;border-color:var(--primary);
            transform:translateY(-2px);box-shadow:0 4px 12px rgba(44,106,160,.2);
        }
        .service-toggle-btn:hover:not(.active){border-color:var(--primary);transform:translateY(-1px)}
        .service-toggle-btn i{font-size:1rem}
        
        /* Tabs & Content */
        .tabs{
            display:flex;border-bottom:2px solid var(--border);margin-bottom:25px;
            flex-wrap:wrap;background:#f8f9fa;padding:5px;border-radius:var(--radius-sm);
        }
        .tab{
            padding:14px 28px;cursor:pointer;border-radius:var(--radius-sm);
            transition:var(--transition);font-weight:600;flex:1;text-align:center;
        }
        .tab.active{background:var(--primary);color:#fff;box-shadow:var(--shadow)}
        .content{display:none;width:100%}
        .content.active{display:block;animation:fadeIn .4s ease}
        .results-count{
            margin-bottom:20px;color:var(--gray);font-size:.95rem;width:100%;
            padding:12px 0;font-weight:500;
        }
        
        /* Contact Cards Improvements */
        .contact-grid{
            display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));
            gap:25px;width:100%;
        }
        .contact-card{
            background:#fff;border-radius:var(--radius);padding:25px;
            box-shadow:var(--shadow);transition:var(--transition);
            border-left:5px solid var(--primary);display:flex;flex-direction:column;
            min-height:420px;position:relative;border:1px solid rgba(0,0,0,.05);
        }
        .contact-card:hover{
            transform:translateY(-5px);box-shadow:0 12px 24px rgba(0,0,0,.15);
        }
        .favorite-btn{
            position:absolute;top:20px;right:20px;background:none;border:0;
            font-size:1.4rem;color:var(--gray);cursor:pointer;z-index:10;
            transition:var(--transition);
        }
        .favorite-btn:hover{transform:scale(1.2)}
        .favorite-btn.active{color:var(--warning)}
        .contact-header{
            display:flex;justify-content:space-between;align-items:flex-start;
            margin-bottom:20px;width:100%;
        }
        .contact-name{font-size:1.3rem;font-weight:700;color:var(--primary-dark);line-height:1.3}
        .contact-type{
            background:rgba(44,106,160,.1);color:var(--primary);padding:6px 14px;
            border-radius:20px;font-size:.85rem;font-weight:600;
        }
        .contact-info{
            display:flex;flex-direction:column;gap:14px;width:100%;flex-grow:1;
        }
        .contact-item{
            display:flex;align-items:flex-start;gap:12px;width:100%;
            padding:8px 0;
        }
        .contact-item i{width:20px;color:var(--primary);margin-top:2px;font-size:1.1rem}
        .contact-services{
            display:flex;justify-content:space-between;margin-top:20px;
            padding-top:20px;border-top:2px solid var(--border);width:100%;
        }
        .service{
            display:flex;flex-direction:column;align-items:center;text-align:center;
            transition:var(--transition);
        }
        .service i{font-size:1.4rem;margin-bottom:.4rem;transition:var(--transition)}
        .service.available{color:var(--secondary)}
        .service.available i{transform:scale(1.1)}
        .service.unavailable{color:var(--gray);opacity:.6}
        .service-label{font-size:.75rem;margin-top:.3rem;font-weight:600}
        .contact-actions{
            display:flex;gap:12px;margin-top:20px;width:100%;
        }
        .action-btn{
            flex:1;padding:12px;border:0;border-radius:var(--radius-sm);
            cursor:pointer;font-weight:600;display:flex;align-items:center;
            justify-content:center;gap:8px;transition:var(--transition);
            font-size:0.9rem;
        }
        .action-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
        .call-btn{background:var(--secondary);color:#fff}
        .whatsapp-btn{background:#25D366;color:#fff}
        .location-btn{background:transparent;border:2px solid var(--border);color:var(--gray)}
        .location-btn:hover{background:var(--border);color:var(--dark)}
        
        .no-results{
            text-align:center;padding:50px;color:var(--gray);width:100%;
            background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);
        }
        .no-results i{font-size:3rem;margin-bottom:20px;color:var(--primary);opacity:.5}
        
        /* Footer */
        .footer{
            background:var(--dark);color:#fff;text-align:center;padding:25px 0;
            position:fixed;bottom:0;left:0;width:100%;z-index:100;
            backdrop-filter:blur(10px);background:rgba(52,58,64,.95);
        }
        
        /* Dark Mode */
        body.dark-mode{
            background:#1a1d23;color:#e9ecef;
        }
        body.dark-mode .search-container,
        body.dark-mode .contact-card,
        body.dark-mode .filter-btn,
        body.dark-mode .service-toggle-btn,
        body.dark-mode .admin-panel,
        body.dark-mode .unit-item,
        body.dark-mode .login-form{
            background:#2d3239;color:#e9ecef;border-color:#3d434b;
        }
        body.dark-mode .search-input,
        body.dark-mode .filter-btn,
        body.dark-mode .service-toggle-btn,
        body.dark-mode .form-control{
            background:#343a40;border-color:#495057;color:#e9ecef;
        }
        body.dark-mode .search-input:focus,
        body.dark-mode .form-control:focus{
            border-color:var(--primary);box-shadow:0 0 0 3px rgba(44,106,160,.3);
        }
        body.dark-mode .service-toggle-btn{
            background:#343a40;border-color:#495057;color:#e9ecef;
        }
        body.dark-mode .service-toggle-btn.active{
            background:var(--primary);color:#fff;border-color:var(--primary);
        }
        body.dark-mode .service-toggle-btn:hover:not(.active){
            border-color:var(--primary);
        }
        
        /* CLASSES PARA LÓGICA CONDICIONAL */
        .hidden {
            display: none !important;
        }
        
        /* GitHub Sync Status */
        .sync-status {
            padding: 15px;
            border-radius: var(--radius-sm);
            margin: 10px 0;
            text-align: center;
        }
        .sync-success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--secondary);
            color: var(--secondary);
        }
        .sync-error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        .sync-loading {
            background: rgba(44, 106, 160, 0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        /* Enhanced Responsive Design */
        @media (max-width:1200px){
            .contact-grid{grid-template-columns:repeat(auto-fill,minmax(350px,1fr))}
            .form-grid{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
        }
        
        @media (max-width:992px){
            .contact-grid{grid-template-columns:repeat(auto-fill,minmax(320px,1fr))}
            .admin-tabs,.tabs{flex-wrap:wrap}
            .admin-tab,.tab{flex:1 1 calc(50% - 10px);min-width:140px}
        }
        
        @media (max-width:768px){
            .header-content{flex-direction:column;gap:15px;text-align:center}
            .contact-grid,.ramais-container{grid-template-columns:1fr}
            .search-box{flex-direction:column}
            .filter-options,.service-filters{justify-content:center}
            .tabs{overflow-x:auto;white-space:nowrap;flex-wrap:nowrap}
            .form-grid{grid-template-columns:1fr}
            .unit-item{flex-direction:column;align-items:flex-start;gap:15px}
            .unit-actions{width:100%;justify-content:flex-end}
            .admin-tabs,.tabs{padding:3px}
            .admin-tab,.tab{padding:10px 16px;font-size:0.9rem}
            .contact-card{min-height:380px;padding:20px}
            .contact-actions{flex-direction:column}
            .action-btn{width:100%}
            .form-actions{flex-direction:column}
            .btn{width:100%;justify-content:center}
        }
        
        @media (max-width:480px){
            .logo h1{font-size:1.5rem}
            .logo i{font-size:1.8rem}
            .tab{padding:10px 12px;font-size:.85rem}
            .service-toggle-btn{padding:10px 15px;font-size:0.8rem;gap:6px}
            .filter-btn{padding:8px 15px;font-size:0.8rem}
            .search-input{padding:14px 16px}
            .contact-grid{gap:15px}
            .container{padding:0 15px}
            .search-container,.admin-panel{padding:20px}
            .contact-card{padding:18px;min-height:360px}
            .contact-name{font-size:1.2rem}
            .contact-item{gap:10px;padding:6px 0}
            .contact-services{margin-top:15px;padding-top:15px}
        }
        
        @media (max-width:360px){
            .contact-grid{grid-template-columns:1fr}
            .admin-tab,.tab{flex:1 1 100%;min-width:100%}
            .filter-options,.service-filters{gap:8px}
            .filter-btn,.service-toggle-btn{padding:8px 12px;font-size:0.75rem}
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Selection Color */
        ::selection {
            background: rgba(44,106,160,.2);
            color: var(--primary-dark);
        }
        
        /* Update Notification */
        .update-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--warning);
            color: white;
            padding: 15px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .update-notification button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: bold;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        /* Auto Sync Button */
        .auto-sync-btn {
            position: relative;
        }
        
        .auto-sync-status {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--secondary);
            border: 2px solid white;
        }
        
        .auto-sync-status.inactive {
            background: var(--gray);
        }
        
        .auto-sync-status.syncing {
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Live Updates Indicator */
        .live-updates-indicator {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: var(--secondary);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            animation: slideInRight 0.3s ease;
        }
        
        .live-updates-indicator .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <!-- LOADING SCREEN -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <h2>Carregando dados...</h2>
        <p id="loadingStatus">Conectando ao GitHub</p>
    </div>

    <!-- LOGIN MODAL -->
    <div class="login-modal" id="loginModal" aria-hidden="true">
        <div class="login-form" role="dialog" aria-labelledby="loginTitle">
            <h2 id="loginTitle"><i class="fas fa-lock"></i> Acesso Administrativo</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">Usuário:</label>
                    <input type="text" id="loginUsername" class="form-control" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Senha:</label>
                    <input type="password" id="loginPassword" class="form-control" required autocomplete="current-password">
                </div>
                <div class="form-actions" style="justify-content:center;">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Entrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="telefonia-container" style="display:none;">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-phone-alt"></i>
                        <div>
                            <h1>Telefonia - SMS</h1>
                            <small style="font-size: 0.8rem; opacity: 0.8;">Atualizações automáticas ativas</small>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="admin-toggle" id="adminToggle" title="Painel Administrativo"><i class="fas fa-cogs"></i></button>
                        <button class="theme-toggle" id="themeToggle" title="Alternar tema"><i class="fas fa-moon"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <!-- ADMIN PANEL -->
        <div class="admin-panel" id="adminPanel" aria-hidden="true">
            <div class="container">
                <div class="admin-header">
                    <h2 class="admin-title">Painel Administrativo</h2>
                    <div>
                        <button class="btn btn-secondary" id="closeAdmin"><i class="fas fa-times"></i> Fechar</button>
                        <button class="btn btn-danger" id="logoutBtn" style="display:none;"><i class="fas fa-sign-out-alt"></i> Sair</button>
                    </div>
                </div>

                <div class="admin-tabs" role="tablist">
                    <div class="admin-tab active" data-tab="units" role="tab">Gerenciar Unidades</div>
                    <div class="admin-tab" data-tab="add" role="tab">Adicionar Unidade</div>
                    <div class="admin-tab" data-tab="github" role="tab">GitHub Sync</div>
                    <div class="admin-tab" data-tab="config" role="tab">Configurações</div>
                </div>

                <!-- UNITS -->
                <div class="admin-content active" id="units-content">
                    <h3>Unidades Cadastradas</h3>
                    <div class="units-list" id="unitsList"></div>
                </div>

                <!-- ADD / EDIT UNIT -->
                <div class="admin-content" id="add-content">
                    <h3 id="formTitle">Adicionar Nova Unidade</h3>
                    <form id="unitForm">
                        <div class="form-grid">
                            <div class="form-group"><label for="unitName">Nome da Unidade *</label><input type="text" id="unitName" class="form-control" required></div>
                            <div class="form-group"><label for="unitType">Tipo *</label>
                                <select id="unitType" class="form-control" required>
                                    <option value="">Selecione o tipo</option>
                                    <option value="promocao">Promoção</option>
                                    <option value="recuperacao">Recuperação</option>
                                    <option value="administrativo">Administrativo</option>
                                    <option value="vigilancia">Vigilância</option>
                                    <option value="capne">Capne</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="unitAddress">Endereço *</label><input type="text" id="unitAddress" class="form-control" required placeholder="Ex: Rua Exemplo, 123"><small class="form-text">O link do Google Maps será gerado automaticamente</small></div>
                            <div class="form-group"><label for="unitBairro">Bairro *</label><input type="text" id="unitBairro" class="form-control" required placeholder="Ex: Centro"></div>
                            <div class="form-group"><label for="unitPhone">Telefone *</label><input type="text" id="unitPhone" class="form-control" required placeholder="Ex: 3314-1234"><small class="form-text">O link do WhatsApp será gerado automaticamente</small></div>
                            <div class="form-group"><label for="unitEmail">E-mail</label><input type="email" id="unitEmail" class="form-control" placeholder="exemplo@pmpf.rs.gov.br"></div>
                            
                            <!-- Campo Responsável (será exibido condicionalmente) -->
                            <div class="form-group hidden" id="responsibleFieldContainer">
                                <label for="unitResponsavel">Responsável *</label>
                                <input type="text" id="unitResponsavel" class="form-control" placeholder="Nome do responsável pela unidade">
                            </div>
                            
                            <!-- CAMPOS DE SERVIÇOS - AGORA VISÍVEIS PARA PROMOÇÃO E RECUPERAÇÃO -->
                            <div class="form-group" id="vacinaField">
                                <label for="unitVacina">Sala de Vacina</label>
                                <select id="unitVacina" class="form-control">
                                    <option value="Não">Não</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>
                            <div class="form-group" id="odontoField">
                                <label for="unitOdonto">Consultório Odontológico</label>
                                <select id="unitOdonto" class="form-control">
                                    <option value="Não">Não</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>
                            <div class="form-group" id="farmaciaField">
                                <label for="unitFarmacia">Farmácia</label>
                                <select id="unitFarmacia" class="form-control">
                                    <option value="Não">Não</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>
                            
                            <!-- Campos específicos para promoção e recuperação -->
                            <div class="form-group" id="enfermeiroField">
                                <label for="unitEnfermeiro">Enfermeiro Responsável</label>
                                <input type="text" id="unitEnfermeiro" class="form-control" placeholder="Nome do enfermeiro responsável">
                            </div>
                            <div class="form-group" id="gerenteField">
                                <label for="unitGerente">Gerente Responsável</label>
                                <input type="text" id="unitGerente" class="form-control" placeholder="Nome do gerente responsável">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancelEdit" style="display:none;"><i class="fas fa-times"></i> Cancelar</button>
                            <button type="reset" class="btn btn-secondary"><i class="fas fa-eraser"></i> Limpar</button>
                            <button type="submit" class="btn btn-success" id="submitBtn"><i class="fas fa-plus"></i> Adicionar Unidade</button>
                        </div>
                    </form>
                </div>

                <!-- GITHUB SYNC -->
                <div class="admin-content" id="github-content">
                    <h3><i class="fab fa-github"></i> Sincronização com GitHub</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="githubToken">Token do GitHub *</label>
                            <input type="password" id="githubToken" class="form-control" 
                                   placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                            <small class="form-text">
                                <a href="https://github.com/settings/tokens" target="_blank">Gerar token</a> 
                                (precisa das permissões: repo)
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="repoOwner">Proprietário do Repositório</label>
                            <input type="text" id="repoOwner" class="form-control" 
                                   placeholder="seu-usuario" value="gti-sms">
                        </div>
                        <div class="form-group">
                            <label for="repoName">Nome do Repositório</label>
                            <input type="text" id="repoName" class="form-control" 
                                   placeholder="nome-repositorio" value="telefonia-sms">
                        </div>
                        <div class="form-group">
                            <label for="branchName">Branch</label>
                            <input type="text" id="branchName" class="form-control" 
                                   placeholder="main" value="main">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" id="testConnection"><i class="fas fa-plug"></i> Testar Conexão</button>
                        <button class="btn btn-success" id="saveConfig"><i class="fas fa-save"></i> Salvar Configuração</button>
                        <button class="btn btn-warning" id="forceSync"><i class="fas fa-sync"></i> Forçar Sincronização</button>
                    </div>
                    <div id="syncStatus"></div>
                </div>

                <!-- CONFIG -->
                <div class="admin-content" id="config-content">
                    <h3><i class="fas fa-cog"></i> Configurações do Sistema</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="autoSync">Sincronização Automática</label>
                            <select id="autoSync" class="form-control">
                                <option value="true">Ativada</option>
                                <option value="false">Desativada</option>
                            </select>
                            <small class="form-text">Atualiza os dados automaticamente a cada 5 minutos</small>
                        </div>
                        <div class="form-group">
                            <label for="syncInterval">Intervalo de Sincronização (minutos)</label>
                            <input type="number" id="syncInterval" class="form-control" min="1" max="60" value="5">
                        </div>
                        <div class="form-group">
                            <label for="notifyUpdates">Notificar Atualizações</label>
                            <select id="notifyUpdates" class="form-control">
                                <option value="true">Ativado</option>
                                <option value="false">Desativado</option>
                            </select>
                            <small class="form-text">Mostrar notificação quando houver atualizações</small>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" id="saveSettings"><i class="fas fa-save"></i> Salvar Configurações</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SEARCH & FILTERS -->
        <div class="container">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar por nome, bairro ou telefone...">
                    <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i> Buscar</button>
                </div>
                <div class="filter-options">
                    <button class="filter-btn active" data-filter="all"><i class="fas fa-th-large"></i> Todas</button>
                    <button class="filter-btn" data-filter="promocao"><i class="fas fa-heartbeat"></i> Promoção</button>
                    <button class="filter-btn" data-filter="recuperacao"><i class="fas fa-procedures"></i> Recuperação</button>
                    <button class="filter-btn" data-filter="administrativo"><i class="fas fa-building"></i> Administrativo</button>
                    <button class="filter-btn" data-filter="vigilancia"><i class="fas fa-shield-virus"></i> Vigilância</button>
                    <button class="filter-btn" data-filter="capne"><i class="fas fa-baby"></i> Capne</button>
                    <button class="filter-btn" data-filter="outros"><i class="fas fa-ellipsis-h"></i> Outros</button>
                </div>
                <div class="service-filters">
                    <button class="service-toggle-btn active" data-service="all"><i class="fas fa-th-large"></i> Todos os serviços</button>
                    <button class="service-toggle-btn" data-service="vacina"><i class="fas fa-syringe"></i> Sala de Vacina</button>
                    <button class="service-toggle-btn" data-service="odonto"><i class="fas fa-tooth"></i> Odontológico</button>
                    <button class="service-toggle-btn" data-service="farmacia"><i class="fas fa-pills"></i> Farmácia</button>
                </div>
            </div>

            <!-- TABS -->
            <div class="tabs" role="tablist">
                <div class="tab active" data-tab="unidades" role="tab"><i class="fas fa-map-marker-alt"></i> Unidades de Saúde</div>
                <div class="tab" data-tab="ramais" role="tab"><i class="fas fa-phone"></i> Ramais Administrativos</div>
            </div>

            <!-- RESULTS COUNT -->
            <div class="results-count" id="resultsCount"></div>

            <!-- UNIDADES DE SAÚDE -->
            <div class="content active" id="unidades-content" role="tabpanel">
                <div class="contact-grid" id="contactGrid"></div>
            </div>

            <!-- RAMAIS ADMINISTRATIVOS -->
            <div class="content" id="ramais-content" role="tabpanel">
                <div class="contact-grid" id="ramaisGrid"></div>
            </div>
        </div>

        <!-- FOOTER -->
        <div class="footer">
            <div class="container">
                <p>Secretaria Municipal de Saúde de Passo Fundo/RS - Sistema de Telefonia</p>
            </div>
        </div>

        <!-- LIVE UPDATES INDICATOR -->
        <div class="live-updates-indicator" id="liveUpdatesIndicator" style="display:none;">
            <div class="pulse-dot"></div>
            <span>Atualizações em tempo real</span>
        </div>
    </div>

    <script>
        // ====== CONFIGURAÇÕES INICIAIS ======
        const CONFIG = {
            GITHUB_TOKEN: localStorage.getItem('githubToken') || '',
            REPO_OWNER: localStorage.getItem('repoOwner') || 'gti-sms',
            REPO_NAME: localStorage.getItem('repoName') || 'telefonia-sms',
            BRANCH: localStorage.getItem('branchName') || 'main',
            AUTO_SYNC: localStorage.getItem('autoSync') !== 'false',
            SYNC_INTERVAL: parseInt(localStorage.getItem('syncInterval')) || 5,
            NOTIFY_UPDATES: localStorage.getItem('notifyUpdates') !== 'false',
            DATA_FILE: 'telefonia-data.json',
            LAST_SYNC: localStorage.getItem('lastSync') || null
        };

        // ====== ESTADO GLOBAL ======
        let state = {
            isAdmin: false,
            units: [],
            ramais: [],
            filteredUnits: [],
            filteredRamais: [],
            currentFilter: 'all',
            currentServiceFilter: 'all',
            currentTab: 'unidades',
            editId: null,
            autoSyncInterval: null,
            lastUpdateTime: null,
            isSyncing: false
        };

        // ====== INICIALIZAÇÃO ======
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Iniciando aplicação...');
            
            // Inicializar elementos da UI
            initializeUI();
            
            // Carregar dados do GitHub
            await loadDataFromGitHub();
            
            // Inicializar sincronização automática
            initializeAutoSync();
            
            // Esconder tela de carregamento
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('telefonia-container').style.display = 'block';
            }, 1000);
        });

        // ====== INICIALIZAÇÃO DA UI ======
        function initializeUI() {
            // Event listeners para abas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Event listeners para abas administrativas
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchAdminTab(tabId);
                });
            });

            // Event listeners para filtros
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    applyFilter(filter);
                });
            });

            // Event listeners para filtros de serviços
            document.querySelectorAll('.service-toggle-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const service = this.getAttribute('data-service');
                    applyServiceFilter(service);
                });
            });

            // Botão de busca
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('searchInput').addEventListener('input', performSearch);
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });

            // Botão de tema
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Botão de admin
            document.getElementById('adminToggle').addEventListener('click', toggleAdminPanel);
            document.getElementById('closeAdmin').addEventListener('click', toggleAdminPanel);

            // Formulário de login
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Formulário de unidade
            document.getElementById('unitForm').addEventListener('submit', handleUnitSubmit);
            document.getElementById('cancelEdit').addEventListener('click', cancelEdit);

            // Botões do GitHub
            document.getElementById('testConnection').addEventListener('click', testGitHubConnection);
            document.getElementById('saveConfig').addEventListener('click', saveGitHubConfig);
            document.getElementById('forceSync').addEventListener('click', forceSync);

            // Configurações
            document.getElementById('saveSettings').addEventListener('click', saveSettings);

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Configurar campos condicionais
            document.getElementById('unitType').addEventListener('change', toggleConditionalFields);

            // Carregar tema salvo
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            }

            // Carregar configurações salvas
            loadSavedSettings();
        }

        // ====== CARREGAMENTO DE DADOS ======
        async function loadDataFromGitHub() {
            const loadingStatus = document.getElementById('loadingStatus');
            
            try {
                loadingStatus.textContent = 'Conectando ao GitHub...';
                
                // Verificar se temos token configurado
                if (!CONFIG.GITHUB_TOKEN) {
                    console.warn('Token do GitHub não configurado. Usando dados locais.');
                    loadLocalData();
                    return;
                }

                loadingStatus.textContent = 'Carregando dados do GitHub...';
                
                // Tentar carregar dados do GitHub
                const data = await fetchGitHubData();
                
                if (data) {
                    console.log('Dados carregados do GitHub:', data);
                    state.units = data.units || [];
                    state.ramais = data.ramais || [];
                    state.lastUpdateTime = new Date().toISOString();
                    
                    // Salvar dados localmente como backup
                    localStorage.setItem('telefoniaData', JSON.stringify(data));
                    localStorage.setItem('lastSync', new Date().toISOString());
                    
                    // Atualizar UI
                    updateUI();
                    
                    // Mostrar indicador de atualizações em tempo real
                    showLiveUpdatesIndicator();
                    
                    loadingStatus.textContent = 'Dados carregados com sucesso!';
                } else {
                    throw new Error('Falha ao carregar dados do GitHub');
                }
            } catch (error) {
                console.error('Erro ao carregar dados do GitHub:', error);
                loadingStatus.textContent = 'Erro ao carregar dados. Usando backup local...';
                
                // Tentar carregar dados locais como fallback
                setTimeout(loadLocalData, 1000);
            }
        }

        async function fetchGitHubData() {
            try {
                const url = `https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/contents/${CONFIG.DATA_FILE}?ref=${CONFIG.BRANCH}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }

                const fileData = await response.json();
                const content = fileData.content;
                
                // Decodificar conteúdo base64
                const decodedContent = atob(content);
                
                return JSON.parse(decodedContent);
            } catch (error) {
                console.error('Erro ao buscar dados do GitHub:', error);
                return null;
            }
        }

        function loadLocalData() {
            try {
                const localData = localStorage.getItem('telefoniaData');
                if (localData) {
                    const data = JSON.parse(localData);
                    state.units = data.units || [];
                    state.ramais = data.ramais || [];
                    state.lastUpdateTime = localStorage.getItem('lastSync');
                    
                    updateUI();
                    showSyncStatus('Usando dados locais (GitHub não disponível)', 'sync-error');
                } else {
                    // Dados padrão se não houver nada
                    state.units = [];
                    state.ramais = [];
                    updateUI();
                    showSyncStatus('Nenhum dado disponível', 'sync-error');
                }
            } catch (error) {
                console.error('Erro ao carregar dados locais:', error);
                state.units = [];
                state.ramais = [];
                updateUI();
                showSyncStatus('Erro ao carregar dados', 'sync-error');
            }
        }

        // ====== SINCRONIZAÇÃO AUTOMÁTICA ======
        function initializeAutoSync() {
            if (CONFIG.AUTO_SYNC && CONFIG.GITHUB_TOKEN) {
                // Sincronizar imediatamente
                autoSync();
                
                // Configurar intervalo
                const intervalMs = CONFIG.SYNC_INTERVAL * 60 * 1000;
                state.autoSyncInterval = setInterval(autoSync, intervalMs);
                
                console.log(`Sincronização automática ativada a cada ${CONFIG.SYNC_INTERVAL} minutos`);
            } else {
                console.log('Sincronização automática desativada');
            }
        }

        async function autoSync() {
            if (state.isSyncing) return;
            
            state.isSyncing = true;
            updateAutoSyncStatus('syncing');
            
            try {
                console.log('Iniciando sincronização automática...');
                const data = await fetchGitHubData();
                
                if (data) {
                    // Verificar se houve mudanças
                    const currentData = JSON.stringify({units: state.units, ramais: state.ramais});
                    const newData = JSON.stringify(data);
                    
                    if (currentData !== newData) {
                        console.log('Dados atualizados encontrados no GitHub');
                        state.units = data.units || [];
                        state.ramais = data.ramais || [];
                        state.lastUpdateTime = new Date().toISOString();
                        
                        // Atualizar UI
                        updateUI();
                        
                        // Mostrar notificação se configurado
                        if (CONFIG.NOTIFY_UPDATES) {
                            showUpdateNotification();
                        }
                        
                        // Salvar dados localmente
                        localStorage.setItem('telefoniaData', JSON.stringify(data));
                        localStorage.setItem('lastSync', state.lastUpdateTime);
                        
                        showSyncStatus('Dados atualizados automaticamente', 'sync-success');
                    } else {
                        console.log('Nenhuma alteração encontrada no GitHub');
                        showSyncStatus('Dados já estão atualizados', 'sync-success');
                    }
                }
            } catch (error) {
                console.error('Erro na sincronização automática:', error);
                showSyncStatus('Erro na sincronização automática', 'sync-error');
            } finally {
                state.isSyncing = false;
                updateAutoSyncStatus('active');
            }
        }

        function updateAutoSyncStatus(status) {
            const indicator = document.querySelector('.auto-sync-status');
            if (indicator) {
                indicator.className = 'auto-sync-status ' + status;
            }
        }

        // ====== ATUALIZAÇÃO DA UI ======
        function updateUI() {
            applyFilter(state.currentFilter);
            updateResultsCount();
            renderUnitsList();
        }

        function applyFilter(filter) {
            state.currentFilter = filter;
            
            // Atualizar botões ativos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
            });
            
            // Aplicar filtro
            let filtered = state.units;
            
            if (filter !== 'all') {
                filtered = state.units.filter(unit => unit.type === filter);
            }
            
            // Aplicar filtro de serviços
            if (state.currentServiceFilter !== 'all') {
                filtered = filtered.filter(unit => {
                    if (state.currentServiceFilter === 'vacina') return unit.vacina === 'Sim';
                    if (state.currentServiceFilter === 'odonto') return unit.odonto === 'Sim';
                    if (state.currentServiceFilter === 'farmacia') return unit.farmacia === 'Sim';
                    return true;
                });
            }
            
            state.filteredUnits = filtered;
            renderContactGrid();
        }

        function applyServiceFilter(service) {
            state.currentServiceFilter = service;
            
            // Atualizar botões ativos
            document.querySelectorAll('.service-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-service') === service);
            });
            
            // Reaplicar filtro atual
            applyFilter(state.currentFilter);
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!query) {
                applyFilter(state.currentFilter);
                return;
            }
            
            let filtered = state.units.filter(unit => 
                unit.name.toLowerCase().includes(query) ||
                unit.bairro.toLowerCase().includes(query) ||
                unit.phone.includes(query) ||
                unit.address.toLowerCase().includes(query)
            );
            
            // Aplicar filtro de tipo atual
            if (state.currentFilter !== 'all') {
                filtered = filtered.filter(unit => unit.type === state.currentFilter);
            }
            
            // Aplicar filtro de serviços
            if (state.currentServiceFilter !== 'all') {
                filtered = filtered.filter(unit => {
                    if (state.currentServiceFilter === 'vacina') return unit.vacina === 'Sim';
                    if (state.currentServiceFilter === 'odonto') return unit.odonto === 'Sim';
                    if (state.currentServiceFilter === 'farmacia') return unit.farmacia === 'Sim';
                    return true;
                });
            }
            
            state.filteredUnits = filtered;
            renderContactGrid();
            updateResultsCount();
        }

        function renderContactGrid() {
            const grid = document.getElementById('contactGrid');
            grid.innerHTML = '';
            
            if (state.filteredUnits.length === 0) {
                grid.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>Nenhuma unidade encontrada</h3>
                        <p>Tente ajustar os filtros ou termos da busca</p>
                    </div>
                `;
                return;
            }
            
            state.filteredUnits.forEach(unit => {
                const card = createContactCard(unit);
                grid.appendChild(card);
            });
        }

        function createContactCard(unit) {
            const card = document.createElement('div');
            card.className = 'contact-card';
            card.innerHTML = `
                <button class="favorite-btn" data-id="${unit.id}">
                    <i class="far fa-star"></i>
                </button>
                <div class="contact-header">
                    <h3 class="contact-name">${unit.name}</h3>
                    <span class="contact-type">${getTypeLabel(unit.type)}</span>
                </div>
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <div>
                            <strong>Endereço:</strong><br>
                            ${unit.address}<br>
                            <small>Bairro: ${unit.bairro}</small>
                        </div>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <div>
                            <strong>Telefone:</strong><br>
                            ${formatPhone(unit.phone)}
                        </div>
                    </div>
                    ${unit.email ? `
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <div>
                            <strong>E-mail:</strong><br>
                            ${unit.email}
                        </div>
                    </div>
                    ` : ''}
                    ${unit.responsavel ? `
                    <div class="contact-item">
                        <i class="fas fa-user"></i>
                        <div>
                            <strong>Responsável:</strong><br>
                            ${unit.responsavel}
                        </div>
                    </div>
                    ` : ''}
                    ${unit.enfermeiro ? `
                    <div class="contact-item">
                        <i class="fas fa-user-nurse"></i>
                        <div>
                            <strong>Enfermeiro:</strong><br>
                            ${unit.enfermeiro}
                        </div>
                    </div>
                    ` : ''}
                    ${unit.gerente ? `
                    <div class="contact-item">
                        <i class="fas fa-user-tie"></i>
                        <div>
                            <strong>Gerente:</strong><br>
                            ${unit.gerente}
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="contact-services">
                    <div class="service ${unit.vacina === 'Sim' ? 'available' : 'unavailable'}">
                        <i class="fas fa-syringe"></i>
                        <div class="service-label">Vacina</div>
                    </div>
                    <div class="service ${unit.odonto === 'Sim' ? 'available' : 'unavailable'}">
                        <i class="fas fa-tooth"></i>
                        <div class="service-label">Odonto</div>
                    </div>
                    <div class="service ${unit.farmacia === 'Sim' ? 'available' : 'unavailable'}">
                        <i class="fas fa-pills"></i>
                        <div class="service-label">Farmácia</div>
                    </div>
                </div>
                <div class="contact-actions">
                    <button class="action-btn call-btn" onclick="callNumber('${unit.phone}')">
                        <i class="fas fa-phone"></i> Ligar
                    </button>
                    <button class="action-btn whatsapp-btn" onclick="openWhatsApp('${unit.phone}')">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button class="action-btn location-btn" onclick="openLocation('${unit.address}')">
                        <i class="fas fa-map-marker-alt"></i> Localização
                    </button>
                </div>
            `;
            
            // Configurar favorito
            const favoriteBtn = card.querySelector('.favorite-btn');
            const isFavorite = localStorage.getItem(`favorite_${unit.id}`) === 'true';
            if (isFavorite) {
                favoriteBtn.querySelector('i').className = 'fas fa-star';
                favoriteBtn.classList.add('active');
            }
            
            favoriteBtn.addEventListener('click', function() {
                toggleFavorite(unit.id, this);
            });
            
            return card;
        }

        function updateResultsCount() {
            const count = state.filteredUnits.length;
            const total = state.units.length;
            const countElement = document.getElementById('resultsCount');
            
            let filterText = '';
            if (state.currentFilter !== 'all') {
                filterText = ` do tipo ${getTypeLabel(state.currentFilter)}`;
            }
            
            if (state.currentServiceFilter !== 'all') {
                const serviceLabel = getServiceLabel(state.currentServiceFilter);
                filterText += filterText ? ` com ${serviceLabel}` : ` com ${serviceLabel}`;
            }
            
            countElement.textContent = `${count} de ${total} unidades${filterText} encontradas`;
            
            if (state.lastUpdateTime) {
                const updateTime = new Date(state.lastUpdateTime).toLocaleString('pt-BR');
                countElement.innerHTML += ` <small style="opacity:0.7;">(Atualizado: ${updateTime})</small>`;
            }
        }

        // ====== FUNÇÕES UTILITÁRIAS ======
        function getTypeLabel(type) {
            const labels = {
                'promocao': 'Promoção',
                'recuperacao': 'Recuperação',
                'administrativo': 'Administrativo',
                'vigilancia': 'Vigilância',
                'capne': 'Capne',
                'outros': 'Outros'
            };
            return labels[type] || type;
        }

        function getServiceLabel(service) {
            const labels = {
                'vacina': 'Sala de Vacina',
                'odonto': 'Consultório Odontológico',
                'farmacia': 'Farmácia'
            };
            return labels[service] || service;
        }

        function formatPhone(phone) {
            // Remove caracteres não numéricos
            const cleaned = phone.replace(/\D/g, '');
            
            // Formatação para números brasileiros
            if (cleaned.length === 10) {
                return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            } else if (cleaned.length === 11) {
                return cleaned.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
            
            return phone;
        }

        function callNumber(phone) {
            const cleaned = phone.replace(/\D/g, '');
            window.open(`tel:${cleaned}`);
        }

        function openWhatsApp(phone) {
            const cleaned = phone.replace(/\D/g, '');
            const message = 'Olá, gostaria de obter mais informações.';
            window.open(`https://wa.me/55${cleaned}?text=${encodeURIComponent(message)}`, '_blank');
        }

        function openLocation(address) {
            const encodedAddress = encodeURIComponent(address + ', Passo Fundo, RS');
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodedAddress}`, '_blank');
        }

        function toggleFavorite(id, button) {
            const isFavorite = localStorage.getItem(`favorite_${id}`) === 'true';
            const newFavoriteState = !isFavorite;
            
            localStorage.setItem(`favorite_${id}`, newFavoriteState.toString());
            
            const icon = button.querySelector('i');
            if (newFavoriteState) {
                icon.className = 'fas fa-star';
                button.classList.add('active');
            } else {
                icon.className = 'far fa-star';
                button.classList.remove('active');
            }
        }

        function switchTab(tabId) {
            state.currentTab = tabId;
            
            // Atualizar abas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId);
            });
            
            // Atualizar conteúdo
            document.querySelectorAll('.content').forEach(content => {
                content.classList.toggle('active', content.id === `${tabId}-content`);
            });
            
            // Atualizar contagem de resultados
            updateResultsCount();
        }

        function switchAdminTab(tabId) {
            // Atualizar abas
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId);
            });
            
            // Atualizar conteúdo
            document.querySelectorAll('.admin-content').forEach(content => {
                content.classList.toggle('active', content.id === `${tabId}-content`);
            });
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark.toString());
            
            const icon = document.querySelector('#themeToggle i');
            icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }

        // ====== FUNÇÕES ADMINISTRATIVAS ======
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            const isVisible = panel.classList.contains('active');
            
            if (!isVisible && !state.isAdmin) {
                // Mostrar modal de login se não estiver logado
                document.getElementById('loginModal').classList.add('active');
            } else {
                panel.classList.toggle('active');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            // Verificação simples (em produção, usar autenticação segura)
            if (username === 'admin' && password === 'sms2024') {
                state.isAdmin = true;
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('adminPanel').classList.add('active');
                document.getElementById('logoutBtn').style.display = 'block';
                
                // Carregar lista de unidades
                renderUnitsList();
            } else {
                alert('Credenciais inválidas!');
            }
        }

        function handleLogout() {
            state.isAdmin = false;
            document.getElementById('adminPanel').classList.remove('active');
            document.getElementById('logoutBtn').style.display = 'none';
            cancelEdit();
        }

        function renderUnitsList() {
            const list = document.getElementById('unitsList');
            list.innerHTML = '';
            
            state.units.forEach(unit => {
                const item = document.createElement('div');
                item.className = 'unit-item';
                item.innerHTML = `
                    <div>
                        <h4>${unit.name}</h4>
                        <p><strong>Tipo:</strong> ${getTypeLabel(unit.type)} | <strong>Bairro:</strong> ${unit.bairro} | <strong>Telefone:</strong> ${unit.phone}</p>
                    </div>
                    <div class="unit-actions">
                        <button class="btn btn-primary edit-unit" data-id="${unit.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger delete-unit" data-id="${unit.id}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                
                list.appendChild(item);
            });
            
            // Adicionar event listeners para editar/excluir
            document.querySelectorAll('.edit-unit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    editUnit(id);
                });
            });
            
            document.querySelectorAll('.delete-unit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    deleteUnit(id);
                });
            });
        }

        function toggleConditionalFields() {
            const type = document.getElementById('unitType').value;
            const responsibleField = document.getElementById('responsibleFieldContainer');
            const vacinaField = document.getElementById('vacinaField');
            const odontoField = document.getElementById('odontoField');
            const farmaciaField = document.getElementById('farmaciaField');
            const enfermeiroField = document.getElementById('enfermeiroField');
            const gerenteField = document.getElementById('gerenteField');
            
            // Mostrar campos de serviços apenas para promoção e recuperação
            const showServices = type === 'promocao' || type === 'recuperacao';
            
            vacinaField.classList.toggle('hidden', !showServices);
            odontoField.classList.toggle('hidden', !showServices);
            farmaciaField.classList.toggle('hidden', !showServices);
            enfermeiroField.classList.toggle('hidden', !showServices);
            gerenteField.classList.toggle('hidden', !showServices);
            
            // Mostrar campo responsável apenas para administrativo, vigilância, capne e outros
            const showResponsible = type === 'administrativo' || type === 'vigilancia' || type === 'capne' || type === 'outros';
            responsibleField.classList.toggle('hidden', !showResponsible);
            
            // Tornar obrigatório ou não baseado na visibilidade
            document.getElementById('unitResponsavel').required = showResponsible;
            document.getElementById('unitVacina').required = showServices;
            document.getElementById('unitOdonto').required = showServices;
            document.getElementById('unitFarmacia').required = showServices;
        }

        async function handleUnitSubmit(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('unitName').value,
                type: document.getElementById('unitType').value,
                address: document.getElementById('unitAddress').value,
                bairro: document.getElementById('unitBairro').value,
                phone: document.getElementById('unitPhone').value,
                email: document.getElementById('unitEmail').value,
                responsavel: document.getElementById('unitResponsavel').value,
                vacina: document.getElementById('unitVacina').value,
                odonto: document.getElementById('unitOdonto').value,
                farmacia: document.getElementById('unitFarmacia').value,
                enfermeiro: document.getElementById('unitEnfermeiro').value,
                gerente: document.getElementById('unitGerente').value
            };
            
            // Validação básica
            if (!formData.name || !formData.type || !formData.address || !formData.bairro || !formData.phone) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            try {
                if (state.editId) {
                    // Editar unidade existente
                    await updateUnit(state.editId, formData);
                } else {
                    // Adicionar nova unidade
                    await addUnit(formData);
                }
                
                // Limpar formulário
                document.getElementById('unitForm').reset();
                cancelEdit();
                
                // Recarregar dados do GitHub para garantir sincronização
                await loadDataFromGitHub();
                
                alert('Unidade salva com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar unidade:', error);
                alert('Erro ao salvar unidade. Verifique o console para mais detalhes.');
            }
        }

        async function addUnit(unitData) {
            // Gerar ID único
            unitData.id = 'unit_' + Date.now();
            
            // Adicionar à lista local
            state.units.push(unitData);
            
            // Salvar no GitHub
            await saveDataToGitHub();
        }

        async function updateUnit(id, unitData) {
            // Atualizar na lista local
            const index = state.units.findIndex(unit => unit.id === id);
            if (index !== -1) {
                unitData.id = id; // Manter o ID original
                state.units[index] = unitData;
                
                // Salvar no GitHub
                await saveDataToGitHub();
            }
        }

        async function deleteUnit(id) {
            if (!confirm('Tem certeza que deseja excluir esta unidade?')) {
                return;
            }
            
            // Remover da lista local
            state.units = state.units.filter(unit => unit.id !== id);
            
            // Salvar no GitHub
            await saveDataToGitHub();
            
            // Recarregar UI
            updateUI();
            renderUnitsList();
        }

        function editUnit(id) {
            const unit = state.units.find(u => u.id === id);
            if (!unit) return;
            
            // Preencher formulário
            document.getElementById('unitName').value = unit.name;
            document.getElementById('unitType').value = unit.type;
            document.getElementById('unitAddress').value = unit.address;
            document.getElementById('unitBairro').value = unit.bairro;
            document.getElementById('unitPhone').value = unit.phone;
            document.getElementById('unitEmail').value = unit.email || '';
            document.getElementById('unitResponsavel').value = unit.responsavel || '';
            document.getElementById('unitVacina').value = unit.vacina || 'Não';
            document.getElementById('unitOdonto').value = unit.odonto || 'Não';
            document.getElementById('unitFarmacia').value = unit.farmacia || 'Não';
            document.getElementById('unitEnfermeiro').value = unit.enfermeiro || '';
            document.getElementById('unitGerente').value = unit.gerente || '';
            
            // Atualizar campos condicionais
            toggleConditionalFields();
            
            // Configurar modo de edição
            state.editId = id;
            document.getElementById('formTitle').textContent = 'Editar Unidade';
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save"></i> Atualizar Unidade';
            document.getElementById('cancelEdit').style.display = 'block';
            
            // Mudar para a aba de adicionar/editar
            switchAdminTab('add');
        }

        function cancelEdit() {
            state.editId = null;
            document.getElementById('formTitle').textContent = 'Adicionar Nova Unidade';
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-plus"></i> Adicionar Unidade';
            document.getElementById('cancelEdit').style.display = 'none';
            document.getElementById('unitForm').reset();
        }

        // ====== GITHUB SYNC FUNCTIONS ======
        async function saveDataToGitHub() {
            if (!CONFIG.GITHUB_TOKEN) {
                alert('Token do GitHub não configurado. Configure na aba GitHub Sync.');
                return false;
            }
            
            try {
                // Preparar dados
                const data = {
                    units: state.units,
                    ramais: state.ramais,
                    lastUpdated: new Date().toISOString()
                };
                
                // Verificar se o arquivo já existe
                const fileInfo = await getGitHubFileInfo();
                
                // Criar payload para a API do GitHub
                const payload = {
                    message: `Atualização de dados: ${new Date().toLocaleString('pt-BR')}`,
                    content: btoa(JSON.stringify(data, null, 2)),
                    branch: CONFIG.BRANCH
                };
                
                // Se o arquivo já existe, precisamos do SHA para atualizar
                if (fileInfo) {
                    payload.sha = fileInfo.sha;
                }
                
                // Fazer upload para o GitHub
                const url = `https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/contents/${CONFIG.DATA_FILE}`;
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                console.log('Dados salvos no GitHub com sucesso');
                showSyncStatus('Dados salvos no GitHub com sucesso', 'sync-success');
                
                // Atualizar timestamp
                state.lastUpdateTime = new Date().toISOString();
                localStorage.setItem('lastSync', state.lastUpdateTime);
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar dados no GitHub:', error);
                showSyncStatus('Erro ao salvar dados no GitHub', 'sync-error');
                return false;
            }
        }

        async function getGitHubFileInfo() {
            try {
                const url = `https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/contents/${CONFIG.DATA_FILE}?ref=${CONFIG.BRANCH}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.status === 404) {
                    return null; // Arquivo não existe
                }
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Erro ao obter informações do arquivo:', error);
                return null;
            }
        }

        async function testGitHubConnection() {
            const statusElement = document.getElementById('syncStatus');
            statusElement.innerHTML = '<div class="sync-status sync-loading"><i class="fas fa-spinner loading"></i> Testando conexão...</div>';
            
            try {
                const data = await fetchGitHubData();
                
                if (data) {
                    statusElement.innerHTML = '<div class="sync-status sync-success"><i class="fas fa-check"></i> Conexão com GitHub estabelecida com sucesso!</div>';
                } else {
                    throw new Error('Não foi possível carregar dados');
                }
            } catch (error) {
                statusElement.innerHTML = `<div class="sync-status sync-error"><i class="fas fa-times"></i> Erro na conexão: ${error.message}</div>`;
            }
        }

        function saveGitHubConfig() {
            const token = document.getElementById('githubToken').value;
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const branch = document.getElementById('branchName').value;
            
            if (!token) {
                alert('Por favor, insira um token do GitHub válido.');
                return;
            }
            
            // Atualizar configurações
            CONFIG.GITHUB_TOKEN = token;
            CONFIG.REPO_OWNER = owner;
            CONFIG.REPO_NAME = repo;
            CONFIG.BRANCH = branch;
            
            // Salvar no localStorage
            localStorage.setItem('githubToken', token);
            localStorage.setItem('repoOwner', owner);
            localStorage.setItem('repoName', repo);
            localStorage.setItem('branchName', branch);
            
            // Reiniciar sincronização automática
            if (state.autoSyncInterval) {
                clearInterval(state.autoSyncInterval);
            }
            initializeAutoSync();
            
            alert('Configurações do GitHub salvas com sucesso!');
        }

        async function forceSync() {
            await loadDataFromGitHub();
        }

        function showSyncStatus(message, type) {
            const statusElement = document.getElementById('syncStatus');
            statusElement.innerHTML = `<div class="sync-status ${type}">${message}</div>`;
            
            // Auto-remover após 5 segundos
            setTimeout(() => {
                if (statusElement.innerHTML.includes(message)) {
                    statusElement.innerHTML = '';
                }
            }, 5000);
        }

        // ====== CONFIGURAÇÕES ======
        function loadSavedSettings() {
            document.getElementById('githubToken').value = CONFIG.GITHUB_TOKEN;
            document.getElementById('repoOwner').value = CONFIG.REPO_OWNER;
            document.getElementById('repoName').value = CONFIG.REPO_NAME;
            document.getElementById('branchName').value = CONFIG.BRANCH;
            document.getElementById('autoSync').value = CONFIG.AUTO_SYNC.toString();
            document.getElementById('syncInterval').value = CONFIG.SYNC_INTERVAL;
            document.getElementById('notifyUpdates').value = CONFIG.NOTIFY_UPDATES.toString();
        }

        function saveSettings() {
            const autoSync = document.getElementById('autoSync').value === 'true';
            const syncInterval = parseInt(document.getElementById('syncInterval').value);
            const notifyUpdates = document.getElementById('notifyUpdates').value === 'true';
            
            // Atualizar configurações
            CONFIG.AUTO_SYNC = autoSync;
            CONFIG.SYNC_INTERVAL = syncInterval;
            CONFIG.NOTIFY_UPDATES = notifyUpdates;
            
            // Salvar no localStorage
            localStorage.setItem('autoSync', autoSync.toString());
            localStorage.setItem('syncInterval', syncInterval.toString());
            localStorage.setItem('notifyUpdates', notifyUpdates.toString());
            
            // Reiniciar sincronização automática se necessário
            if (state.autoSyncInterval) {
                clearInterval(state.autoSyncInterval);
            }
            
            if (autoSync && CONFIG.GITHUB_TOKEN) {
                initializeAutoSync();
            }
            
            alert('Configurações salvas com sucesso!');
        }

        // ====== NOTIFICAÇÕES ======
        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.className = 'update-notification';
            notification.innerHTML = `
                <i class="fas fa-sync"></i>
                <span>Dados atualizados! A página foi atualizada automaticamente.</span>
                <button onclick="this.parentElement.remove()">OK</button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remover após 10 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }

        function showLiveUpdatesIndicator() {
            const indicator = document.getElementById('liveUpdatesIndicator');
            indicator.style.display = 'flex';
            
            // Esconder após alguns segundos
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
