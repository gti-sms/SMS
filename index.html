<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: 'unsafe-inline' 'unsafe-eval' blob:">
    <title>Telefonia - Secretaria Municipal de Sa√∫de PMPF</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ====== VARS & RESET ====== */
        :root{
            --primary:#2c6aa0;--primary-dark:#1e4a73;--secondary:#4caf50;
            --danger:#e74c3c;--warning:#f39c12;--light:#f8f9fa;
            --dark:#343a40;--gray:#6c757d;--border:#dee2e6;
            --shadow:0 4px 12px rgba(0,0,0,.1);--transition:all .3s ease;
            --radius:12px;--radius-sm:8px;
        }
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Arial,sans-serif}
        html,body{width:100%;height:100%;background:#f5f7fa;color:var(--dark);line-height:1.6;overflow-x:hidden}
        
        /* Container & Layout */
        .container{max-width:1400px;margin:0 auto;padding:0 20px;width:100%}
        
        /* Header Improvements */
        header{
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            color:#fff;padding:15px 0;box-shadow:var(--shadow);
            position:sticky;top:0;z-index:1000;backdrop-filter:blur(10px);
        }
        .header-content{display:flex;justify-content:space-between;align-items:center;width:100%}
        .logo{display:flex;align-items:center;gap:15px}
        .logo i{font-size:2.2rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
        .logo h1{font-size:1.8rem;font-weight:700;letter-spacing:-0.5px}
        .header-actions{display:flex;gap:12px;align-items:center}
        .theme-toggle,.admin-toggle{
            background:rgba(255,255,255,.25);border:0;color:#fff;
            width:44px;height:44px;border-radius:50%;cursor:pointer;
            display:flex;align-items:center;justify-content:center;
            transition:var(--transition);backdrop-filter:blur(10px);
        }
        .theme-toggle:hover,.admin-toggle:hover{
            background:rgba(255,255,255,.4);transform:scale(1.05);
        }
        
        /* Modal Improvements */
        .login-modal{
            display:none;position:fixed;inset:0;
            background:rgba(0,0,0,.6);z-index:2000;
            align-items:center;justify-content:center;backdrop-filter:blur(5px);
        }
        .login-modal.active{display:flex}
        .login-form{
            background:#fff;padding:35px;border-radius:var(--radius);
            box-shadow:0 20px 40px rgba(0,0,0,.3);width:100%;
            max-width:420px;transform:translateY(-20px);animation:slideUp .3s ease forwards;
        }
        @keyframes slideUp{to{transform:translateY(0)}}
        .login-form h2{margin-bottom:25px;color:var(--primary-dark);text-align:center;font-weight:600}
        
        /* Form Improvements */
        .form-group{margin-bottom:20px}
        .form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark)}
        .form-control{
            width:100%;padding:12px 16px;border:2px solid var(--border);
            border-radius:var(--radius-sm);font-size:1rem;transition:var(--transition);
            background:#fff;
        }
        .form-control:focus{
            outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(44,106,160,.15);
            transform:translateY(-1px);
        }
        .btn{
            padding:12px 24px;border:0;border-radius:var(--radius-sm);cursor:pointer;
            font-weight:600;transition:var(--transition);display:flex;
            align-items:center;gap:10px;font-size:0.95rem;
        }
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 4px 12px rgba(44,106,160,.3)}
        .btn-secondary{background:var(--gray);color:#fff}
        .btn-success{background:var(--secondary);color:#fff}
        .btn-success:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(76,175,80,.3)}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-warning{background:var(--warning);color:#fff}
        
        /* Admin Panel Improvements */
        .admin-panel{
            display:none;background:#fff;border-radius:var(--radius);
            padding:30px;margin:30px 0;box-shadow:var(--shadow);width:100%;
            border:1px solid rgba(0,0,0,.05);
        }
        .admin-panel.active{display:block;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0} to{opacity:1}}
        .admin-header{
            display:flex;justify-content:space-between;align-items:center;
            margin-bottom:25px;padding-bottom:20px;
            border-bottom:3px solid var(--primary);
        }
        .admin-title{font-size:1.6rem;font-weight:700;color:var(--primary-dark)}
        .admin-tabs{
            display:flex;gap:5px;margin-bottom:25px;border-bottom:2px solid var(--border);
            background:#f8f9fa;padding:5px;border-radius:var(--radius-sm);
        }
        .admin-tab{
            padding:12px 24px;cursor:pointer;border-radius:var(--radius-sm);
            transition:var(--transition);font-weight:500;flex:1;text-align:center;
        }
        .admin-tab.active{background:var(--primary);color:#fff;box-shadow:var(--shadow)}
        .admin-content{display:none}
        .admin-content.active{display:block;animation:slideIn .3s ease}
        @keyframes slideIn{from{transform:translateX(10px);opacity:0} to{transform:translateX(0);opacity:1}}
        .form-grid{
            display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
            gap:25px;margin-bottom:25px;
        }
        .form-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:30px}
        .units-list{display:flex;flex-direction:column;gap:15px;max-height:500px;overflow-y:auto;padding:5px}
        .unit-item{
            background:var(--light);border-radius:var(--radius-sm);padding:20px;
            border-left:5px solid var(--primary);display:flex;
            justify-content:space-between;align-items:center;transition:var(--transition);
        }
        .unit-item:hover{transform:translateX(5px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
        .unit-actions{display:flex;gap:10px}
        
        /* Search & Cards Improvements */
        .search-container{
            background:#fff;border-radius:var(--radius);padding:30px;
            margin:30px 0;box-shadow:var(--shadow);width:100%;
            border:1px solid rgba(0,0,0,.05);
        }
        .search-box{display:flex;gap:12px;margin-bottom:25px;width:100%}
        .search-input{
            flex:1;padding:16px 20px;border:2px solid var(--border);
            border-radius:var(--radius-sm);font-size:1rem;transition:var(--transition);
            background:#fff;
        }
        .search-input:focus{
            border-color:var(--primary);box-shadow:0 0 0 3px rgba(44,106,160,.15);
            transform:translateY(-1px);
        }
        .search-btn{
            background:var(--primary);color:#fff;border:0;
            border-radius:var(--radius-sm);padding:0 30px;cursor:pointer;
            transition:var(--transition);font-weight:600;font-size:1rem;
        }
        .search-btn:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 4px 12px rgba(44,106,160,.3)}
        .filter-options{display:flex;gap:12px;flex-wrap:wrap;width:100%}
        .filter-btn{
            background:#fff;border:2px solid var(--border);border-radius:25px;
            padding:10px 20px;cursor:pointer;display:flex;align-items:center;
            gap:8px;transition:var(--transition);font-weight:500;font-size:0.9rem;
        }
        .filter-btn.active{
            background:var(--primary);color:#fff;border-color:var(--primary);
            transform:translateY(-2px);box-shadow:0 4px 12px rgba(44,106,160,.2);
        }
        .filter-btn:hover:not(.active){border-color:var(--primary);transform:translateY(-1px)}
        .service-filters{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px;width:100%}
        
        /* Service Toggle Buttons */
        .service-toggle-btn{
            background:#fff;border:2px solid var(--border);border-radius:25px;
            padding:12px 20px;cursor:pointer;display:flex;align-items:center;
            gap:10px;transition:var(--transition);font-size:0.9rem;color:var(--gray);
            font-weight:500;
        }
        .service-toggle-btn.active{
            background:var(--primary);color:#fff;border-color:var(--primary);
            transform:translateY(-2px);box-shadow:0 4px 12px rgba(44,106,160,.2);
        }
        .service-toggle-btn:hover:not(.active){border-color:var(--primary);transform:translateY(-1px)}
        .service-toggle-btn i{font-size:1rem}
        
        /* Tabs & Content */
        .tabs{
            display:flex;border-bottom:2px solid var(--border);margin-bottom:25px;
            flex-wrap:wrap;background:#f8f9fa;padding:5px;border-radius:var(--radius-sm);
        }
        .tab{
            padding:14px 28px;cursor:pointer;border-radius:var(--radius-sm);
            transition:var(--transition);font-weight:600;flex:1;text-align:center;
        }
        .tab.active{background:var(--primary);color:#fff;box-shadow:var(--shadow)}
        .content{display:none;width:100%}
        .content.active{display:block;animation:fadeIn .4s ease}
        .results-count{
            margin-bottom:20px;color:var(--gray);font-size:.95rem;width:100%;
            padding:12px 0;font-weight:500;
        }
        
        /* Contact Cards Improvements */
        .contact-grid{
            display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));
            gap:25px;width:100%;
        }
        .contact-card{
            background:#fff;border-radius:var(--radius);padding:25px;
            box-shadow:var(--shadow);transition:var(--transition);
            border-left:5px solid var(--primary);display:flex;flex-direction:column;
            min-height:420px;position:relative;border:1px solid rgba(0,0,0,.05);
        }
        .contact-card:hover{
            transform:translateY(-5px);box-shadow:0 12px 24px rgba(0,0,0,.15);
        }
        .favorite-btn{
            position:absolute;top:20px;right:20px;background:none;border:0;
            font-size:1.4rem;color:var(--gray);cursor:pointer;z-index:10;
            transition:var(--transition);
        }
        .favorite-btn:hover{transform:scale(1.2)}
        .favorite-btn.active{color:var(--warning)}
        .contact-header{
            display:flex;justify-content:space-between;align-items:flex-start;
            margin-bottom:20px;width:100%;
        }
        .contact-name{font-size:1.3rem;font-weight:700;color:var(--primary-dark);line-height:1.3}
        .contact-type{
            background:rgba(44,106,160,.1);color:var(--primary);padding:6px 14px;
            border-radius:20px;font-size:.85rem;font-weight:600;
        }
        .contact-info{
            display:flex;flex-direction:column;gap:14px;width:100%;flex-grow:1;
        }
        .contact-item{
            display:flex;align-items:flex-start;gap:12px;width:100%;
            padding:8px 0;
        }
        .contact-item i{width:20px;color:var(--primary);margin-top:2px;font-size:1.1rem}
        .contact-services{
            display:flex;justify-content:space-between;margin-top:20px;
            padding-top:20px;border-top:2px solid var(--border);width:100%;
        }
        .service{
            display:flex;flex-direction:column;align-items:center;text-align:center;
            transition:var(--transition);
        }
        .service i{font-size:1.4rem;margin-bottom:.4rem;transition:var(--transition)}
        .service.available{color:var(--secondary)}
        .service.available i{transform:scale(1.1)}
        .service.unavailable{color:var(--gray);opacity:.6}
        .service-label{font-size:.75rem;margin-top:.3rem;font-weight:600}
        .contact-actions{
            display:flex;gap:12px;margin-top:20px;width:100%;
        }
        .action-btn{
            flex:1;padding:12px;border:0;border-radius:var(--radius-sm);
            cursor:pointer;font-weight:600;display:flex;align-items:center;
            justify-content:center;gap:8px;transition:var(--transition);
            font-size:0.9rem;
        }
        .action-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
        .call-btn{background:var(--secondary);color:#fff}
        .whatsapp-btn{background:#25D366;color:#fff}
        .location-btn{background:transparent;border:2px solid var(--border);color:var(--gray)}
        .location-btn:hover{background:var(--border);color:var(--dark)}
        
        .no-results{
            text-align:center;padding:50px;color:var(--gray);width:100%;
            background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);
        }
        .no-results i{font-size:3rem;margin-bottom:20px;color:var(--primary);opacity:.5}
        
        /* Footer */
        .footer{
            background:var(--dark);color:#fff;text-align:center;padding:25px 0;
            position:fixed;bottom:0;left:0;width:100%;z-index:100;
            backdrop-filter:blur(10px);background:rgba(52,58,64,.95);
        }
        
        /* Dark Mode */
        body.dark-mode{
            background:#1a1d23;color:#e9ecef;
        }
        body.dark-mode .search-container,
        body.dark-mode .contact-card,
        body.dark-mode .filter-btn,
        body.dark-mode .service-toggle-btn,
        body.dark-mode .admin-panel,
        body.dark-mode .unit-item,
        body.dark-mode .login-form{
            background:#2d3239;color:#e9ecef;border-color:#3d434b;
        }
        body.dark-mode .search-input,
        body.dark-mode .filter-btn,
        body.dark-mode .service-toggle-btn,
        body.dark-mode .form-control{
            background:#343a40;border-color:#495057;color:#e9ecef;
        }
        body.dark-mode .search-input:focus,
        body.dark-mode .form-control:focus{
            border-color:var(--primary);box-shadow:0 0 0 3px rgba(44,106,160,.3);
        }
        body.dark-mode .service-toggle-btn{
            background:#343a40;border-color:#495057;color:#e9ecef;
        }
        body.dark-mode .service-toggle-btn.active{
            background:var(--primary);color:#fff;border-color:var(--primary);
        }
        body.dark-mode .service-toggle-btn:hover:not(.active){
            border-color:var(--primary);
        }
        
        /* CLASSES PARA L√ìGICA CONDICIONAL */
        .hidden {
            display: none !important;
        }
        
        /* GitHub Sync Status */
        .sync-status {
            padding: 15px;
            border-radius: var(--radius-sm);
            margin: 10px 0;
            text-align: center;
        }
        .sync-success {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid var(--secondary);
            color: var(--secondary);
        }
        .sync-error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        .sync-loading {
            background: rgba(44, 106, 160, 0.1);
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        /* Enhanced Responsive Design */
        @media (max-width:1200px){
            .contact-grid{grid-template-columns:repeat(auto-fill,minmax(350px,1fr))}
            .form-grid{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
        }
        
        @media (max-width:992px){
            .contact-grid{grid-template-columns:repeat(auto-fill,minmax(320px,1fr))}
            .admin-tabs,.tabs{flex-wrap:wrap}
            .admin-tab,.tab{flex:1 1 calc(50% - 10px);min-width:140px}
        }
        
        @media (max-width:768px){
            .header-content{flex-direction:column;gap:15px;text-align:center}
            .contact-grid,.ramais-container{grid-template-columns:1fr}
            .search-box{flex-direction:column}
            .filter-options,.service-filters{justify-content:center}
            .tabs{overflow-x:auto;white-space:nowrap;flex-wrap:nowrap}
            .form-grid{grid-template-columns:1fr}
            .unit-item{flex-direction:column;align-items:flex-start;gap:15px}
            .unit-actions{width:100%;justify-content:flex-end}
            .admin-tabs,.tabs{padding:3px}
            .admin-tab,.tab{padding:10px 16px;font-size:0.9rem}
            .contact-card{min-height:380px;padding:20px}
            .contact-actions{flex-direction:column}
            .action-btn{width:100%}
            .form-actions{flex-direction:column}
            .btn{width:100%;justify-content:center}
        }
        
        @media (max-width:480px){
            .logo h1{font-size:1.5rem}
            .logo i{font-size:1.8rem}
            .tab{padding:10px 12px;font-size:.85rem}
            .service-toggle-btn{padding:10px 15px;font-size:0.8rem;gap:6px}
            .filter-btn{padding:8px 15px;font-size:0.8rem}
            .search-input{padding:14px 16px}
            .contact-grid{gap:15px}
            .container{padding:0 15px}
            .search-container,.admin-panel{padding:20px}
            .contact-card{padding:18px;min-height:360px}
            .contact-name{font-size:1.2rem}
            .contact-item{gap:10px;padding:6px 0}
            .contact-services{margin-top:15px;padding-top:15px}
        }
        
        @media (max-width:360px){
            .contact-grid{grid-template-columns:1fr}
            .admin-tab,.tab{flex:1 1 100%;min-width:100%}
            .filter-options,.service-filters{gap:8px}
            .filter-btn,.service-toggle-btn{padding:8px 12px;font-size:0.75rem}
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Selection Color */
        ::selection {
            background: rgba(44,106,160,.2);
            color: var(--primary-dark);
        }
        
        /* Update Notification */
        .update-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--warning);
            color: white;
            padding: 15px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .update-notification button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: bold;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        /* Auto Sync Button */
        .auto-sync-btn {
            position: relative;
        }
        
        .auto-sync-status {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--secondary);
            border: 2px solid white;
        }
        
        .auto-sync-status.inactive {
            background: var(--gray);
        }
        
        .auto-sync-status.syncing {
            background: var(--warning);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Live Updates Indicator */
        .live-updates-indicator {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: var(--secondary);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: var(--shadow);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            animation: slideInRight 0.3s ease;
        }
        
        .live-updates-indicator .pulse-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <h2>Carregando dados...</h2>
        <p id="loadingStatus">Conectando ao GitHub</p>
    </div>

    <div class="login-modal" id="loginModal" aria-hidden="true">
        <div class="login-form" role="dialog" aria-labelledby="loginTitle">
            <h2 id="loginTitle"><i class="fas fa-lock"></i> Acesso Administrativo</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">Usu√°rio:</label>
                    <input type="text" id="loginUsername" class="form-control" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Senha:</label>
                    <input type="password" id="loginPassword" class="form-control" required autocomplete="current-password">
                </div>
                <div class="form-actions" style="justify-content:center;">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Entrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="telefonia-container" style="display:none;">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-phone-alt"></i>
                        <div>
                            <h1>Telefonia - SMS</h1>
                            <small style="font-size: 0.8rem; opacity: 0.8;">Atualiza√ß√µes autom√°ticas ativas</small>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="admin-toggle" id="adminToggle" title="Painel Administrativo"><i class="fas fa-cogs"></i></button>
                        <button class="theme-toggle" id="themeToggle" title="Alternar tema"><i class="fas fa-moon"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <div class="admin-panel" id="adminPanel" aria-hidden="true">
            <div class="container">
                <div class="admin-header">
                    <h2 class="admin-title">Painel Administrativo</h2>
                    <div>
                        <button class="btn btn-secondary" id="closeAdmin"><i class="fas fa-times"></i> Fechar</button>
                        <button class="btn btn-danger" id="logoutBtn" style="display:none;"><i class="fas fa-sign-out-alt"></i> Sair</button>
                    </div>
                </div>

                <div class="admin-tabs" role="tablist">
                    <div class="admin-tab active" data-tab="units" role="tab">Gerenciar Unidades</div>
                    <div class="admin-tab" data-tab="add" role="tab">Adicionar Unidade</div>
                    <div class="admin-tab" data-tab="github" role="tab">GitHub Sync</div>
                    <div class="admin-tab" data-tab="config" role="tab">Configura√ß√µes</div>
                </div>

                <div class="admin-content active" id="units-content">
                    <h3>Unidades Cadastradas</h3>
                    <div class="units-list" id="unitsList"></div>
                </div>

                <div class="admin-content" id="add-content">
                    <h3 id="formTitle">Adicionar Nova Unidade</h3>
                    <form id="unitForm">
                        <div class="form-grid">
                            <div class="form-group"><label for="unitName">Nome da Unidade *</label><input type="text" id="unitName" class="form-control" required></div>
                            <div class="form-group"><label for="unitType">Tipo *</label>
                                <select id="unitType" class="form-control" required>
                                    <option value="">Selecione o tipo</option>
                                    <option value="promocao">Promo√ß√£o</option>
                                    <option value="recuperacao">Recupera√ß√£o</option>
                                    <option value="administrativo">Administrativo</option>
                                    <option value="vigilancia">Vigil√¢ncia</option>
                                    <option value="capne">Capne</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="unitAddress">Endere√ßo *</label><input type="text" id="unitAddress" class="form-control" required placeholder="Ex: Rua Exemplo, 123"><small class="form-text">O link do Google Maps ser√° gerado automaticamente</small></div>
                            <div class="form-group"><label for="unitBairro">Bairro *</label><input type="text" id="unitBairro" class="form-control" required placeholder="Ex: Centro"></div>
                            <div class="form-group"><label for="unitPhone">Telefone *</label><input type="text" id="unitPhone" class="form-control" required placeholder="Ex: 3314-1234"><small class="form-text">O link do WhatsApp ser√° gerado automaticamente</small></div>
                            <div class="form-group"><label for="unitEmail">E-mail</label><input type="email" id="unitEmail" class="form-control" placeholder="exemplo@pmpf.rs.gov.br"></div>
                            
                            <div class="form-group hidden" id="responsibleFieldContainer">
                                <label for="unitResponsavel">Respons√°vel *</label>
                                <input type="text" id="unitResponsavel" class="form-control" placeholder="Nome do respons√°vel pela unidade">
                            </div>
                            
                            <div class="form-group" id="vacinaField">
                                <label for="unitVacina">Sala de Vacina</label>
                                <select id="unitVacina" class="form-control">
                                    <option value="N√£o">N√£o</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>
                            <div class="form-group" id="odontoField">
                                <label for="unitOdonto">Consult√≥rio Odontol√≥gico</label>
                                <select id="unitOdonto" class="form-control">
                                    <option value="N√£o">N√£o</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>
                            <div class="form-group" id="farmaciaField">
                                <label for="unitFarmacia">Farm√°cia</label>
                                <select id="unitFarmacia" class="form-control">
                                    <option value="N√£o">N√£o</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>
                            
                            <div class="form-group" id="enfermeiroField">
                                <label for="unitEnfermeiro">Enfermeiro Respons√°vel</label>
                                <input type="text" id="unitEnfermeiro" class="form-control" placeholder="Nome do enfermeiro respons√°vel">
                            </div>
                            <div class="form-group" id="gerenteField">
                                <label for="unitGerente">Gerente Respons√°vel</label>
                                <input type="text" id="unitGerente" class="form-control" placeholder="Nome do gerente respons√°vel">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancelEdit" style="display:none;"><i class="fas fa-times"></i> Cancelar</button>
                            <button type="reset" class="btn btn-secondary"><i class="fas fa-eraser"></i> Limpar</button>
                            <button type="submit" class="btn btn-success" id="submitBtn"><i class="fas fa-plus"></i> Adicionar Unidade</button>
                        </div>
                    </form>
                </div>

                <div class="admin-content" id="github-content">
                    <h3><i class="fab fa-github"></i> Sincroniza√ß√£o com GitHub</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="githubToken">Token do GitHub *</label>
                            <input type="password" id="githubToken" class="form-control" 
                                   placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                            <small class="form-text">
                                <a href="https://github.com/settings/tokens" target="_blank">Gerar token</a> 
                                (precisa das permiss√µes: repo)
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="repoOwner">Propriet√°rio do Reposit√≥rio</label>
                            <input type="text" id="repoOwner" class="form-control" 
                                   placeholder="seu-usuario" value="gti-sms">
                        </div>
                        <div class="form-group">
                            <label for="repoName">Nome do Reposit√≥rio</label>
                            <input type="text" id="repoName" class="form-control" 
                                   placeholder="telefonia-sms" value="SMS">
                        </div>
                        <div class="form-group">
                            <label for="filePath">Caminho do Arquivo</label>
                            <input type="text" id="filePath" class="form-control" 
                                   placeholder="data/units.json" value="data/units.json">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" id="saveGitHubConfig">
                            <i class="fas fa-save"></i> Salvar Configura√ß√£o
                        </button>
                        <button type="button" class="btn btn-success" id="syncToGitHub">
                            <i class="fas fa-cloud-upload-alt"></i> Sincronizar para GitHub
                        </button>
                        <button type="button" class="btn btn-warning" id="pullFromGitHub">
                            <i class="fas fa-cloud-download-alt"></i> Puxar do GitHub
                        </button>
                        <button type="button" class="btn btn-info" id="testConnection">
                            <i class="fas fa-plug"></i> Testar Conex√£o
                        </button>
                        <button type="button" class="btn btn-secondary auto-sync-btn" id="enableAutoSync">
                            <i class="fas fa-sync"></i> Ativar Sincroniza√ß√£o Autom√°tica
                            <div class="auto-sync-status inactive" id="autoSyncStatus"></div>
                        </button>
                    </div>
                    <div id="syncStatus" style="margin-top: 20px;"></div>

                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: var(--radius-sm);">
                        <h4><i class="fas fa-info-circle"></i> Instru√ß√µes de Configura√ß√£o:</h4>
                        <ol style="margin-left: 20px; margin-top: 10px;">
                            <li>V√° para <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings > Tokens</a></li>
                            <li>Clique em "Generate new token"</li>
                            <li>D√™ um nome descritivo (ex: "Telefonia SMS")</li>
                            <li>Selecione a permiss√£o <strong>"repo"</strong></li>
                            <li>Clique em "Generate token"</li>
                            <li>Cole o token no campo acima e clique em "Salvar Configura√ß√£o"</li>
                        </ol>
                    </div>
                </div>

                <div class="admin-content" id="config-content">
                    <h3>Configura√ß√µes do Sistema</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Backup de Dados</label>
                            <button type="button" class="btn btn-primary" id="backupData">
                                <i class="fas fa-download"></i> Fazer Backup (JSON)
                            </button>
                            <small class="form-text">Salva todas as unidades localmente em um arquivo.</small>
                        </div>
                        <div class="form-group">
                            <label>Restaurar Dados</label>
                            <label for="restoreData" class="btn btn-secondary" style="margin-bottom: 0;">
                                <i class="fas fa-upload"></i> Restaurar de Backup (JSON)
                            </label>
                            <input type="file" id="restoreData" accept=".json" style="display:none;">
                            <small class="form-text">Carrega unidades de um arquivo de backup local.</small>
                        </div>
                        <div class="form-group">
                            <label>Apagar Todos os Dados</label>
                            <button type="button" class="btn btn-danger" id="clearData">
                                <i class="fas fa-trash-alt"></i> Limpar Tudo
                            </button>
                            <small class="form-text">Apaga todas as unidades, favoritos, configura√ß√µes de login e GitHub.</small>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="search-container">
            <div class="container">
                <form id="searchForm">
                    <div class="search-box">
                        <input type="text" id="searchInput" class="search-input" placeholder="Buscar por nome da unidade, telefone, bairro ou respons√°vel..." aria-label="Buscar contatos">
                        <button type="submit" class="search-btn"><i class="fas fa-search"></i> Buscar</button>
                    </div>
                </form>

                <div class="filter-options">
                    <div class="filter-btn active" data-filter="all" id="allFilter"><i class="fas fa-globe"></i> Todas</div>
                    <div class="filter-btn" data-filter="favorites" id="favoritesFilter"><i class="fas fa-star"></i> Favoritas</div>
                </div>

                <div class="service-filters">
                    <button class="service-toggle-btn active" data-service="vacina" aria-pressed="true"><i class="fas fa-syringe"></i> Sala de Vacina</button>
                    <button class="service-toggle-btn active" data-service="odonto" aria-pressed="true"><i class="fas fa-tooth"></i> Odontol√≥gico</button>
                    <button class="service-toggle-btn active" data-service="farmacia" aria-pressed="true"><i class="fas fa-pills"></i> Farm√°cia</button>
                </div>
            </div>
        </div>

        <main class="container">
            <div class="tabs" role="tablist">
                <div class="tab active" data-target="all" role="tab" aria-selected="true">Todos Contatos</div>
                <div class="tab" data-target="favorites" role="tab" aria-selected="false">Meus Favoritos</div>
            </div>

            <div class="content active" id="all-content">
                <div class="results-count" id="all-count">Mostrando todos os contatos</div>
                <div class="contact-grid" id="all-contacts"></div>
            </div>

            <div class="content" id="favorites-content">
                <div class="results-count" id="favorites-count">Seus contatos favoritos</div>
                <div class="contact-grid" id="favorites-contacts"></div>
            </div>
        </main>

        <footer class="footer">
            <div class="container footer-content">
                <p>Secretaria Municipal de Sa√∫de - Prefeitura de Passo Fundo</p>
            </div>
        </footer>
        
        <div class="live-updates-indicator" id="liveUpdatesIndicator" style="display:none;">
            <div class="pulse-dot"></div>
            <span>Atualiza√ß√£o em tempo real ativa!</span>
        </div>
    </div>

    <script>
    // =============================================
    // DATA SERVICE - VERS√ÉO COM CORRE√á√ÉO DE CACHE DO GITHUB PAGES
    // =============================================
    const DataService = {
        githubToken: '',
        repoOwner: 'gti-sms',
        repoName: 'SMS',
        filePath: 'data/units.json',
        autoSyncEnabled: false,
        lastGitHubHash: null, // Para detectar mudan√ßas

        // NOVO: Tenta carregar dados do arquivo JSON p√∫blico no GitHub (com cache-buster)
        async loadFromGitHubPublic() {
            // Se a configura√ß√£o n√£o estiver salva, usar valores padr√£o ou sair.
            if (!this.repoOwner || !this.repoName || !this.filePath) {
                console.log('‚ö†Ô∏è Configura√ß√£o do GitHub incompleta. Pulando busca p√∫blica.');
                return null;
            }
            
            // Monta a URL RAW do GitHub
            const publicUrl = `https://raw.githubusercontent.com/${this.repoOwner}/${this.repoName}/main/${this.filePath}`;
            
            // Adiciona um timestamp para evitar o cache agressivo do navegador/CDN (CORRE√á√ÉO DE CACHE)
            const cacheBusterUrl = `${publicUrl}?t=${new Date().getTime()}`;

            try {
                console.log('üåê Buscando dados p√∫blicos do GitHub (com cache-buster)...', cacheBusterUrl);
                const response = await fetch(cacheBusterUrl, { 
                    cache: 'no-store' // Adiciona um cabe√ßalho para tentar evitar o cache do navegador
                });

                if (response.status === 404) {
                    console.log('‚ùå Arquivo de dados n√£o encontrado no reposit√≥rio p√∫blico (404).');
                    return []; // Retorna array vazio se n√£o encontrar o arquivo
                }

                if (!response.ok) {
                    throw new Error(`Erro de rede ao buscar dados: ${response.statusText}`);
                }

                const data = await response.json();
                return data;

            } catch (error) {
                console.error('‚ùå Erro ao carregar dados p√∫blicos do GitHub:', error);
                // Em caso de erro (rede, CORS, JSON inv√°lido), retorna nulo para que getUnits fa√ßa o fallback
                return null; 
            }
        },

        // REESCRITO: Prioriza a busca p√∫blica com cache-buster, depois local.
        async getUnits() {
            try {
                console.log('üîÑ Iniciando carregamento de dados...');
                
                // PRIMEIRO: Tentar carregar do GitHub Publicamente com Cache-Buster
                const remoteData = await this.loadFromGitHubPublic(); 
                
                if (remoteData && remoteData.length > 0) {
                    console.log('‚úÖ Dados carregados do GitHub p√∫blico (uncached):', remoteData.length, 'unidades');
                    // Salvar localmente como cache
                    this.saveUnits(remoteData); 
                    return remoteData;
                } 
                
                // SEGUNDO: Se a busca p√∫blica falhar, fallback para dados locais
                console.log('‚ùå Busca p√∫blica falhou/vazia, tentando dados locais...'); 
                const localUnits = this.getUnitsSync(); 
                
                if (localUnits && localUnits.length > 0) {
                    console.log('üìÅ Usando dados locais em cache:', localUnits.length, 'unidades');
                    return localUnits;
                } 

                // TERCEIRO: Se tudo falhar, array vazio
                console.log('üí° Nenhum dado encontrado, iniciando com array vazio'); 
                return [];
            } catch (error) {
                console.error('‚ùå Erro no fluxo de carregamento de unidades:', error);
                return [];
            }
        },

        getUnitsSync() {
            try {
                const units = localStorage.getItem('units');
                return units ? JSON.parse(units) : [];
            } catch (error) {
                console.error('‚ùå Erro ao carregar unidades locais:', error);
                return [];
            }
        },

        // Verifica se h√° novas atualiza√ß√µes comparando o hash do √∫ltimo commit.
        async checkForUpdates() {
            // S√≥ verifica se houver token
            if (!this.githubToken) {
                console.log('‚ö†Ô∏è Token n√£o configurado para checar commits.');
                return false;
            }

            try {
                const response = await fetch(
                    `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/commits?path=${this.filePath}&per_page=1`,
                    {
                        headers: {
                            'Authorization': `Bearer ${this.githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    const commits = await response.json();
                    if (commits && commits.length > 0) {
                        const latestHash = commits[0].sha;
                        if (this.lastGitHubHash && this.lastGitHubHash !== latestHash) {
                            console.log('üîÑ Mudan√ßas detectadas no GitHub!');
                            this.lastGitHubHash = latestHash;
                            return true;
                        }
                        this.lastGitHubHash = latestHash;
                    }
                }
                return false;
            } catch (error) {
                console.log('‚ùå Erro ao verificar atualiza√ß√µes:', error);
                return false;
            }
        },

        saveUnits(units) {
            try {
                localStorage.setItem('units', JSON.stringify(units));
                console.log('üíæ Dados salvos localmente:', units.length, 'unidades');
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao salvar unidades:', error);
                return false;
            }
        },

        // Adicionar/editar unidade com sync autom√°tico
        async saveUnit(unit) {
            const units = this.getUnitsSync();
            if (unit.id) {
                // Editar unidade existente
                const index = units.findIndex(u => u.id === unit.id);
                if (index !== -1) {
                    units[index] = unit;
                    console.log('‚úèÔ∏è Unidade editada:', unit.id, unit.name);
                }
            } else {
                // Nova unidade
                unit.id = units.length > 0 ? Math.max(...units.map(u => u.id)) + 1 : 1;
                units.push(unit);
                console.log('‚ûï Nova unidade:', unit.id, unit.name);
            }
            const success = this.saveUnits(units);

            // Sincroniza√ß√£o autom√°tica com GitHub
            if (success && this.autoSyncEnabled && this.githubToken) {
                console.log('üîÑ Sincroniza√ß√£o autom√°tica ativada, enviando para GitHub...');
                try {
                    await this.syncToGitHub();
                    console.log('‚úÖ Sincroniza√ß√£o autom√°tica conclu√≠da');
                } catch (error) {
                    console.error('‚ùå Erro na sincroniza√ß√£o autom√°tica:', error);
                }
            }
            return success;
        },

        // Deletar unidade com sync autom√°tico
        async deleteUnit(id) {
            let units = this.getUnitsSync();
            const initialLength = units.length;
            units = units.filter(u => u.id !== id);
            
            if (units.length === initialLength) {
                console.log('‚ö†Ô∏è Unidade n√£o encontrada para exclus√£o.');
                return false;
            }
            
            const success = this.saveUnits(units);
            console.log('üóëÔ∏è Unidade exclu√≠da:', id);

            // Sincroniza√ß√£o autom√°tica com GitHub
            if (success && this.autoSyncEnabled && this.githubToken) {
                console.log('üîÑ Sincroniza√ß√£o autom√°tica ativada, enviando para GitHub...');
                try {
                    await this.syncToGitHub();
                    console.log('‚úÖ Sincroniza√ß√£o autom√°tica conclu√≠da');
                } catch (error) {
                    console.error('‚ùå Erro na sincroniza√ß√£o autom√°tica:', error);
                }
            }
            return success;
        },

        // Testa a conex√£o com o GitHub
        async testGitHubConnection() {
            if (!this.githubToken) {
                return { success: false, message: 'Token do GitHub n√£o configurado' };
            }

            try {
                const response = await fetch(`https://api.github.com/user`, {
                    headers: {
                        'Authorization': `Bearer ${this.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    return { success: true, message: `Conex√£o OK! Logado como: ${user.login}` };
                } else {
                    const error = await response.json();
                    return { success: false, message: error.message || 'Erro na conex√£o' };
                }
            } catch (error) {
                return { success: false, message: 'Erro de rede: ' + error.message };
            }
        },

        async getGitHubFile() {
            if (!this.githubToken) return null;
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/${this.filePath}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${this.githubToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );

                if (response.status === 404) {
                    return { exists: false, message: 'Arquivo n√£o encontrado' };
                }

                if (response.ok) {
                    const data = await response.json();
                    return { exists: true, data: data };
                }
                return null;
            } catch (error) {
                console.error('Erro ao buscar arquivo:', error);
                return null;
            }
        },

        async syncToGitHub() {
            if (!this.githubToken) {
                return { success: false, message: 'Token do GitHub n√£o configurado' };
            }

            try {
                // Obter dados atuais
                const units = this.getUnitsSync();
                const content = JSON.stringify(units, null, 2);
                
                // Codificar para base64 (correto)
                const contentBase64 = btoa(unescape(encodeURIComponent(content)));

                // Obter informa√ß√µes do arquivo atual (para pegar o SHA)
                const fileInfo = await this.getGitHubFile();
                let sha = null;
                if (fileInfo && fileInfo.exists) {
                    sha = fileInfo.data.sha;
                    console.log('üìù Arquivo existe, SHA:', sha);
                } else {
                    console.log('üìù Arquivo n√£o existe, ser√° criado novo');
                }

                // Preparar payload
                const payload = {
                    message: `Sync: Atualiza√ß√£o autom√°tica - ${new Date().toLocaleString('pt-BR')}`,
                    content: contentBase64,
                    branch: 'main'
                };

                // Adicionar SHA se o arquivo j√° existe
                if (sha) {
                    payload.sha = sha;
                }

                console.log('üîÑ Enviando para GitHub...', { repo: `${this.repoOwner}/${this.repoName}`, path: this.filePath, units: units.length, sha: sha ? 'sim' : 'n√£o' });

                // Fazer a requisi√ß√£o para a API do GitHub
                const response = await fetch(
                    `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/${this.filePath}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${this.githubToken}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify(payload)
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    this.lastGitHubHash = data.commit.sha; // Atualiza o hash
                    return { success: true, message: `Sincronizado! Commit: ${data.commit.sha.substring(0, 7)}` };
                } else {
                    const error = await response.json();
                    return { success: false, message: error.message || 'Erro ao sincronizar' };
                }
            } catch (error) {
                console.error('Erro de sincroniza√ß√£o:', error);
                return { success: false, message: 'Erro de rede/sincroniza√ß√£o: ' + error.message };
            }
        },

        async pullFromGitHub() {
            if (!this.githubToken) {
                return { success: false, message: 'Token do GitHub n√£o configurado' };
            }
            try {
                const fileInfo = await this.getGitHubFile();
                if (!fileInfo || !fileInfo.exists) {
                    return { success: false, message: 'Arquivo n√£o encontrado no GitHub' };
                }

                const content = JSON.parse(decodeURIComponent(escape(atob(fileInfo.data.content))));

                if (this.saveUnits(content)) {
                    return { success: true, message: `Dados carregados! ${content.length} unidades.`, data: content };
                } else {
                    return { success: false, message: 'Erro ao salvar dados localmente' };
                }
            } catch (error) {
                console.error('Erro ao puxar dados:', error);
                return { success: false, message: 'Erro ao carregar dados: ' + error.message };
            }
        },

        // Configurar sincroniza√ß√£o autom√°tica
        setAutoSync(enabled) {
            this.autoSyncEnabled = enabled;
            localStorage.setItem('github_auto_sync', enabled.toString());
            console.log('üîÑ Sincroniza√ß√£o autom√°tica:', enabled ? 'ATIVADA' : 'DESATIVADA');

            // Atualizar status visual
            const statusEl = document.getElementById('autoSyncStatus');
            if (statusEl) {
                statusEl.className = `auto-sync-status ${enabled ? 'syncing' : 'inactive'}`;
            }

            // Atualizar texto do bot√£o
            const button = document.getElementById('enableAutoSync');
            if (button) {
                // L√≥gica de atualiza√ß√£o de texto/√≠cone do bot√£o
                if (enabled) {
                    button.innerHTML = '<i class="fas fa-sync-alt"></i> Desativar Sincroniza√ß√£o Autom√°tica';
                } else {
                    button.innerHTML = '<i class="fas fa-sync"></i> Ativar Sincroniza√ß√£o Autom√°tica';
                }
                // Adiciona o status dot de volta
                if (!button.querySelector('.auto-sync-status')) {
                    button.innerHTML += `<div class="auto-sync-status ${enabled ? 'syncing' : 'inactive'}" id="autoSyncStatus"></div>`;
                }
            }
        },

        // Carregar configura√ß√£o de auto sync
        loadAutoSyncConfig() {
            const autoSync = localStorage.getItem('github_auto_sync');
            this.autoSyncEnabled = autoSync === 'true';
            // Chama setAutoSync para configurar o visual corretamente
            this.setAutoSync(this.autoSyncEnabled); 
        }
    };


    // =============================================
    // AUTH SERVICE
    // =============================================
    const AuthService = {
        adminUser: 'admin',
        adminPass: 'admin123',

        login(username, password) {
            if (username === this.adminUser && password === this.adminPass) {
                localStorage.setItem('telefonia_isLogged', 'true');
                return { success: true };
            }
            return { success: false, message: 'Usu√°rio ou senha incorretos' };
        },

        logout() {
            localStorage.removeItem('telefonia_isLogged');
        },

        isLogged() {
            return localStorage.getItem('telefonia_isLogged') === 'true';
        }
    };


    // =============================================
    // UI CONTROLLER
    // =============================================
    const UI = {
        elements: {},

        init() {
            this.cacheElements();
            this.loadTheme();
            this.bindEvents();
            this.setupConditionalFormLogic();
            if (AuthService.isLogged()) {
                this.elements.logoutBtn.style.display = 'inline-flex';
            }
            this.loadGitHubConfig();
            DataService.loadAutoSyncConfig();
        },

        cacheElements() {
            // Modal de login
            this.elements.loginModal = document.getElementById('loginModal');
            this.elements.loginForm = document.getElementById('loginForm');
            this.elements.loginUsername = document.getElementById('loginUsername');
            this.elements.loginPassword = document.getElementById('loginPassword');

            // Header/Layout
            this.elements.adminToggle = document.getElementById('adminToggle');
            this.elements.themeToggle = document.getElementById('themeToggle');
            this.elements.telefoniaContainer = document.getElementById('telefonia-container');
            this.elements.loadingScreen = document.getElementById('loadingScreen');
            this.elements.loadingStatus = document.getElementById('loadingStatus');

            // Admin Panel
            this.elements.adminPanel = document.getElementById('adminPanel');
            this.elements.closeAdmin = document.getElementById('closeAdmin');
            this.elements.logoutBtn = document.getElementById('logoutBtn');
            this.elements.adminTabs = document.querySelectorAll('.admin-tab');
            this.elements.unitsList = document.getElementById('unitsList');

            // Conte√∫do principal
            this.elements.allContacts = document.getElementById('all-contacts');
            this.elements.favoritesContacts = document.getElementById('favorites-contacts');
            this.elements.allCount = document.getElementById('all-count');
            this.elements.favoritesCount = document.getElementById('favorites-count');

            // Formul√°rio de unidade
            this.elements.unitForm = document.getElementById('unitForm');
            this.elements.submitBtn = document.getElementById('submitBtn');
            this.elements.cancelEdit = document.getElementById('cancelEdit');
            this.elements.formTitle = document.getElementById('formTitle');

            // Busca e filtros
            this.elements.searchInput = document.getElementById('searchInput');
            this.elements.searchBtn = document.getElementById('searchBtn');
            this.elements.filterBtns = document.querySelectorAll('.filter-btn');
            this.elements.tabs = document.querySelectorAll('.tab');
            this.elements.serviceToggleBtns = document.querySelectorAll('.service-toggle-btn');
            this.elements.liveUpdatesIndicator = document.getElementById('liveUpdatesIndicator');

            // GitHub Sync
            this.elements.githubToken = document.getElementById('githubToken');
            this.elements.repoOwner = document.getElementById('repoOwner');
            this.elements.repoName = document.getElementById('repoName');
            this.elements.filePath = document.getElementById('filePath');
            this.elements.saveGitHubConfig = document.getElementById('saveGitHubConfig');
            this.elements.syncToGitHub = document.getElementById('syncToGitHub');
            this.elements.pullFromGitHub = document.getElementById('pullFromGitHub');
            this.elements.testConnection = document.getElementById('testConnection');
            this.elements.syncStatus = document.getElementById('syncStatus');
            this.elements.enableAutoSync = document.getElementById('enableAutoSync');
            this.elements.autoSyncStatus = document.getElementById('autoSyncStatus');

            // Configura√ß√µes
            this.elements.backupBtn = document.getElementById('backupData');
            this.elements.restoreInput = document.getElementById('restoreData');
            this.elements.clearAllBtn = document.getElementById('clearData');

            // Campos condicionais
            this.elements.unitType = document.getElementById('unitType');
            this.elements.responsibleField = document.getElementById('responsibleFieldContainer');
            this.elements.enfermeiroField = document.getElementById('enfermeiroField');
            this.elements.gerenteField = document.getElementById('gerenteField');
        },

        setupConditionalFormLogic() {
            const conditionalTypes = ['administrativo', 'vigilancia', 'capne', 'outros'];
            const checkFields = () => {
                const type = this.elements.unitType.value;
                const isConditional = conditionalTypes.includes(type);
                
                // Esconde/mostra campos de Promo√ß√£o/Recupera√ß√£o
                document.getElementById('vacinaField').classList.toggle('hidden', isConditional);
                document.getElementById('odontoField').classList.toggle('hidden', isConditional);
                document.getElementById('farmaciaField').classList.toggle('hidden', isConditional);
                this.elements.enfermeiroField.classList.toggle('hidden', isConditional);
                this.elements.gerenteField.classList.toggle('hidden', isConditional);

                // Esconde/mostra campo de Respons√°vel
                this.elements.responsibleField.classList.toggle('hidden', !isConditional);
                document.getElementById('unitResponsavel').required = isConditional;
                
                // Remove required dos campos escondidos
                document.getElementById('unitEnfermeiro').required = !isConditional;
                document.getElementById('unitGerente').required = !isConditional;
            };

            this.elements.unitType.addEventListener('change', checkFields);
            checkFields();
        },

        bindEvents() {
            // Toggle do painel admin
            this.elements.adminToggle.addEventListener('click', () => {
                if (AuthService.isLogged()) {
                    this.openAdmin();
                } else {
                    this.showLogin();
                }
            });

            // Fechar painel admin
            this.elements.closeAdmin.addEventListener('click', () => this.closeAdmin());

            // Logout
            this.elements.logoutBtn.addEventListener('click', () => {
                AuthService.logout();
                this.elements.logoutBtn.style.display = 'none';
                this.closeAdmin();
                alert('Desconectado do painel administrativo');
            });

            // Login
            this.elements.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                this.showLoading('Autenticando...');
                
                const username = this.elements.loginUsername.value.trim();
                const password = this.elements.loginPassword.value;
                const result = AuthService.login(username, password);
                
                this.hideLoading();

                if (result.success) {
                    this.hideLogin();
                    this.elements.logoutBtn.style.display = 'inline-flex';
                    this.openAdmin();
                    alert('Login bem-sucedido!');
                } else {
                    alert(result.message);
                }
            });

            // Toggle de tema
            this.elements.themeToggle.addEventListener('click', () => this.toggleTheme());

            // Navega√ß√£o entre abas
            this.elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => this.handleTabClick(tab));
            });

            // Navega√ß√£o entre abas do Admin
            this.elements.adminTabs.forEach(tab => {
                tab.addEventListener('click', () => this.handleAdminTabClick(tab));
            });

            // Pesquisa e filtros
            this.elements.searchBtn.addEventListener('click', (e) => {
                e.preventDefault();
                App.performSearch();
            });
            this.elements.searchInput.addEventListener('input', () => App.performSearch());
            this.elements.filterBtns.forEach(btn => {
                btn.addEventListener('click', () => this.handleFilterClick(btn));
            });
            this.elements.serviceToggleBtns.forEach(btn => {
                btn.addEventListener('click', () => this.handleServiceToggle(btn));
            });
            
            // Submiss√£o do formul√°rio de unidade (Adicionar/Editar)
            this.elements.unitForm.addEventListener('submit', (e) => App.handleUnitFormSubmit(e));
            this.elements.cancelEdit.addEventListener('click', () => App.cancelEdit());

            // GitHub Sync
            this.elements.saveGitHubConfig.addEventListener('click', () => this.saveGitHubConfig());
            this.elements.syncToGitHub.addEventListener('click', () => App.syncToGitHub());
            this.elements.pullFromGitHub.addEventListener('click', () => App.pullFromGitHub());
            this.elements.testConnection.addEventListener('click', () => App.testGitHubConnection());
            this.elements.enableAutoSync.addEventListener('click', () => App.toggleAutoSync());

            // Configura√ß√µes
            this.elements.backupBtn.addEventListener('click', () => App.backupData());
            this.elements.restoreInput.addEventListener('change', (e) => App.restoreData(e.target.files[0]));
            this.elements.clearAllBtn.addEventListener('click', () => App.clearAllData());
        },

        // M√©todos de UI
        showLogin() {
            this.elements.loginModal.classList.add('active');
            this.elements.loginModal.setAttribute('aria-hidden', 'false');
            this.elements.loginUsername.focus();
        },

        hideLogin() {
            this.elements.loginModal.classList.remove('active');
            this.elements.loginModal.setAttribute('aria-hidden', 'true');
            this.elements.loginForm.reset();
        },

        openAdmin() {
            this.elements.adminPanel.classList.add('active');
            this.elements.adminPanel.setAttribute('aria-hidden', 'false');
            // Garante que a primeira aba esteja ativa ao abrir
            this.handleAdminTabClick(document.querySelector('.admin-tab.active') || document.querySelector('.admin-tab[data-tab="units"]'));
        },

        closeAdmin() {
            this.elements.adminPanel.classList.remove('active');
            this.elements.adminPanel.setAttribute('aria-hidden', 'true');
        },

        showLoading(status = 'Carregando...') {
            this.elements.loadingStatus.textContent = status;
            this.elements.loadingScreen.style.display = 'flex';
        },

        hideLoading() {
            this.elements.loadingScreen.style.display = 'none';
            this.elements.loadingStatus.textContent = 'Conectando ao GitHub'; // Reset default text
        },

        toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = this.elements.themeToggle.querySelector('i');
            if (document.body.classList.contains('dark-mode')) {
                icon.className = 'fas fa-sun';
                localStorage.setItem('telefonia_theme', 'dark');
            } else {
                icon.className = 'fas fa-moon';
                localStorage.setItem('telefonia_theme', 'light');
            }
        },

        loadTheme() {
            const theme = localStorage.getItem('telefonia_theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                this.elements.themeToggle.querySelector('i').className = 'fas fa-sun';
            }
        },

        loadGitHubConfig() {
            const config = localStorage.getItem('github_config');
            if (config) {
                const { token, owner, repo, filePath } = JSON.parse(config);
                DataService.githubToken = token;
                DataService.repoOwner = owner;
                DataService.repoName = repo;
                DataService.filePath = filePath;

                // Atualizar campos visuais (sem o token)
                this.elements.repoOwner.value = owner;
                this.elements.repoName.value = repo;
                this.elements.filePath.value = filePath;
                
                if (token) {
                    this.elements.githubToken.placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (j√° configurado)';
                }
            }
        },

        saveGitHubConfig() {
            const token = this.elements.githubToken.value.trim() || DataService.githubToken; // Se vazio, usa o configurado anteriormente
            const owner = this.elements.repoOwner.value.trim();
            const repo = this.elements.repoName.value.trim();
            const filePath = this.elements.filePath.value.trim();

            if (!token || !owner || !repo || !filePath) {
                this.showSyncStatus('Preencha todos os campos obrigat√≥rios.', 'error');
                return;
            }

            DataService.githubToken = token;
            DataService.repoOwner = owner;
            DataService.repoName = repo;
            DataService.filePath = filePath;
            
            localStorage.setItem('github_config', JSON.stringify({ token, owner, repo, filePath }));

            this.elements.githubToken.value = '';
            this.elements.githubToken.placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (configurado com sucesso)';
            this.showSyncStatus('Configura√ß√£o do GitHub salva com sucesso!', 'success');
        },

        showSyncStatus(message, type = 'info') {
            const statusEl = this.elements.syncStatus;
            statusEl.innerHTML = `<div class="sync-status sync-${type}">${message}</div>`;
            if (type === 'success') {
                setTimeout(() => statusEl.innerHTML = '', 5000);
            }
        },

        handleTabClick(tab) {
            this.elements.tabs.forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`${tab.dataset.target}-content`).classList.add('active');
        },

        handleAdminTabClick(tab) {
            this.elements.adminTabs.forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
            
            tab.classList.add('active');
            document.getElementById(`${tab.dataset.tab}-content`).classList.add('active');

            // Se for a aba de adicionar, limpa o formul√°rio
            if (tab.dataset.tab === 'add') {
                App.cancelEdit();
            }
        },

        handleFilterClick(clickedBtn) {
            const filter = clickedBtn.dataset.filter;
            this.elements.filterBtns.forEach(btn => btn.classList.remove('active'));
            clickedBtn.classList.add('active');

            // Muda a aba de conte√∫do
            this.handleTabClick(document.querySelector(`.tab[data-target="${filter}"]`));
            
            App.performSearch();
        },

        handleServiceToggle(clickedBtn) {
            clickedBtn.classList.toggle('active');
            clickedBtn.setAttribute('aria-pressed', clickedBtn.classList.contains('active'));
            App.performSearch();
        },

        renderContacts(units, target) {
            const grid = target === 'all' ? this.elements.allContacts : this.elements.favoritesContacts;
            grid.innerHTML = '';

            if (units.length === 0) {
                grid.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>${target === 'all' ? 'Nenhum resultado encontrado para a busca.' : 'Voc√™ ainda n√£o possui favoritos.'}</p>
                    </div>
                `;
                grid.style.gridTemplateColumns = '1fr';
                return;
            }
            grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(380px, 1fr))';

            units.forEach(unit => {
                grid.appendChild(this.createContactCard(unit));
            });

            this.attachFavoriteListeners();
        },

        getTypeLabel(type) {
            const map = {
                'promocao': 'Promo√ß√£o √† Sa√∫de',
                'recuperacao': 'Recupera√ß√£o',
                'administrativo': 'Administrativo',
                'vigilancia': 'Vigil√¢ncia',
                'capne': 'CAP/NE',
                'outros': 'Outros'
            };
            return map[type] || type;
        },

        setCounts(all, favorites) {
            this.elements.allCount.textContent = `Mostrando ${all} contato(s)`;
            this.elements.favoritesCount.textContent = `Seus ${favorites} favorito(s)`;
            
            document.querySelector('.filter-btn[data-filter="all"]').innerHTML = `<i class="fas fa-globe"></i> Todas (${all})`;
            document.querySelector('.filter-btn[data-filter="favorites"]').innerHTML = `<i class="fas fa-star"></i> Favoritas (${favorites})`;
        },

        createContactCard(contact) {
            const telOnly = contact.phone.replace(/\D/g, '');
            const telLink = `tel:${telOnly}`;
            const whatsappLink = `https://wa.me/55${telOnly.length === 8 ? '54' : ''}${telOnly}?text=Ol%C3%A1%2C%20gostaria%20de%20informa%C3%A7%C3%B5es%20sobre%20a%20unidade%20${encodeURIComponent(contact.name)}`;
            const mapsQuery = encodeURIComponent(`${contact.name}, ${contact.address}, ${contact.bairro}, Passo Fundo`);
            const mapsLink = `https://www.google.com/maps/search/?api=1&query=${mapsQuery}`;

            const card = document.createElement('div');
            card.className = 'contact-card';
            card.innerHTML = `
                <button class="favorite-btn ${contact.favorite ? 'active' : ''}" data-id="${contact.id}" title="${contact.favorite ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                    <i class="fas fa-star"></i>
                </button>
                <div class="contact-header">
                    <h3 class="contact-name">${contact.name}</h3>
                    <span class="contact-type">${this.getTypeLabel(contact.type)}</span>
                </div>
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${contact.address}, ${contact.bairro}</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <span>${contact.phone}</span>
                    </div>
                    ${contact.email ? `
                        <div class="contact-item">
                            <i class="fas fa-envelope"></i>
                            <a href="mailto:${contact.email}">${contact.email}</a>
                        </div>` : ''}
                    ${contact.enfermeiro ? `
                        <div class="contact-item">
                            <i class="fas fa-user-nurse"></i>
                            <span>Enfermeiro: ${contact.enfermeiro}</span>
                        </div>` : ''}
                    ${contact.gerente ? `
                        <div class="contact-item">
                            <i class="fas fa-user-tie"></i>
                            <span>Gerente: ${contact.gerente}</span>
                        </div>` : ''}
                    ${contact.responsavel ? `
                        <div class="contact-item">
                            <i class="fas fa-user"></i>
                            <span>Respons√°vel: ${contact.responsavel}</span>
                        </div>` : ''}
                </div>
                <div class="contact-services">
                    <div class="service ${contact.vacina === 'Sim' ? 'available' : 'unavailable'}">
                        <i class="fas fa-syringe"></i>
                        <span class="service-label">Vacina</span>
                    </div>
                    <div class="service ${contact.odonto === 'Sim' ? 'available' : 'unavailable'}">
                        <i class="fas fa-tooth"></i>
                        <span class="service-label">Odonto</span>
                    </div>
                    <div class="service ${contact.farmacia === 'Sim' ? 'available' : 'unavailable'}">
                        <i class="fas fa-pills"></i>
                        <span class="service-label">Farm√°cia</span>
                    </div>
                </div>
                <div class="contact-actions">
                    <button class="action-btn call-btn" onclick="window.open('${telLink}', '_self')">
                        <i class="fas fa-phone"></i> Ligar
                    </button>
                    <button class="action-btn whatsapp-btn" onclick="window.open('${whatsappLink}', '_blank')">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button class="action-btn location-btn" onclick="window.open('${mapsLink}', '_blank')">
                        <i class="fas fa-map"></i> Localiza√ß√£o
                    </button>
                </div>
            `;
            return card;
        },

        attachFavoriteListeners() {
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = parseInt(btn.getAttribute('data-id'));
                    await App.toggleFavorite(id);
                });
            });
        },

        renderUnitsList(units) {
            this.elements.unitsList.innerHTML = '';

            if (units.length === 0) {
                this.elements.unitsList.innerHTML = `<div class="unit-item">Nenhuma unidade cadastrada.</div>`;
                return;
            }

            units.forEach(unit => {
                const item = document.createElement('div');
                item.className = 'unit-item';
                item.innerHTML = `
                    <div class="unit-info">
                        <h4>${unit.name}</h4>
                        <p>${this.getTypeLabel(unit.type)} - ${unit.phone}</p>
                    </div>
                    <div class="unit-actions">
                        <button class="btn btn-warning edit-unit" data-id="${unit.id}">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-danger delete-unit" data-id="${unit.id}">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                `;
                this.elements.unitsList.appendChild(item);
            });

            document.querySelectorAll('.edit-unit').forEach(btn => {
                btn.addEventListener('click', () => App.editUnit(parseInt(btn.dataset.id)));
            });
            document.querySelectorAll('.delete-unit').forEach(btn => {
                btn.addEventListener('click', () => App.deleteUnit(parseInt(btn.dataset.id)));
            });
        },
        
        showLiveUpdatesIndicator() {
            this.elements.liveUpdatesIndicator.style.display = 'flex';
            setTimeout(() => {
                this.elements.liveUpdatesIndicator.style.display = 'none';
            }, 5000);
        }
    };


    // =============================================
    // APPLICATION LOGIC
    // =============================================
    const App = {
        units: [],
        favorites: [],
        autoUpdateInterval: null,
        activeServiceFilters: ['vacina', 'odonto', 'farmacia'],

        async init() {
            UI.init();
            this.loadFavorites();
            UI.showLoading('Carregando dados...');
            
            // Garantir que a l√≥gica de auto-sync e update esteja pronta antes de carregar
            this.setupRealTimeUpdates();
            
            await this.refreshAll();
            
            UI.hideLoading();
            UI.elements.telefoniaContainer.style.display = 'block';
            
            // Ativa a pesquisa inicial
            this.performSearch();
        },

        // Carrega dados e atualiza a UI
        async refreshAll() {
            console.log('üîÑ Atualizando dados da aplica√ß√£o...');
            // SEMPRE carregar do GitHub primeiro (agora com cache-buster)
            this.units = await DataService.getUnits();
            console.log('üìä Unidades carregadas:', this.units.length);
            
            // Atualizar favoritos
            this.units.forEach(unit => {
                unit.favorite = this.favorites.includes(unit.id);
            });
            
            UI.renderContacts(this.units, 'all');
            UI.renderContacts(this.units.filter(u => this.favorites.includes(u.id)), 'favorites');
            UI.renderUnitsList(this.units);
            UI.setCounts(this.units.length, this.favorites.length);
            this.performSearch(); // Re-aplica a pesquisa para garantir a visualiza√ß√£o correta
        },

        // Carrega favoritos do localStorage
        loadFavorites() {
            const favs = localStorage.getItem('telefonia_favorites');
            this.favorites = favs ? JSON.parse(favs) : [];
        },

        // Configura o intervalo de verifica√ß√£o de atualiza√ß√µes no GitHub
        setupRealTimeUpdates() {
            // Limpa o intervalo anterior, se houver
            if (this.autoUpdateInterval) {
                clearInterval(this.autoUpdateInterval);
            }

            // Verificar atualiza√ß√µes a cada 30 segundos (tempo real)
            this.autoUpdateInterval = setInterval(async () => {
                console.log('‚è∞ Verificando atualiza√ß√µes no GitHub...');
                try {
                    const hasUpdates = await DataService.checkForUpdates();
                    if (hasUpdates) {
                        console.log('üîÑ Atualiza√ß√µes encontradas! Recarregando...');
                        await this.refreshAll();
                        this.showUpdateNotification();
                        UI.showLiveUpdatesIndicator();
                    }
                } catch (error) {
                    console.log('‚ùå Erro na verifica√ß√£o autom√°tica:', error);
                }
            }, 30000); // 30 segundos - TEMPO REAL

            // Tamb√©m verificar quando a p√°gina ganha foco
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('üì± P√°gina vis√≠vel, verificando atualiza√ß√µes...');
                    this.checkForUpdatesSilently();
                }
            });

            // Verificar quando o usu√°rio volta online
            window.addEventListener('online', () => {
                console.log('üåê Conex√£o restaurada, verificando atualiza√ß√µes...');
                this.checkForUpdatesSilently();
            });
        },

        // Checa por updates sem mostrar tela de carregamento
        async checkForUpdatesSilently() {
            try {
                const hasUpdates = await DataService.checkForUpdates();
                if (hasUpdates) {
                    console.log('üîÑ Atualiza√ß√µes encontradas (silencioso)! Recarregando...');
                    await this.refreshAll();
                }
            } catch (error) {
                console.log('‚ùå Erro na verifica√ß√£o silenciosa:', error);
            }
        },

        showUpdateNotification() {
            const notification = document.createElement('div');
            notification.className = 'update-notification';
            notification.innerHTML = `
                <i class="fas fa-sync-alt"></i> <span>Dados atualizados carregados do GitHub!</span>
                <button onclick="this.parentElement.remove()">‚úï</button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        },

        // Favoritos
        async toggleFavorite(unitId) {
            if (!this.units.find(u => u.id === unitId)) return;
            
            const index = this.favorites.indexOf(unitId);
            if (index === -1) {
                this.favorites.push(unitId);
            } else {
                this.favorites.splice(index, 1);
            }

            localStorage.setItem('telefonia_favorites', JSON.stringify(this.favorites));
            await this.refreshAll();
        },

        // L√≥gica de filtro e busca
        filterContacts(filterType) {
            const searchTerm = UI.elements.searchInput.value.toLowerCase().trim();
            const unitsToFilter = this.units;

            // Filtro de Favoritos
            let filtered = unitsToFilter;
            if (filterType === 'favorites') {
                filtered = filtered.filter(unit => unit.favorite);
            }

            // Filtro de Servi√ßos
            const activeServices = Array.from(UI.elements.serviceToggleBtns)
                                        .filter(btn => btn.classList.contains('active'))
                                        .map(btn => btn.dataset.service);

            filtered = filtered.filter(unit => {
                if (activeServices.length === 0) return false; // Se n√£o houver filtros ativos, n√£o mostra nada
                
                // O crit√©rio √©: a unidade deve ter 'Sim' para TODOS os servi√ßos ativos
                const hasAllServices = activeServices.every(service => {
                    const serviceValue = unit[service];
                    return serviceValue === 'Sim';
                });
                return hasAllServices;
            });
            
            // Filtro de Busca
            if (searchTerm) {
                filtered = filtered.filter(unit =>
                    unit.name.toLowerCase().includes(searchTerm) ||
                    unit.phone.includes(searchTerm) ||
                    unit.address.toLowerCase().includes(searchTerm) ||
                    unit.bairro.toLowerCase().includes(searchTerm) ||
                    (unit.enfermeiro && unit.enfermeiro.toLowerCase().includes(searchTerm)) ||
                    (unit.gerente && unit.gerente.toLowerCase().includes(searchTerm)) ||
                    (unit.responsavel && unit.responsavel.toLowerCase().includes(searchTerm))
                );
            }

            UI.renderContacts(filtered, filterType);
            UI.setCounts(this.units.length, this.favorites.length);
        },

        performSearch() {
            const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
            this.filterContacts(activeFilter);
        },

        // CRUD - Admin
        handleUnitFormSubmit(e) {
            e.preventDefault();

            if (!AuthService.isLogged()) {
                UI.showLogin();
                return;
            }

            const isEdit = !!UI.elements.unitForm.dataset.editId;
            const unitId = isEdit ? parseInt(UI.elements.unitForm.dataset.editId) : null;
            const unitType = document.getElementById('unitType').value;
            const isConditional = ['administrativo', 'vigilancia', 'capne', 'outros'].includes(unitType);

            // Coleta de dados
            const unit = {
                id: unitId,
                name: document.getElementById('unitName').value.trim(),
                type: unitType,
                address: document.getElementById('unitAddress').value.trim(),
                bairro: document.getElementById('unitBairro').value.trim(),
                phone: document.getElementById('unitPhone').value.trim(),
                email: document.getElementById('unitEmail').value.trim() || null,
                vacina: isConditional ? 'N√£o' : document.getElementById('unitVacina').value,
                odonto: isConditional ? 'N√£o' : document.getElementById('unitOdonto').value,
                farmacia: isConditional ? 'N√£o' : document.getElementById('unitFarmacia').value,
                enfermeiro: isConditional ? null : document.getElementById('unitEnfermeiro').value.trim() || null,
                gerente: isConditional ? null : document.getElementById('unitGerente').value.trim() || null,
                responsavel: isConditional ? document.getElementById('unitResponsavel').value.trim() || null : null,
                favorite: false // Mant√©m o valor padr√£o no objeto de dados
            };

            // Valida√ß√£o simples
            if (isConditional && !unit.responsavel) {
                alert('O campo Respons√°vel √© obrigat√≥rio para este tipo de unidade.');
                return;
            } else if (!isConditional && (!unit.enfermeiro || !unit.gerente)) {
                // A valida√ß√£o de required j√° est√° no HTML, mas aqui √© um fallback
            }
            
            DataService.saveUnit(unit).then(success => {
                if (success) {
                    alert(`Unidade ${isEdit ? 'atualizada' : 'adicionada'} com sucesso!`);
                    UI.elements.unitForm.reset();
                    App.cancelEdit();
                    this.refreshAll();
                    UI.handleAdminTabClick(document.querySelector('.admin-tab[data-tab="units"]'));
                } else {
                    alert(`Erro ao ${isEdit ? 'atualizar' : 'adicionar'} unidade.`);
                }
            });
        },

        editUnit(id) {
            if (!AuthService.isLogged()) {
                UI.showLogin();
                return;
            }
            
            const unit = this.units.find(u => u.id === id);
            if (!unit) return;

            // Preenche o formul√°rio
            document.getElementById('unitName').value = unit.name;
            document.getElementById('unitType').value = unit.type;
            document.getElementById('unitAddress').value = unit.address;
            document.getElementById('unitBairro').value = unit.bairro;
            document.getElementById('unitPhone').value = unit.phone;
            document.getElementById('unitEmail').value = unit.email || '';
            document.getElementById('unitVacina').value = unit.vacina || 'N√£o';
            document.getElementById('unitOdonto').value = unit.odonto || 'N√£o';
            document.getElementById('unitFarmacia').value = unit.farmacia || 'N√£o';

            // Preenche campos condicionais
            document.getElementById('unitEnfermeiro').value = unit.enfermeiro || '';
            document.getElementById('unitGerente').value = unit.gerente || '';
            document.getElementById('unitResponsavel').value = unit.responsavel || '';
            
            // Re-aplica a l√≥gica condicional ap√≥s preencher o tipo
            UI.setupConditionalFormLogic();

            UI.elements.formTitle.textContent = 'Editar Unidade';
            UI.elements.submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Altera√ß√µes';
            UI.elements.cancelEdit.style.display = 'inline-flex';
            UI.elements.unitForm.setAttribute('data-edit-id', id);
            
            // Muda para a aba de adicionar/editar e abre o painel
            UI.elements.adminTabs.forEach(tab => tab.classList.remove('active'));
            document.querySelector('.admin-tab[data-tab="add"]').classList.add('active');
            document.querySelectorAll('.admin-content').forEach(content => content.classList.remove('active'));
            document.getElementById('add-content').classList.add('active');
            UI.openAdmin();
        },

        cancelEdit() {
            UI.elements.formTitle.textContent = 'Adicionar Nova Unidade';
            UI.elements.submitBtn.innerHTML = '<i class="fas fa-plus"></i> Adicionar Unidade';
            UI.elements.cancelEdit.style.display = 'none';
            UI.elements.unitForm.removeAttribute('data-edit-id');
            UI.elements.unitForm.reset();
            UI.setupConditionalFormLogic();
        },

        async deleteUnit(id) {
            if (!AuthService.isLogged()) {
                UI.showLogin();
                return;
            }
            
            if (!confirm('Tem certeza que deseja excluir esta unidade?')) {
                return;
            }

            if (await DataService.deleteUnit(id)) {
                alert('Unidade exclu√≠da com sucesso!');
                this.refreshAll();
            } else {
                alert('Erro ao excluir unidade.');
            }
        },

        // GitHub Sync Actions
        async syncToGitHub() {
            if (!AuthService.isLogged()) {
                UI.showLogin();
                return;
            }
            UI.showLoading('Sincronizando com GitHub...');
            const result = await DataService.syncToGitHub();
            UI.hideLoading();

            if (result.success) {
                UI.showSyncStatus(`<i class="fas fa-check"></i> ${result.message}`, 'success');
            } else {
                UI.showSyncStatus(`<i class="fas fa-times"></i> ${result.message}`, 'error');
            }
        },

        async pullFromGitHub() {
            if (!AuthService.isLogged()) {
                UI.showLogin();
                return;
            }
            if (!confirm('Isso substituir√° os dados locais pelos do GitHub. Continuar?')) {
                return;
            }
            UI.showLoading('Buscando dados do GitHub...');
            const result = await DataService.pullFromGitHub();
            UI.hideLoading();

            if (result.success) {
                this.units = result.data;
                await this.refreshAll();
                UI.showSyncStatus(`<i class="fas fa-check"></i> ${result.message}`, 'success');
            } else {
                UI.showSyncStatus(`<i class="fas fa-times"></i> ${result.message}`, 'error');
            }
        },

        async testGitHubConnection() {
            if (!AuthService.isLogged()) {
                UI.showLogin();
                return;
            }
            UI.showLoading('Testando conex√£o...');
            const result = await DataService.testGitHubConnection();
            UI.hideLoading();

            if (result.success) {
                UI.showSyncStatus(`<i class="fas fa-check"></i> ${result.message}`, 'success');
            } else {
                UI.showSyncStatus(`<i class="fas fa-times"></i> ${result.message}`, 'error');
            }
        },

        toggleAutoSync() {
            if (!AuthService.isLogged()) {
                UI.showLogin();
                return;
            }
            DataService.setAutoSync(!DataService.autoSyncEnabled);
        },
        
        // Backup e Restore
        backupData() {
            const data = {
                units: DataService.getUnitsSync(),
                favorites: this.favorites
            };
            const filename = `telefonia_backup_${new Date().toISOString().slice(0, 10)}.json`;
            const jsonStr = JSON.stringify(data, null, 2);
            
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('Backup conclu√≠do! Verifique seus downloads.');
        },
        
        restoreData(file) {
            if (!AuthService.isLogged()) {
                UI.showLogin();
                return;
            }
            if (!file) return;

            if (!confirm('Isso substituir√° todos os dados locais. Continuar?')) {
                UI.elements.restoreInput.value = '';
                return;
            }

            UI.showLoading('Restaurando dados...');
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.units) {
                        DataService.saveUnits(data.units);

                        if (data.favorites) {
                            this.favorites = data.favorites;
                            localStorage.setItem('telefonia_favorites', JSON.stringify(this.favorites));
                        }

                        this.refreshAll();
                        alert('Dados restaurados com sucesso!');
                    }
                } catch (error) {
                    alert('Erro ao ler arquivo: ' + error.message);
                } finally {
                    UI.hideLoading();
                }
            };
            reader.readAsText(file);
            UI.elements.restoreInput.value = '';
        },

        clearAllData() {
            if (!AuthService.isLogged()) {
                UI.showLogin();
                return;
            }
            if (!confirm('Isso apagar√° TODOS os dados. Esta a√ß√£o n√£o pode ser desfeita. Continuar?')) {
                return;
            }

            localStorage.removeItem('units');
            localStorage.removeItem('telefonia_favorites');
            localStorage.removeItem('telefonia_isLogged');
            localStorage.removeItem('github_config');
            localStorage.removeItem('github_auto_sync');
            
            this.units = [];
            this.favorites = [];
            this.refreshAll();
            
            alert('Todos os dados foram apagados!');
        }
    };

    // Inicializar aplica√ß√£o
    document.addEventListener('DOMContentLoaded', () => App.init());

    // Expor para debugging
    window.App = App;
    window.UI = UI;
    window.DataService = DataService;
    </script>
</body>
</html>
