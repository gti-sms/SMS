<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Telefonia - Secretaria Municipal de Sa√∫de PMPF</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- jsPDF para exporta√ß√£o -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* ====== VARS & RESET ====== */
        :root{
            --primary:#2c6aa0;--primary-dark:#1e4a73;--secondary:#4caf50;
            --danger:#e74c3c;--warning:#f39c12;--light:#f8f9fa;
            --dark:#343a40;--gray:#6c757d;--border:#dee2e6;
            --shadow:0 4px 12px rgba(0,0,0,.1);--transition:all .3s ease;
            --radius:12px;--radius-sm:8px;
        }
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Arial,sans-serif}
        html,body{width:100%;height:100%;background:#f5f7fa;color:var(--dark);line-height:1.6;overflow-x:hidden}
        
        /* Container & Layout */
        .container{max-width:1400px;margin:0 auto;padding:0 20px;width:100%}
        
        /* Header Improvements */
        header{
            background:linear-gradient(135deg,var(--primary),var(--primary-dark));
            color:#fff;padding:15px 0;box-shadow:var(--shadow);
            position:sticky;top:0;z-index:1000;backdrop-filter:blur(10px);
        }
        .header-content{display:flex;justify-content:space-between;align-items:center;width:100%}
        .logo{display:flex;align-items:center;gap:15px}
        .logo i{font-size:2.2rem;filter:drop-shadow(0 2px 4px rgba(0,0,0,.2))}
        .logo h1{font-size:1.8rem;font-weight:700;letter-spacing:-0.5px}
        .header-actions{display:flex;gap:12px;align-items:center}
        .theme-toggle,.admin-toggle{
            background:rgba(255,255,255,.25);border:0;color:#fff;
            width:44px;height:44px;border-radius:50%;cursor:pointer;
            display:flex;align-items:center;justify-content:center;
            transition:var(--transition);backdrop-filter:blur(10px);
        }
        .theme-toggle:hover,.admin-toggle:hover{
            background:rgba(255,255,255,.4);transform:scale(1.05);
        }
        
        /* Modal Improvements */
        .login-modal{
            display:none;position:fixed;inset:0;
            background:rgba(0,0,0,.6);z-index:2000;
            align-items:center;justify-content:center;backdrop-filter:blur(5px);
        }
        .login-modal.active{display:flex}
        .login-form{
            background:#fff;padding:35px;border-radius:var(--radius);
            box-shadow:0 20px 40px rgba(0,0,0,.3);width:100%;
            max-width:420px;transform:translateY(-20px);animation:slideUp .3s ease forwards;
        }
        @keyframes slideUp{to{transform:translateY(0)}}
        .login-form h2{margin-bottom:25px;color:var(--primary-dark);text-align:center;font-weight:600}
        
        /* Form Improvements */
        .form-group{margin-bottom:20px}
        .form-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark)}
        .form-control{
            width:100%;padding:12px 16px;border:2px solid var(--border);
            border-radius:var(--radius-sm);font-size:1rem;transition:var(--transition);
            background:#fff;
        }
        .form-control:focus{
            outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(44,106,160,.15);
            transform:translateY(-1px);
        }
        .btn{
            padding:12px 24px;border:0;border-radius:var(--radius-sm);cursor:pointer;
            font-weight:600;transition:var(--transition);display:flex;
            align-items:center;gap:10px;font-size:0.95rem;
        }
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 4px 12px rgba(44,106,160,.3)}
        .btn-secondary{background:var(--gray);color:#fff}
        .btn-success{background:var(--secondary);color:#fff}
        .btn-success:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(76,175,80,.3)}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-warning{background:var(--warning);color:#fff}
        .btn-info{background:#17a2b8;color:#fff}
        
        /* Admin Panel Improvements */
        .admin-panel{
            display:none;background:#fff;border-radius:var(--radius);
            padding:30px;margin:30px 0;box-shadow:var(--shadow);width:100%;
            border:1px solid rgba(0,0,0,.05);
        }
        .admin-panel.active{display:block;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0} to{opacity:1}}
        .admin-header{
            display:flex;justify-content:space-between;align-items:center;
            margin-bottom:25px;padding-bottom:20px;
            border-bottom:3px solid var(--primary);
        }
        .admin-title{font-size:1.6rem;font-weight:700;color:var(--primary-dark)}
        .admin-tabs{
            display:flex;gap:5px;margin-bottom:25px;border-bottom:2px solid var(--border);
            background:#f8f9fa;padding:5px;border-radius:var(--radius-sm);
        }
        .admin-tab{
            padding:12px 24px;cursor:pointer;border-radius:var(--radius-sm);
            transition:var(--transition);font-weight:500;flex:1;text-align:center;
        }
        .admin-tab.active{background:var(--primary);color:#fff;box-shadow:var(--shadow)}
        .admin-content{display:none}
        .admin-content.active{display:block;animation:slideIn .3s ease}
        @keyframes slideIn{from{transform:translateX(10px);opacity:0} to{transform:translateX(0);opacity:1}}
        .form-grid{
            display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
            gap:25px;margin-bottom:25px;
        }
        .form-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:30px}
        .units-list{display:flex;flex-direction:column;gap:15px;max-height:500px;overflow-y:auto;padding:5px}
        .unit-item{
            background:var(--light);border-radius:var(--radius-sm);padding:20px;
            border-left:5px solid var(--primary);display:flex;
            justify-content:space-between;align-items:center;transition:var(--transition);
        }
        .unit-item:hover{transform:translateX(5px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
        .unit-actions{display:flex;gap:10px}
        
        /* NOVO: Campo de busca em Gerenciar Unidades */
        .admin-search-container {
            background: #f8f9fa;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        .admin-search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .admin-search-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: var(--transition);
        }
        .admin-search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44,106,160,.15);
        }
        
        /* Search & Cards Improvements */
        .search-container{
            background:#fff;border-radius:var(--radius);padding:30px;
            margin:30px 0;box-shadow:var(--shadow);width:100%;
            border:1px solid rgba(0,0,0,.05);
        }
        .search-box{display:flex;gap:12px;margin-bottom:25px;width:100%}
        .search-input{
            flex:1;padding:16px 20px;border:2px solid var(--border);
            border-radius:var(--radius-sm);font-size:1rem;transition:var(--transition);
            background:#fff;
        }
        .search-input:focus{
            border-color:var(--primary);box-shadow:0 0 0 3px rgba(44,106,160,.15);
            transform:translateY(-1px);
        }
        .search-btn{
            background:var(--primary);color:#fff;border:0;
            border-radius:var(--radius-sm);padding:0 30px;cursor:pointer;
            transition:var(--transition);font-weight:600;font-size:1rem;
        }
        .search-btn:hover{background:var(--primary-dark);transform:translateY(-2px);box-shadow:0 4px 12px rgba(44,106,160,.3)}
        .filter-options{display:flex;gap:12px;flex-wrap:wrap;width:100%}
        .filter-btn{
            background:#fff;border:2px solid var(--border);border-radius:25px;
            padding:10px 20px;cursor:pointer;display:flex;align-items:center;
            gap:8px;transition:var(--transition);font-weight:500;font-size:0.9rem;
        }
        .filter-btn.active{
            background:var(--primary);color:#fff;border-color:var(--primary);
            transform:translateY(-2px);box-shadow:0 4px 12px rgba(44,106,160,.2);
        }
        .filter-btn:hover:not(.active){border-color:var(--primary);transform:translateY(-1px)}
        
        /* Novos filtros para servi√ßos (m√∫ltipla sele√ß√£o) */
        .service-filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 10px;
            width: 100%;
        }
        
        .service-filter-btn {
            background: #fff;
            border: 2px solid var(--border);
            border-radius: 25px;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .service-filter-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44,106,160,.2);
        }
        
        .service-filter-btn:hover:not(.active) {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        /* Links r√°pidos */
        .quick-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 20px;
            width: 100%;
            justify-content: center;
        }
        
        .quick-link-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            background: #fff;
            border: 2px solid var(--border);
            border-radius: 25px;
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            color: var(--gray);
            font-weight: 500;
            text-decoration: none;
            min-width: 80px;
        }
        
        .quick-link-btn:hover {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44,106,160,.2);
            text-decoration: none;
        }
        
        .quick-link-text {
            font-size: 0.75rem;
            font-weight: 500;
            color: inherit;
            text-align: center;
            white-space: nowrap;
        }
        
        /* Tabs & Content */
        .tabs{
            display:flex;border-bottom:2px solid var(--border);margin-bottom:25px;
            flex-wrap:wrap;background:#f8f9fa;padding:5px;border-radius:var(--radius-sm);
        }
        .tab{
            padding:14px 28px;cursor:pointer;border-radius:var(--radius-sm);
            transition:var(--transition);font-weight:600;flex:1;text-align:center;
        }
        .tab.active{background:var(--primary);color:#fff;box-shadow:var(--shadow)}
        .content{display:none;width:100%}
        .content.active{display:block;animation:fadeIn .4s ease}
        .results-count{
            margin-bottom:20px;color:var(--gray);font-size:.95rem;width:100%;
            padding:12px 0;font-weight:500;
        }
        
        /* Contact Cards Improvements */
        .contact-grid{
            display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));
            gap:25px;width:100%;
        }
        .contact-card{
            background:#fff;border-radius:var(--radius);padding:25px;
            box-shadow:var(--shadow);transition:var(--transition);
            border-left:5px solid var(--primary);display:flex;flex-direction:column;
            min-height:420px;position:relative;border:1px solid rgba(0,0,0,.05);
        }
        .contact-card:hover{
            transform:translateY(-5px);box-shadow:0 12px 24px rgba(0,0,0,.15);
        }
        .contact-header{
            display:flex;justify-content:space-between;align-items:flex-start;
            margin-bottom:20px;width:100%;
        }
        .contact-name{font-size:1.3rem;font-weight:700;color:var(--primary-dark);line-height:1.3}
        .contact-type{
            background:rgba(44,106,160,.1);color:var(--primary);padding:6px 14px;
            border-radius:20px;font-size:.85rem;font-weight:600;
        }
        .contact-info{
            display:flex;flex-direction:column;gap:14px;width:100%;flex-grow:1;
        }
        .contact-item{
            display:flex;align-items:flex-start;gap:12px;width:100%;
            padding:8px 0;
        }
        .contact-item i{width:20px;color:var(--primary);margin-top:2px;font-size:1.1rem}
        .contact-services{
            display:flex;justify-content:space-between;margin-top:20px;
            padding-top:20px;border-top:2px solid var(--border);width:100%;
        }
        .service{
            display:flex;flex-direction:column;align-items:center;text-align:center;
            transition:var(--transition);
            position: relative;
        }
        .service i{font-size:1.4rem;margin-bottom:.4rem;transition:var(--transition)}
        .service.available{color:var(--secondary)}
        .service.available i{transform:scale(1.1)}
        .service.unavailable{color:var(--gray);opacity:.6}
        .service-label{font-size:.75rem;margin-top:.3rem;font-weight:600}
        
        /* Tooltip para servi√ßos */
        .service-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            z-index: 100;
        }
        
        .service:hover .service-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        .contact-actions{
            display:flex;gap:12px;margin-top:20px;width:100%;
        }
        .action-btn{
            flex:1;padding:12px;border:0;border-radius:var(--radius-sm);
            cursor:pointer;font-weight:600;display:flex;align-items:center;
            justify-content:center;gap:8px;transition:var(--transition);
            font-size:0.9rem;
        }
        .action-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
        .call-btn{background:var(--secondary);color:#fff}
        .whatsapp-btn{background:#25D366;color:#fff}
        .location-btn{background:transparent;border:2px solid var(--border);color:var(--gray)}
        .location-btn:hover{background:var(--border);color:var(--dark)}
        
        .no-results{
            text-align:center;padding:50px;color:var(--gray);width:100%;
            background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);
        }
        .no-results i{font-size:3rem;margin-bottom:20px;color:var(--primary);opacity:.5}
        
        /* Footer */
        .footer{
            background:var(--dark);color:#fff;text-align:center;padding:25px 0;
            position:fixed;bottom:0;left:0;width:100%;z-index:100;
            backdrop-filter:blur(10px);background:rgba(52,58,64,.95);
        }
        
        /* Dark Mode */
        body.dark-mode{
            background:#1a1d23;color:#e9ecef;
        }
        body.dark-mode .search-container,
        body.dark-mode .contact-card,
        body.dark-mode .filter-btn,
        body.dark-mode .service-filter-btn,
        body.dark-mode .quick-link-btn,
        body.dark-mode .admin-panel,
        body.dark-mode .unit-item,
        body.dark-mode .login-form,
        body.dark-mode .admin-search-container{
            background:#2d3239;color:#e9ecef;border-color:#3d434b;
        }
        body.dark-mode .search-input,
        body.dark-mode .filter-btn,
        body.dark-mode .service-filter-btn,
        body.dark-mode .quick-link-btn,
        body.dark-mode .form-control,
        body.dark-mode .admin-search-input{
            background:#343a40;border-color:#495057;color:#e9ecef;
        }
        body.dark-mode .search-input:focus,
        body.dark-mode .form-control:focus,
        body.dark-mode .admin-search-input:focus{
            border-color:var(--primary);box-shadow:0 0 0 3px rgba(44,106,160,.3);
        }
        body.dark-mode .service-filter-btn,
        body.dark-mode .quick-link-btn{
            background:#343a40;border-color:#495057;color:#e9ecef;
        }
        body.dark-mode .service-filter-btn.active,
        body.dark-mode .quick-link-btn:hover{
            background:var(--primary);color:#fff;border-color:var(--primary);
        }
        body.dark-mode .service-filter-btn:hover:not(.active){
            border-color:var(--primary);
        }
        
        /* CLASSES PARA L√ìGICA CONDICIONAL */
        .hidden {
            display: none !important;
        }
        
        /* ====== NOVOS ESTILOS PARA A ABA RAMAL ====== */
        
        /* Lista de ramais */
        .ramal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            width: 100%;
        }
        
        .ramal-card {
            background: #fff;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-left: 5px solid var(--primary);
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 120px;
        }
        
        .ramal-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0,0,0,.15);
        }
        
        .ramal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .ramal-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-dark);
            line-height: 1.3;
        }
        
        .ramal-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--secondary);
            text-align: center;
            padding: 15px;
            background: rgba(76,175,80,.1);
            border-radius: var(--radius);
            margin-top: 10px;
        }
        
        .ramal-type {
            background: rgba(44,106,160,.1);
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: .85rem;
            font-weight: 600;
        }
        
        /* ====== NOVOS ESTILOS OTIMIZADOS PARA CONTROLES DE EXIBI√á√ÉO ====== */
        
        /* Controles de Exibi√ß√£o (Bloco/Linha) */
        .display-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: flex-end;
        }
        
        .display-btn {
            background: #fff;
            border: 2px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .display-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }
        
        .display-btn:hover:not(.active) {
            border-color: var(--primary);
        }
        
        /* Modo Linha para contatos - OTIMIZADO */
        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        
        .contact-row {
            background: #fff;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-left: 5px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .contact-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,.15);
        }
        
        .contact-row-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        
        .contact-row-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .contact-row-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-dark);
        }
        
        .contact-row-details {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .contact-row-detail {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .contact-row-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Modo Linha para ramais - OTIMIZADO */
        .ramal-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        
        .ramal-row {
            background: #fff;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-left: 5px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ramal-row:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0,0,0,.15);
        }
        
        .ramal-row-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
        }
        
        .ramal-row-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .ramal-row-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-dark);
        }
        
        .ramal-row-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary);
            padding: 10px 15px;
            background: rgba(76,175,80,.1);
            border-radius: var(--radius-sm);
        }
        
        /* Dark mode para novos elementos */
        body.dark-mode .display-btn,
        body.dark-mode .contact-row,
        body.dark-mode .ramal-row,
        body.dark-mode .ramal-card {
            background: #2d3239;
            color: #e9ecef;
            border-color: #3d434b;
        }
        
        body.dark-mode .display-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }
        
        /* Loading states */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            font-size: 1.2rem;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        /* Enhanced Responsive Design */
        @media (max-width:1200px){
            .contact-grid{grid-template-columns:repeat(auto-fill,minmax(350px,1fr))}
            .form-grid{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
            .ramal-grid{grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
        }
        
        @media (max-width:992px){
            .contact-grid{grid-template-columns:repeat(auto-fill,minmax(320px,1fr))}
            .admin-tabs,.tabs{flex-wrap:wrap}
            .admin-tab,.tab{flex:1 1 calc(50% - 10px);min-width:140px}
            .ramal-grid{grid-template-columns:repeat(auto-fill,minmax(250px,1fr))}
            .contact-row,
            .ramal-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .contact-row-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
        
        @media (max-width:768px){
            .header-content{flex-direction:column;gap:15px;text-align:center}
            .contact-grid,.ramal-grid{grid-template-columns:1fr}
            .search-box{flex-direction:column}
            .filter-options,.service-filters,.quick-links{justify-content:center}
            .tabs{overflow-x:auto;white-space:nowrap;flex-wrap:nowrap}
            .form-grid{grid-template-columns:1fr}
            .unit-item{flex-direction:column;align-items:flex-start;gap:15px}
            .unit-actions{width:100%;justify-content:flex-end}
            .admin-tabs,.tabs{padding:3px}
            .admin-tab,.tab{padding:10px 16px;font-size:0.9rem}
            .contact-card{min-height:380px;padding:20px}
            .contact-actions{flex-direction:column}
            .action-btn{width:100%}
            .form-actions{flex-direction:column}
            .btn{width:100%;justify-content:center}
            .display-controls {
                justify-content: center;
            }
            .contact-row-details {
                flex-direction: column;
                gap: 5px;
            }
            .ramal-card{padding:20px}
            .admin-search-box {
                flex-direction: column;
            }
            .quick-link-btn {
                padding: 10px 12px;
                min-width: 70px;
            }
            .quick-link-text {
                font-size: 0.7rem;
            }
        }
        
        @media (max-width:480px){
            .logo h1{font-size:1.5rem}
            .logo i{font-size:1.8rem}
            .tab{padding:10px 12px;font-size:.85rem}
            .service-filter-btn,.quick-link-btn{padding:10px 15px;font-size:0.8rem;gap:6px}
            .filter-btn{padding:8px 15px;font-size:0.8rem}
            .display-btn{padding:8px 12px;font-size:0.8rem}
            .search-input{padding:14px 16px}
            .contact-grid,.ramal-grid{gap:15px}
            .container{padding:0 15px}
            .search-container,.admin-panel{padding:20px}
            .contact-card{padding:18px;min-height:360px}
            .contact-name{font-size:1.2rem}
            .contact-item{gap:10px;padding:6px 0}
            .contact-services{margin-top:15px;padding-top:15px}
            .ramal-card{padding:18px}
            .ramal-number{font-size:1.5rem;padding:12px}
            .quick-links {
                gap: 8px;
            }
            .quick-link-btn {
                padding: 8px 10px;
                min-width: 60px;
            }
            .quick-link-text {
                font-size: 0.65rem;
            }
        }
        
        @media (max-width:360px){
            .contact-grid,.ramal-grid{grid-template-columns:1fr}
            .admin-tab,.tab{flex:1 1 100%;min-width:100%}
            .filter-options,.service-filters,.quick-links{gap:8px}
            .filter-btn,.service-filter-btn,.quick-link-btn,.display-btn{padding:8px 12px;font-size:0.75rem}
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Selection Color */
        ::selection {
            background: rgba(44,106,160,.2);
            color: var(--primary-dark);
        }
        
        /* Estilos para impress√£o */
        @media print {
            header, .search-container, .tabs, .display-controls, .footer, .admin-panel {
                display: none !important;
            }
            
            .container {
                max-width: 100%;
                padding: 0;
                margin: 0;
            }
            
            .contact-card, .ramal-card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
                margin-bottom: 15px;
            }
            
            body {
                background: white;
                color: black;
                font-size: 12pt;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="loading"></div>
            <p style="margin-top: 15px;" id="loadingText">Carregando...</p>
        </div>
    </div>

    <!-- LOGIN MODAL -->
    <div class="login-modal" id="loginModal" aria-hidden="true">
        <div class="login-form" role="dialog" aria-labelledby="loginTitle">
            <h2 id="loginTitle"><i class="fas fa-lock"></i> Acesso Administrativo</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginUsername">Usu√°rio:</label>
                    <input type="text" id="loginUsername" class="form-control" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Senha:</label>
                    <input type="password" id="loginPassword" class="form-control" required autocomplete="current-password">
                </div>
                <div class="form-actions" style="justify-content:center;">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> Entrar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="telefonia-container">
        <header>
            <div class="container">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-phone-alt"></i>
                        <div>
                            <h1>SMS</h1>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="admin-toggle" id="adminToggle" title="Painel Administrativo"><i class="fas fa-cogs"></i></button>
                        <button class="theme-toggle" id="themeToggle" title="Alternar tema"><i class="fas fa-moon"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <!-- ADMIN PANEL -->
        <div class="admin-panel" id="adminPanel" aria-hidden="true">
            <div class="container">
                <div class="admin-header">
                    <h2 class="admin-title">Painel Administrativo</h2>
                    <div>
                        <button class="btn btn-secondary" id="closeAdmin"><i class="fas fa-times"></i> Fechar</button>
                        <button class="btn btn-danger" id="logoutBtn" style="display:none;"><i class="fas fa-sign-out-alt"></i> Sair</button>
                    </div>
                </div>

                <div class="admin-tabs" role="tablist">
                    <div class="admin-tab active" data-tab="units" role="tab">Gerenciar Unidades</div>
                    <div class="admin-tab" data-tab="add" role="tab">Adicionar Unidade</div>
                    <div class="admin-tab" data-tab="config" role="tab">Configura√ß√µes</div>
                </div>

                <!-- UNITS -->
                <div class="admin-content active" id="units-content">
                    <h3>Unidades Cadastradas</h3>
                    
                    <!-- NOVO: Campo de busca para Gerenciar Unidades -->
                    <div class="admin-search-container">
                        <div class="admin-search-box">
                            <input type="text" class="admin-search-input" id="adminSearchInput" placeholder="Buscar unidades por nome, telefone, tipo...">
                            <button class="btn btn-info" id="exportPdfBtn"><i class="fas fa-file-pdf"></i> Exportar PDF</button>
                        </div>
                    </div>
                    
                    <div class="units-list" id="unitsList"></div>
                </div>

                <!-- ADD / EDIT UNIT -->
                <div class="admin-content" id="add-content">
                    <h3 id="formTitle">Adicionar Nova Unidade</h3>
                    <form id="unitForm">
                        <div class="form-grid">
                            <div class="form-group"><label for="unitName">Nome da Unidade *</label><input type="text" id="unitName" class="form-control" required></div>
                            <div class="form-group"><label for="unitType">Tipo *</label>
                                <select id="unitType" class="form-control" required>
                                    <option value="">Selecione o tipo</option>
                                    <option value="promocao">Promo√ß√£o</option>
                                    <option value="recuperacao">Recupera√ß√£o</option>
                                    <option value="administrativo">Administrativo</option>
                                    <option value="vigilancia">Vigil√¢ncia</option>
                                    <option value="capne">Capne</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="unitAddress">Endere√ßo *</label><input type="text" id="unitAddress" class="form-control" required placeholder="Ex: Rua Exemplo, 123"><small class="form-text">O link do Google Maps ser√° gerado automaticamente</small></div>
                            <div class="form-group"><label for="unitBairro">Bairro *</label><input type="text" id="unitBairro" class="form-control" required placeholder="Ex: Centro"></div>
                            <div class="form-group"><label for="unitPhone">Telefone *</label><input type="text" id="unitPhone" class="form-control" required placeholder="Ex: 3314-1234"><small class="form-text">O link do WhatsApp ser√° gerado automaticamente</small></div>
                            <div class="form-group">
                                <label for="unitTemRamal">Tem Ramal?</label>
                                <select id="unitTemRamal" class="form-control">
                                    <option value="N√£o">N√£o</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>
                            <!-- NOVO CAMPO RAMAL CORRIGIDO -->
                            <div class="form-group hidden" id="ramalFieldContainer">
                                <label for="unitRamal">Ramal *</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" id="unitRamal" class="form-control" placeholder="Ex: 1234" maxlength="4" style="flex: 1;">
                                    <button type="button" class="btn btn-secondary" id="autoRamalBtn" style="white-space: nowrap;">
                                        <i class="fas fa-magic"></i> Auto
                                    </button>
                                </div>
                                <small class="form-text">Digite o ramal manualmente ou use o bot√£o "Auto" para preencher com os √∫ltimos 4 d√≠gitos do telefone</small>
                            </div>
                            <div class="form-group"><label for="unitEmail">E-mail</label><input type="email" id="unitEmail" class="form-control" placeholder="exemplo@pmpf.rs.gov.br"></div>
                            
                            <!-- Campo Respons√°vel (ser√° exibido condicionalmente) -->
                            <div class="form-group hidden" id="responsibleFieldContainer">
                                <label for="unitResponsavel">Respons√°vel *</label>
                                <input type="text" id="unitResponsavel" class="form-control" placeholder="Nome do respons√°vel pela unidade">
                            </div>
                            
                            <div class="form-group" id="enfermeiroField"><label for="unitEnfermeiro">Enfermeiro Respons√°vel</label><input type="text" id="unitEnfermeiro" class="form-control" placeholder="Nome do enfermeiro respons√°vel"></div>
                            <div class="form-group" id="gerenteField"><label for="unitGerente">Gerente Respons√°vel</label><input type="text" id="unitGerente" class="form-control" placeholder="Nome do gerente respons√°vel"></div>
                            <div class="form-group" id="vacinaField"><label for="unitVacina">Sala de Vacina</label><select id="unitVacina" class="form-control"><option value="N√£o">N√£o</option><option value="Sim">Sim</option></select></div>
                            <div class="form-group" id="odontoField"><label for="unitOdonto">Consult√≥rio Odontol√≥gico</label><select id="unitOdonto" class="form-control"><option value="N√£o">N√£o</option><option value="Sim">Sim</option></select></div>
                            <div class="form-group" id="farmaciaField">
                                <label for="unitFarmacia">Farm√°cia</label>
                                <select id="unitFarmacia" class="form-control">
                                    <option value="N√£o">N√£o</option>
                                    <option value="Sim">Sim</option>
                                </select>
                            </div>
                            
                            <!-- Campo Farmac√™utico (aparece apenas quando Farm√°cia = Sim) -->
                            <div class="form-group hidden" id="farmaceuticoFieldContainer">
                                <label for="unitFarmaceutico">Farmac√™utico Respons√°vel</label>
                                <input type="text" id="unitFarmaceutico" class="form-control" placeholder="Nome do farmac√™utico respons√°vel">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="cancelEdit" style="display:none;"><i class="fas fa-times"></i> Cancelar</button>
                            <button type="reset" class="btn btn-secondary"><i class="fas fa-eraser"></i> Limpar</button>
                            <button type="submit" class="btn btn-success" id="submitBtn"><i class="fas fa-plus"></i> Adicionar Unidade</button>
                        </div>
                    </form>
                </div>

                <!-- CONFIG -->
                <div class="admin-content" id="config-content">
                    <h3>Configura√ß√µes do Sistema</h3>
                    <div class="form-grid">
                        <div class="form-group"><label for="backupData">Backup de Dados</label><button type="button" id="backupData" class="btn btn-primary"><i class="fas fa-download"></i> Fazer Backup</button></div>
                        <div class="form-group"><label for="restoreData">Restaurar Dados</label><input type="file" id="restoreData" class="form-control" accept=".json"></div>
                        <div class="form-group"><label for="clearAll">Limpar Todos os Dados</label><button type="button" id="clearAll" class="btn btn-danger"><i class="fas fa-trash"></i> Limpar Tudo</button></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN -->
        <main class="container" style="padding-bottom:120px;">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="Buscar por nome, telefone, endere√ßo, enfermeiro, gerente ou farmac√™utico...">
                    <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i> Buscar</button>
                </div>

                <div class="filter-options">
                    <button class="filter-btn active" data-filter="all"><i class="fas fa-th-large"></i> Todos</button>
                    <button class="filter-btn" data-filter="promocao"><i class="fas fa-heart"></i> Promo√ß√£o</button>
                    <button class="filter-btn" data-filter="recuperacao"><i class="fas fa-stethoscope"></i> Recupera√ß√£o</button>
                    <button class="filter-btn" data-filter="administrativo"><i class="fas fa-users"></i> Administrativo</button>
                    <button class="filter-btn" data-filter="vigilancia"><i class="fas fa-shield-alt"></i> Vigil√¢ncia</button>
                    <button class="filter-btn" data-filter="capne"><i class="fas fa-baby"></i> Capne</button>
                    <button class="filter-btn" data-filter="outros"><i class="fas fa-map-marker-alt"></i> Outros</button>
                </div>

                <!-- FILTROS DE SERVI√áOS (M√öLTIPLA SELE√á√ÉO) -->
                <div class="service-filters">
                    <button class="service-filter-btn" data-service="vacina">
                        <i class="fas fa-syringe"></i> Vacina
                    </button>
                    <button class="service-filter-btn" data-service="odonto">
                        <i class="fas fa-tooth"></i> Odonto
                    </button>
                    <button class="service-filter-btn" data-service="farmacia">
                        <i class="fas fa-pills"></i> Farm√°cia
                    </button>
                </div>

                <!-- LINKS R√ÅPIDOS COM √çCONES E NOMES -->
                <div class="quick-links">
                    <a href="https://esus.pmpf.rs.gov.br/" target="_blank" class="quick-link-btn" title="eSUS">
                        <i class="fas fa-laptop-medical"></i>
                        <span class="quick-link-text">eSUS</span>
                    </a>
                    <a href="https://gercon.procempa.com.br/gerconweb/" target="_blank" class="quick-link-btn" title="Gercon">
                        <i class="fas fa-desktop"></i>
                        <span class="quick-link-text">Gercon</span>
                    </a>
                    <a href="http://172.26.72.72:5001" target="_blank" class="quick-link-btn" title="Dashboard">
                        <i class="fas fa-chart-line"></i>
                        <span class="quick-link-text">Dashboard</span>
                    </a>
                    <a href="https://www.google.com/maps/d/viewer?mid=10udieuwsQmwLO8cJeLQidRpRNjBUB0ah&ll=-28.256605790662608%2C-52.406028030716925&z=12" 
                       target="_blank" class="quick-link-btn" title="Mapa">
                        <i class="fas fa-map-marked-alt"></i>
                        <span class="quick-link-text">Mapa</span>
                    </a>
                    <a href="https://cadastro.saude.gov.br/operador/" target="_blank" class="quick-link-btn" title="Cadastro SUS">
                        <i class="fas fa-user-md"></i>
                        <span class="quick-link-text">Cadastro SUS</span>
                    </a>
                    <a href="https://grp.pmpf.rs.gov.br/grp/" target="_blank" class="quick-link-btn" title="GRP">
                        <i class="fas fa-file-alt"></i>
                        <span class="quick-link-text">GRP</span>
                    </a>
                    
                    <!-- NOVOS LINKS SOLICITADOS -->
                    <a href="http://172.16.92.20/glpi" target="_blank" class="quick-link-btn" title="GLPI">
                        <i class="fas fa-tools"></i>
                        <span class="quick-link-text">GLPI</span>
                    </a>
                    <a href="http://172.26.72.72:8080" target="_blank" class="quick-link-btn" title="eSUS Teste">
                        <i class="fas fa-laptop-code"></i>
                        <span class="quick-link-text">eSUS Teste</span>
                    </a>
                    <a href="http://172.26.72.72:5555/" target="_blank" class="quick-link-btn" title="BI Delta">
                        <i class="fas fa-chart-bar"></i>
                        <span class="quick-link-text">BI Delta</span>
                    </a>
                    <a href="https://sisab.saude.gov.br/" target="_blank" class="quick-link-btn" title="Sisab">
                        <i class="fas fa-globe-americas"></i>
                        <span class="quick-link-text">Sisab</span>
                    </a>
                    <a href="https://cnes.datasus.gov.br" target="_blank" class="quick-link-btn" title="CNES">
                        <i class="fas fa-file-medical"></i>
                        <span class="quick-link-text">CNES</span>
                    </a>
                </div>
            </div>

            <!-- Controles de exibi√ß√£o (Bloco/Linha) -->
            <div class="display-controls">
                <button class="display-btn active" data-display="block">
                    <i class="fas fa-th-large"></i> Modo Bloco
                </button>
                <button class="display-btn" data-display="list">
                    <i class="fas fa-list"></i> Modo Linha
                </button>
            </div>

            <!-- REMOVIDA ABA DE FAVORITOS -->
            <div class="tabs" role="tablist">
                <div class="tab active" data-tab="all" role="tab">Todos os Contatos</div>
                <div class="tab" data-tab="ramal" role="tab">Ramal</div>
            </div>

            <div class="content active" id="all-content">
                <div class="results-count" id="all-count">Carregando contatos...</div>
                <div class="contact-grid" id="all-contacts"></div>
                <div class="contact-list hidden" id="all-contacts-list"></div>
            </div>

            <!-- REMOVIDA ABA DE FAVORITOS -->
            <div class="content" id="ramal-content">
                <div class="results-count" id="ramal-count">Lista de ramais</div>
                <div class="ramal-grid" id="ramal-contacts"></div>
                <div class="ramal-list hidden" id="ramal-contacts-list"></div>
            </div>
        </main>

        <footer class="footer">
            <div class="container footer-content">
                <p>Secretaria Municipal de Sa√∫de - Prefeitura de Passo Fundo</p>
            </div>
        </footer>
    </div>

    <script>
    /***********************************************
     * Firebase Configuration & Initialization
     ***********************************************/
    const firebaseConfig = {
        apiKey: "AIzaSyBAWIDL__uXduaupNcv_9vdnPrD9rZLao4",
        authDomain: "telefonia-sms-pmpf.firebaseapp.com",
        projectId: "telefonia-sms-pmpf",
        storageBucket: "telefonia-sms-pmpf.firebasestorage.app",
        messagingSenderId: "949540838663",
        appId: "1:949540838663:web:a911bac3a3057eda09b9a2",
        measurementId: "G-ESLY0RBEF8"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /***********************************************
     * Firebase Database Services - CUSTO ZERO
     ***********************************************/
    const DataService = {
        _cache: {
            units: null,
            lastFetch: 0,
            CACHE_DURATION: 24 * 60 * 60 * 1000 // ‚ö° 24 HORAS de cache - CUSTO ZERO
        },
        
        async getUnits(forceRefresh = false) {
            const now = Date.now();
            
            // üî• ESTRAT√âGIA CUSTO ZERO: Sempre usar cache primeiro
            if (!forceRefresh && this._cache.units) {
                const cacheAge = now - this._cache.lastFetch;
                
                // Se cache tem menos de 24h, NUNCA busca no Firebase
                if (cacheAge < this._cache.CACHE_DURATION) {
                    console.log('üî• CUSTO ZERO: Usando cache local (', Math.round(cacheAge/1000/60), 'minutos)');
                    return this._cache.units;
                }
                
                // Cache expirado (>24h), mas verifica se tem dados offline
                const offlineCache = localStorage.getItem('telefonia_offline_cache');
                if (offlineCache) {
                    console.log('üî• CUSTO ZERO: Cache expirado, usando dados offline');
                    const data = JSON.parse(offlineCache);
                    this._cache.units = data.units || [];
                    this._cache.lastFetch = data.timestamp || now;
                    return this._cache.units;
                }
            }
            
            // ‚ö†Ô∏è S√ì BUSCA NO FIREBASE SE ABSOLUTAMENTE NECESS√ÅRIO
            try {
                console.log('‚ö†Ô∏è  Buscando dados do Firebase (opera√ß√£o rara)');
                const snapshot = await db.collection('unidades').get();
                const units = [];
                snapshot.forEach(doc => {
                    units.push({ id: doc.id, ...doc.data() });
                });
                
                // Atualizar cache por 24 HORAS
                this._cache.units = units;
                this._cache.lastFetch = now;
                
                // Salvar offline por 7 DIAS
                localStorage.setItem('telefonia_offline_cache', JSON.stringify({
                    units: units,
                    timestamp: now,
                    expires: now + (7 * 24 * 60 * 60 * 1000) // 7 dias
                }));
                
                console.log(`üî• Dados carregados: ${units.length} unidades - Cache por 24H`);
                return units;
            } catch (error) {
                console.error('‚ùå Erro ao buscar unidades:', error);
                
                // üî• FALLBACK CUSTO ZERO: Sempre retorna dados offline
                const cached = localStorage.getItem('telefonia_offline_cache');
                if (cached) {
                    console.log('üî• CUSTO ZERO: Usando fallback offline');
                    const data = JSON.parse(cached);
                    
                    // Verificar se dados offline n√£o expiraram (7 dias)
                    if (!data.expires || data.expires > now) {
                        this._cache.units = data.units || [];
                        this._cache.lastFetch = data.timestamp || now;
                        return this._cache.units;
                    }
                }
                
                return [];
            }
        },

        // üî• ESCUTA EM TEMPO REAL APENAS PARA ADMIN (usu√°rios comuns = zero custo)
        subscribeToUnits(callback) {
            // ‚ö° Usu√°rios comuns NUNCA ativam escuta em tempo real
            if (!AuthService.isLogged()) {
                console.log('üî• CUSTO ZERO: Usu√°rio comum - sem escuta em tempo real');
                // Retorna fun√ß√£o vazia para n√£o quebrar o c√≥digo
                return () => {};
            }
            
            console.log('üîß Admin logado - ativando escuta em tempo real');
            return db.collection('unidades').onSnapshot(snapshot => {
                const units = [];
                snapshot.forEach(doc => {
                    units.push({ id: doc.id, ...doc.data() });
                });
                
                // Atualizar cache
                this._cache.units = units;
                this._cache.lastFetch = Date.now();
                
                localStorage.setItem('telefonia_offline_cache', JSON.stringify({
                    units: units,
                    timestamp: Date.now(),
                    expires: Date.now() + (7 * 24 * 60 * 60 * 1000)
                }));
                
                console.log('üîß Admin: Dados atualizados em tempo real');
                callback(units);
            }, error => {
                console.error('‚ùå Erro na escuta em tempo real:', error);
                // N√£o faz nada - mant√©m dados atuais
            });
        },

        async saveUnit(unit) {
            try {
                let result;
                if (unit.id) {
                    // Atualiza√ß√£o
                    const { id, ...unitData } = unit;
                    await db.collection('unidades').doc(id).update(unitData);
                    result = unit;
                } else {
                    // Inser√ß√£o
                    const docRef = await db.collection('unidades').add(unit);
                    result = { id: docRef.id, ...unit };
                }
                
                // üî• Invalidar cache para for√ßar atualiza√ß√£o (apenas admin)
                this._cache.units = null;
                this._cache.lastFetch = 0;
                
                return result;
            } catch (error) {
                console.error('‚ùå Erro ao salvar unidade:', error);
                throw error;
            }
        },

        async deleteUnit(id) {
            try {
                await db.collection('unidades').doc(id).delete();
                
                // üî• Invalidar cache
                this._cache.units = null;
                this._cache.lastFetch = 0;
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir unidade:', error);
                throw error;
            }
        },

        isOnline() {
            return navigator.onLine;
        },

        async forceRefresh() {
            // üî• Force refresh apenas para admin
            if (!AuthService.isLogged()) {
                console.log('üî• CUSTO ZERO: Usu√°rio comum - refresh bloqueado');
                return this._cache.units || [];
            }
            
            this._cache.units = null;
            this._cache.lastFetch = 0;
            return await this.getUnits(true);
        },
        
        // üî• ESTRAT√âGIA CUSTO ZERO: Carregar apenas se necess√°rio
        async loadIfNeeded() {
            if (!this._cache.units) {
                return await this.getUnits();
            }
            return this._cache.units;
        },
        
        // üî• M√âTODO NOVO: Verificar status do cache
        getCacheStatus() {
            if (!this._cache.units) return 'empty';
            
            const cacheAge = Date.now() - this._cache.lastFetch;
            const hours = Math.round(cacheAge / (1000 * 60 * 60));
            
            if (cacheAge < this._cache.CACHE_DURATION) {
                return `fresh_${hours}h`;
            } else {
                return `expired_${hours}h`;
            }
        }
    };

    /***********************************************
     * Authentication Service
     ***********************************************/
    const AuthService = {
        adminUser: 'admin',
        adminPass: 'catarina123',
        
        async login(username, password) {
            await new Promise(resolve => setTimeout(resolve, 120));
            
            if (username === this.adminUser && password === this.adminPass) {
                localStorage.setItem('telefonia_isLogged', 'true');
                return { success: true };
            }
            return { success: false, message: 'Usu√°rio ou senha incorretos' };
        },
        
        logout() {
            localStorage.removeItem('telefonia_isLogged');
        },
        
        isLogged() {
            return localStorage.getItem('telefonia_isLogged') === 'true';
        }
    };

    /***********************************************
     * UI & Application Logic - CUSTO ZERO
     ***********************************************/
    const UI = {
        elements: {},
        
        async cache() {
            this.elements = {
                loginModal: document.getElementById('loginModal'),
                loginForm: document.getElementById('loginForm'),
                loginUsername: document.getElementById('loginUsername'),
                loginPassword: document.getElementById('loginPassword'),
                adminPanel: document.getElementById('adminPanel'),
                adminToggle: document.getElementById('adminToggle'),
                closeAdmin: document.getElementById('closeAdmin'),
                logoutBtn: document.getElementById('logoutBtn'),
                themeToggle: document.getElementById('themeToggle'),
                searchInput: document.getElementById('searchInput'),
                searchBtn: document.getElementById('searchBtn'),
                filterBtns: document.querySelectorAll('.filter-btn'),
                serviceFilterBtns: document.querySelectorAll('.service-filter-btn'),
                tabs: document.querySelectorAll('.tab'),
                adminTabs: document.querySelectorAll('.admin-tab'),
                allContacts: document.getElementById('all-contacts'),
                ramalContacts: document.getElementById('ramal-contacts'),
                allContactsList: document.getElementById('all-contacts-list'),
                ramalContactsList: document.getElementById('ramal-contacts-list'),
                unitsListAdmin: document.getElementById('unitsList'),
                formUnit: document.getElementById('unitForm'),
                submitBtn: document.getElementById('submitBtn'),
                cancelEditBtn: document.getElementById('cancelEdit'),
                formTitle: document.getElementById('formTitle'),
                allCount: document.getElementById('all-count'),
                ramalCount: document.getElementById('ramal-count'),
                backupBtn: document.getElementById('backupData'),
                restoreInput: document.getElementById('restoreData'),
                clearAllBtn: document.getElementById('clearAll'),
                unitType: document.getElementById('unitType'),
                unitFarmacia: document.getElementById('unitFarmacia'),
                farmaceuticoField: document.getElementById('farmaceuticoFieldContainer'),
                unitFarmaceutico: document.getElementById('unitFarmaceutico'),
                responsibleField: document.getElementById('responsibleFieldContainer'),
                enfermeiroField: document.getElementById('enfermeiroField'),
                gerenteField: document.getElementById('gerenteField'),
                vacinaField: document.getElementById('vacinaField'),
                odontoField: document.getElementById('odontoField'),
                farmaciaField: document.getElementById('farmaciaField'),
                displayBtns: document.querySelectorAll('.display-btn'),
                loadingOverlay: document.getElementById('loadingOverlay'),
                loadingText: document.getElementById('loadingText'),
                // NOVOS ELEMENTOS PARA O CAMPO RAMAL
                unitTemRamal: document.getElementById('unitTemRamal'),
                ramalField: document.getElementById('ramalFieldContainer'),
                unitRamal: document.getElementById('unitRamal'),
                autoRamalBtn: document.getElementById('autoRamalBtn'),
                // NOVOS ELEMENTOS PARA AS MELHORIAS
                adminSearchInput: document.getElementById('adminSearchInput'),
                exportPdfBtn: document.getElementById('exportPdfBtn')
            };
        },

        showLoading(message = 'Carregando...') {
            this.elements.loadingText.textContent = message;
            this.elements.loadingOverlay.classList.add('active');
        },

        hideLoading() {
            this.elements.loadingOverlay.classList.remove('active');
        },

        setupConditionalFormLogic() {
            const unitTypeSelect = this.elements.unitType;
            const unitFarmaciaSelect = this.elements.unitFarmacia;
            const unitTemRamalSelect = this.elements.unitTemRamal;
            const unitPhoneInput = document.getElementById('unitPhone');
            const conditionalTypes = ['administrativo', 'vigilancia', 'capne', 'outros'];
            
            const toggleFarmaceuticoField = () => {
                if (unitFarmaciaSelect.value === 'Sim') {
                    this.elements.farmaceuticoField.classList.remove('hidden');
                } else {
                    this.elements.farmaceuticoField.classList.add('hidden');
                }
            };
            
            // NOVA FUN√á√ÉO: Mostrar/ocultar campo de ramal
            const toggleRamalField = () => {
                if (unitTemRamalSelect.value === 'Sim') {
                    this.elements.ramalField.classList.remove('hidden');
                    this.elements.unitRamal.required = true;
                } else {
                    this.elements.ramalField.classList.add('hidden');
                    this.elements.unitRamal.required = false;
                }
            };
            
            // CORRE√á√ÉO: Fun√ß√£o para preenchimento autom√°tico do ramal
            const setupAutoRamal = () => {
                // Evento para o bot√£o Auto
                this.elements.autoRamalBtn.addEventListener('click', () => {
                    const phone = unitPhoneInput.value;
                    if (phone) {
                        const digits = phone.replace(/\D/g, '');
                        const lastFour = digits.slice(-4);
                        this.elements.unitRamal.value = lastFour;
                        
                        // Feedback visual melhorado
                        const originalText = this.elements.autoRamalBtn.innerHTML;
                        const originalBackground = this.elements.autoRamalBtn.style.backgroundColor;
                        
                        this.elements.autoRamalBtn.innerHTML = '<i class="fas fa-check"></i> OK';
                        this.elements.autoRamalBtn.style.backgroundColor = '#4caf50';
                        this.elements.autoRamalBtn.style.color = 'white';
                        
                        setTimeout(() => {
                            this.elements.autoRamalBtn.innerHTML = originalText;
                            this.elements.autoRamalBtn.style.backgroundColor = originalBackground;
                            this.elements.autoRamalBtn.style.color = '';
                        }, 1500);
                    } else {
                        alert('Digite um telefone primeiro para usar o preenchimento autom√°tico');
                        unitPhoneInput.focus();
                    }
                });
                
                // Evento para preenchimento autom√°tico quando o telefone √© alterado
                unitPhoneInput.addEventListener('input', () => {
                    if (this.elements.unitRamal.value === '' && unitPhoneInput.value) {
                        const digits = unitPhoneInput.value.replace(/\D/g, '');
                        const lastFour = digits.slice(-4);
                        if (lastFour.length === 4) {
                            this.elements.unitRamal.value = lastFour;
                        }
                    }
                });
            };
            
            const checkConditionalFields = () => {
                const selectedType = unitTypeSelect.value;
                
                if (conditionalTypes.includes(selectedType)) {
                    this.elements.enfermeiroField.classList.add('hidden');
                    this.elements.gerenteField.classList.add('hidden');
                    this.elements.vacinaField.classList.add('hidden');
                    this.elements.odontoField.classList.add('hidden');
                    this.elements.farmaciaField.classList.add('hidden');
                    this.elements.farmaceuticoField.classList.add('hidden');
                    
                    this.elements.responsibleField.classList.remove('hidden');
                    document.getElementById('unitResponsavel').required = true;
                } else {
                    this.elements.enfermeiroField.classList.remove('hidden');
                    this.elements.gerenteField.classList.remove('hidden');
                    this.elements.vacinaField.classList.remove('hidden');
                    this.elements.odontoField.classList.remove('hidden');
                    this.elements.farmaciaField.classList.remove('hidden');
                    
                    this.elements.responsibleField.classList.add('hidden');
                    document.getElementById('unitResponsavel').required = false;
                    
                    toggleFarmaceuticoField();
                }
                
                // Sempre verificar se deve mostrar o campo de ramal
                toggleRamalField();
            };
            
            unitTypeSelect.addEventListener('change', checkConditionalFields);
            unitFarmaciaSelect.addEventListener('change', toggleFarmaceuticoField);
            unitTemRamalSelect.addEventListener('change', toggleRamalField);
            
            // Configurar o preenchimento autom√°tico do ramal
            setupAutoRamal();
            
            checkConditionalFields();
            toggleFarmaceuticoField();
            toggleRamalField();
        },

        getTypeLabel(type) {
            const map = { 
                'promocao': 'Promo√ß√£o',
                'recuperacao': 'Recupera√ß√£o',
                'administrativo': 'Administrativo',
                'vigilancia': 'Vigil√¢ncia',
                'capne': 'Capne',
                'outros': 'Outros' 
            };
            return map[type] || type;
        },

        shouldShowServices(type) {
            const conditionalTypes = ['administrativo', 'vigilancia', 'capne', 'outros'];
            return !conditionalTypes.includes(type);
        },

        toggleDisplayMode(mode) {
            const isListMode = mode === 'list';
            
            // Atualizar bot√µes
            this.elements.displayBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.display === mode);
            });
            
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            
            // Alternar entre modos de exibi√ß√£o
            if (activeTab === 'ramal') {
                // Aba Ramal
                this.elements.ramalContacts.classList.toggle('hidden', isListMode);
                this.elements.ramalContactsList.classList.toggle('hidden', !isListMode);
            } else {
                // Aba Todos os Contatos
                const contactsElement = this.elements.allContacts;
                const listElement = this.elements.allContactsList;
                
                contactsElement.classList.toggle('hidden', isListMode);
                listElement.classList.toggle('hidden', !isListMode);
            }
            
            localStorage.setItem('telefonia_displayMode', mode);
            
            // üî• CORRE√á√ÉO: Recarregar os dados no modo correto
            App.filterContacts();
        },

        loadDisplayMode() {
            const savedMode = localStorage.getItem('telefonia_displayMode') || 'block';
            this.toggleDisplayMode(savedMode);
        },

        // FUN√á√ÉO ATUALIZADA: Agora verifica se existe um ramal espec√≠fico cadastrado
        getRamalFromUnit(unit) {
            // Se existe um ramal espec√≠fico cadastrado, use-o
            if (unit.ramal && unit.ramal.trim() !== '') {
                return unit.ramal;
            }
            
            // Caso contr√°rio, use os √∫ltimos 4 d√≠gitos do telefone
            if (unit.phone) {
                const digits = unit.phone.replace(/\D/g, '');
                return digits.slice(-4);
            }
            
            return '';
        },

        renderContacts(contacts, container) {
            const isListMode = document.querySelector('.display-btn[data-display="list"]').classList.contains('active');
            
            let htmlContent = '';
            
            if (!contacts || contacts.length === 0) {
                htmlContent = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>Nenhum contato encontrado</h3>
                        <p>Tente ajustar seus filtros ou termos de busca</p>
                    </div>
                `;
            } else if (container === 'ramal') {
                htmlContent = this.renderRamalContent(contacts, isListMode);
            } else {
                htmlContent = this.renderRegularContacts(contacts, isListMode);
            }
            
            // Atualizar o container correto baseado no modo atual
            if (container === 'ramal') {
                if (isListMode) {
                    this.elements.ramalContactsList.innerHTML = htmlContent;
                } else {
                    this.elements.ramalContacts.innerHTML = htmlContent;
                }
            } else {
                if (isListMode) {
                    this.elements.allContactsList.innerHTML = htmlContent;
                } else {
                    this.elements.allContacts.innerHTML = htmlContent;
                }
            }
        },

        renderRamalContent(contacts, isListMode) {
            const unitsWithRamal = contacts.filter(c => c.temRamal === 'Sim' && c.phone && c.phone.trim() !== '');
            
            if (unitsWithRamal.length === 0) {
                return `
                    <div class="no-results">
                        <i class="fas fa-phone"></i>
                        <h3>Nenhum ramal encontrado</h3>
                        <p>Nenhuma unidade possui ramal cadastrado</p>
                    </div>
                `;
            }
            
            let html = '';
            unitsWithRamal.forEach(c => {
                const ramal = this.getRamalFromUnit(c);
                
                if (isListMode) {
                    html += `
                        <div class="ramal-row">
                            <div class="ramal-row-info">
                                <div class="ramal-row-header">
                                    <h3 class="ramal-row-name">${c.name}</h3>
                                    <span class="ramal-type">${this.getTypeLabel(c.type)}</span>
                                </div>
                            </div>
                            <div class="ramal-row-number">${ramal}</div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="ramal-card">
                            <div class="ramal-header">
                                <div>
                                    <h3 class="ramal-name">${c.name}</h3>
                                    <span class="ramal-type">${this.getTypeLabel(c.type)}</span>
                                </div>
                            </div>
                            <div class="ramal-number">${ramal}</div>
                        </div>
                    `;
                }
            });
            
            return html;
        },

        renderRegularContacts(contacts, isListMode) {
            let html = '';
            
            contacts.forEach(c => {
                const phoneClean = c.phone ? c.phone.replace(/\D/g, '') : '';
                const telLink = phoneClean ? `tel:+55${phoneClean}` : '#';
                const whatsappLink = phoneClean ? `https://wa.me/55${phoneClean}` : '#';
                const mapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent((c.address || '') + ', ' + (c.bairro || '') + ', Passo Fundo, RS')}`;
                
                const showServices = this.shouldShowServices(c.type);
                const ramal = this.getRamalFromUnit(c);
                
                if (isListMode) {
                    html += `
                        <div class="contact-row">
                            <div class="contact-row-info">
                                <div class="contact-row-header">
                                    <h3 class="contact-row-name">${c.name}</h3>
                                    <span class="contact-type">${this.getTypeLabel(c.type)}</span>
                                </div>
                                <div class="contact-row-details">
                                    <div class="contact-row-detail">
                                        <i class="fas fa-phone"></i>
                                        <span>${c.phone || 'N√£o informado'}</span>
                                    </div>
                                    ${c.temRamal === 'Sim' ? `
                                    <div class="contact-row-detail">
                                        <i class="fas fa-phone-volume"></i>
                                        <span>Ramal: ${ramal}</span>
                                    </div>` : ''}
                                    <div class="contact-row-detail">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>${c.bairro || 'N√£o informado'}</span>
                                    </div>
                                    ${c.enfermeiro ? `
                                    <div class="contact-row-detail">
                                        <i class="fas fa-user-nurse"></i>
                                        <span>Enf. ${c.enfermeiro}</span>
                                    </div>` : ''}
                                    ${c.gerente ? `
                                    <div class="contact-row-detail">
                                        <i class="fas fa-user-tie"></i>
                                        <span>Gerente: ${c.gerente}</span>
                                    </div>` : ''}
                                    ${c.farmaceutico ? `
                                    <div class="contact-row-detail">
                                        <i class="fas fa-user-md"></i>
                                        <span>Farm. ${c.farmaceutico}</span>
                                    </div>` : ''}
                                    ${c.responsavel ? `
                                    <div class="contact-row-detail">
                                        <i class="fas fa-user"></i>
                                        <span>Respons√°vel: ${c.responsavel}</span>
                                    </div>` : ''}
                                </div>
                            </div>
                            <div class="contact-row-actions">
                                ${phoneClean ? `
                                <button class="btn btn-primary" onclick="window.open('${telLink}', '_self')">
                                    <i class="fas fa-phone"></i>
                                </button>
                                <button class="btn btn-success" onclick="window.open('${whatsappLink}', '_blank')">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                                ` : ''}
                                <button class="btn btn-secondary" onclick="window.open('${mapsLink}', '_blank')">
                                    <i class="fas fa-map"></i>
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="contact-card">
                            <div class="contact-header">
                                <div>
                                    <h3 class="contact-name">${c.name}</h3>
                                    <span class="contact-type">${this.getTypeLabel(c.type)}</span>
                                </div>
                            </div>
                            <div class="contact-info">
                                <div class="contact-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${c.address || 'Endere√ßo n√£o informado'}, ${c.bairro || 'Bairro n√£o informado'}</span>
                                </div>
                                <div class="contact-item">
                                    <i class="fas fa-phone"></i>
                                    <span>${c.phone || 'Telefone n√£o informado'}</span>
                                </div>
                                ${c.temRamal === 'Sim' ? `
                                <div class="contact-item">
                                    <i class="fas fa-phone-volume"></i>
                                    <span>Ramal: ${ramal}</span>
                                </div>` : ''}
                                ${c.email ? `
                                <div class="contact-item">
                                    <i class="fas fa-envelope"></i>
                                    <span>${c.email}</span>
                                </div>` : ''}
                                ${c.enfermeiro ? `
                                <div class="contact-item">
                                    <i class="fas fa-user-nurse"></i>
                                    <span>Enf. ${c.enfermeiro}</span>
                                </div>` : ''}
                                ${c.gerente ? `
                                <div class="contact-item">
                                    <i class="fas fa-user-tie"></i>
                                    <span>Gerente: ${c.gerente}</span>
                                </div>` : ''}
                                ${c.farmaceutico ? `
                                <div class="contact-item">
                                    <i class="fas fa-user-md"></i>
                                    <span>Farm. ${c.farmaceutico}</span>
                                </div>` : ''}
                                ${c.responsavel ? `
                                <div class="contact-item">
                                    <i class="fas fa-user"></i>
                                    <span>Respons√°vel: ${c.responsavel}</span>
                                </div>` : ''}
                            </div>
                            ${showServices ? `
                            <div class="contact-services">
                                <div class="service ${c.vacina === 'Sim' ? 'available' : 'unavailable'}">
                                    <i class="fas fa-syringe"></i>
                                    <span class="service-tooltip">Sala de Vacina</span>
                                    <span class="service-label">Vacina</span>
                                </div>
                                <div class="service ${c.odonto === 'Sim' ? 'available' : 'unavailable'}">
                                    <i class="fas fa-tooth"></i>
                                    <span class="service-tooltip">Consult√≥rio Odontol√≥gico</span>
                                    <span class="service-label">Odonto</span>
                                </div>
                                <div class="service ${c.farmacia === 'Sim' ? 'available' : 'unavailable'}">
                                    <i class="fas fa-pills"></i>
                                    <span class="service-tooltip">Farm√°cia</span>
                                    <span class="service-label">Farm√°cia</span>
                                </div>
                            </div>
                            ` : ''}
                            <div class="contact-actions">
                                ${phoneClean ? `
                                <button class="action-btn call-btn" onclick="window.open('${telLink}', '_self')">
                                    <i class="fas fa-phone"></i> Ligar
                                </button>
                                <button class="action-btn whatsapp-btn" onclick="window.open('${whatsappLink}', '_blank')">
                                    <i class="fab fa-whatsapp"></i> WhatsApp
                                </button>
                                ` : `
                                <button class="action-btn call-btn" disabled style="opacity:0.6">
                                    <i class="fas fa-phone"></i> Sem telefone
                                </button>
                                <button class="action-btn whatsapp-btn" disabled style="opacity:0.6">
                                    <i class="fab fa-whatsapp"></i> Sem WhatsApp
                                </button>
                                `}
                                <button class="action-btn location-btn" onclick="window.open('${mapsLink}', '_blank')">
                                    <i class="fas fa-map"></i> Localiza√ß√£o
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
            
            return html;
        },

        renderUnitsList(units, searchTerm = '') {
            this.elements.unitsListAdmin.innerHTML = '';
            
            let filteredUnits = units;
            
            // Aplicar filtro de busca se houver termo
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredUnits = units.filter(u => 
                    (u.name || '').toLowerCase().includes(term) ||
                    (u.phone || '').includes(term) ||
                    (u.type || '').toLowerCase().includes(term) ||
                    (u.bairro || '').toLowerCase().includes(term) ||
                    (u.enfermeiro || '').toLowerCase().includes(term) ||
                    (u.gerente || '').toLowerCase().includes(term) ||
                    (u.ramal || '').includes(term)
                );
            }
            
            if (filteredUnits.length === 0) {
                this.elements.unitsListAdmin.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-building"></i>
                        <h3>Nenhuma unidade encontrada</h3>
                        <p>${searchTerm ? 'Tente ajustar seus termos de busca' : 'Use a aba "Adicionar Unidade" para cadastrar a primeira unidade'}</p>
                    </div>
                `;
                return;
            }
            
            filteredUnits.forEach(u => {
                const item = document.createElement('div');
                item.className = 'unit-item';
                item.innerHTML = `
                    <div class="unit-info">
                        <h4>${u.name}</h4>
                        <p>${this.getTypeLabel(u.type)} - ${u.phone || 'Sem telefone'} ${u.temRamal === 'Sim' ? `(Ramal: ${u.ramal || this.getRamalFromUnit(u)})` : ''}</p>
                        <small>${u.bairro || 'Sem bairro'}</small>
                    </div>
                    <div class="unit-actions">
                        <button class="btn btn-warning edit-unit" data-id="${u.id}">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-danger delete-unit" data-id="${u.id}">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                `;
                this.elements.unitsListAdmin.appendChild(item);
            });
            
            document.querySelectorAll('.edit-unit').forEach(btn => {
                btn.onclick = () => App.editUnit(btn.dataset.id);
            });
            
            document.querySelectorAll('.delete-unit').forEach(btn => {
                btn.onclick = () => App.deleteUnit(btn.dataset.id);
            });
        },

        showLogin() {
            this.elements.loginModal.classList.add('active');
            this.elements.loginModal.setAttribute('aria-hidden', 'false');
            this.elements.loginUsername.focus();
        },
        
        hideLogin() {
            this.elements.loginModal.classList.remove('active');
            this.elements.loginModal.setAttribute('aria-hidden', 'true');
            this.elements.loginForm.reset();
        },

        openAdmin() {
            this.elements.adminPanel.classList.add('active');
            this.elements.adminPanel.setAttribute('aria-hidden', 'false');
            this.elements.logoutBtn.style.display = 'inline-flex';
        },
        
        closeAdmin() {
            this.elements.adminPanel.classList.remove('active');
            this.elements.adminPanel.setAttribute('aria-hidden', 'true');
        },

        toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = this.elements.themeToggle.querySelector('i');
            
            if (document.body.classList.contains('dark-mode')) {
                icon.className = 'fas fa-sun';
                localStorage.setItem('telefonia_theme', 'dark');
            } else {
                icon.className = 'fas fa-moon';
                localStorage.setItem('telefonia_theme', 'light');
            }
        },

        loadTheme() {
            const theme = localStorage.getItem('telefonia_theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                this.elements.themeToggle.querySelector('i').className = 'fas fa-sun';
            }
        },

        setCounts(all) {
            this.elements.allCount.textContent = `Mostrando ${all} contatos`;
            
            const ramalCount = App.units.filter(u => u.temRamal === 'Sim' && u.phone && u.phone.trim() !== '').length;
            this.elements.ramalCount.textContent = `Mostrando ${ramalCount} ramais`;
        },

        bindUIActions() {
            this.elements.adminToggle.onclick = () => {
                if (AuthService.isLogged()) {
                    this.openAdmin();
                } else {
                    this.showLogin();
                }
            };
            
            this.elements.closeAdmin.onclick = () => this.closeAdmin();
            
            this.elements.logoutBtn.onclick = () => {
                AuthService.logout();
                this.elements.logoutBtn.style.display = 'none';
                this.closeAdmin();
                alert('Desconectado do painel administrativo');
            };

            this.elements.loginForm.onsubmit = async (e) => {
                e.preventDefault();
                const username = this.elements.loginUsername.value.trim();
                const password = this.elements.loginPassword.value;
                
                const result = await AuthService.login(username, password);
                
                if (result.success) {
                    this.hideLogin();
                    this.openAdmin();
                } else {
                    alert(result.message || 'Falha no login');
                }
            };

            this.elements.themeToggle.onclick = () => this.toggleTheme();

            this.elements.searchBtn.onclick = () => App.performSearch();
            this.elements.searchInput.onkeypress = (e) => {
                if (e.key === 'Enter') App.performSearch();
            };

            // Filtros principais (sele√ß√£o √∫nica)
            this.elements.filterBtns.forEach(btn => {
                btn.onclick = function() {
                    UI.elements.filterBtns.forEach(x => x.classList.remove('active'));
                    this.classList.add('active');
                    App.filterContacts();
                };
            });

            // Filtros de servi√ßos (m√∫ltipla sele√ß√£o)
            this.elements.serviceFilterBtns.forEach(btn => {
                btn.onclick = function() {
                    this.classList.toggle('active');
                    App.filterContacts();
                };
            });

            this.elements.tabs.forEach(tab => {
                tab.onclick = function() {
                    UI.elements.tabs.forEach(x => x.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
                    const tabId = this.dataset.tab;
                    document.getElementById(`${tabId}-content`).classList.add('active');
                    
                    // Recarregar o modo de exibi√ß√£o quando trocar de aba
                    UI.loadDisplayMode();
                    
                    App.filterContacts();
                };
            });

            this.elements.adminTabs.forEach(tab => {
                tab.onclick = function() {
                    UI.elements.adminTabs.forEach(x => x.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`${this.dataset.tab}-content`).classList.add('active');
                };
            });

            this.elements.formUnit.onsubmit = async (e) => {
                e.preventDefault();
                await App.saveUnitFromForm();
            };
            
            this.elements.cancelEditBtn.onclick = () => {
                App.cancelEdit();
            };

            this.elements.backupBtn.onclick = () => App.backupData();
            this.elements.restoreInput.onchange = (e) => App.restoreData(e.target.files[0]);
            this.elements.clearAllBtn.onclick = () => App.clearAllData();

            // Modos de exibi√ß√£o - fun√ß√£o corrigida
            this.elements.displayBtns.forEach(btn => {
                btn.onclick = function() {
                    const mode = this.dataset.display;
                    UI.toggleDisplayMode(mode);
                };
            });

            // NOVO: Busca em Gerenciar Unidades
            this.elements.adminSearchInput.addEventListener('input', (e) => {
                App.filterAdminUnits(e.target.value);
            });

            // NOVO: Exportar PDF
            this.elements.exportPdfBtn.addEventListener('click', () => {
                App.exportToPdf();
            });

            this.setupConditionalFormLogic();
        }
    };

    const App = {
        units: [],
        unsubscribe: null,

        async init() {
            await UI.cache();
            UI.loadTheme();
            UI.loadDisplayMode();
            UI.bindUIActions();
            
            if (AuthService.isLogged()) {
                UI.elements.logoutBtn.style.display = 'inline-flex';
            }
            
            this.startRealtimeUpdates();
        },

        startRealtimeUpdates() {
            // üî• CUSTO ZERO: Carregar dados iniciais (apenas 1 leitura por sess√£o)
            this.loadInitialData();
            
            // üî• CUSTO ZERO: Escuta em tempo real APENAS para admin
            if (AuthService.isLogged()) {
                this.unsubscribe = DataService.subscribeToUnits((units) => {
                    console.log('üîß Admin: Dados atualizados em tempo real');
                    this.units = units;
                    this.refreshUI();
                });
            } else {
                console.log('üî• CUSTO ZERO: Usu√°rio comum - sem escuta em tempo real');
            }
        },

        async loadInitialData() {
            try {
                UI.showLoading('Carregando contatos...');
                
                // üî• CUSTO ZERO: M√©todo otimizado que usa cache agressivo
                const units = await DataService.getUnits();
                
                console.log('üî• Dados carregados (CUSTO ZERO):', units.length, 'unidades');
                console.log('üî• Status do cache:', DataService.getCacheStatus());
                
                this.units = units;
                this.refreshUI();
                UI.hideLoading();
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados iniciais:', error);
                UI.hideLoading();
                
                // üî• CUSTO ZERO: Fallback para dados offline
                const cached = localStorage.getItem('telefonia_offline_cache');
                if (cached) {
                    const data = JSON.parse(cached);
                    this.units = data.units || [];
                    this.refreshUI();
                    console.log('üî• Usando fallback offline');
                }
            }
        },

        refreshUI() {
            console.log('üîÑ Atualizando UI com', this.units.length, 'unidades');
            
            // Renderizar em ambos os modos
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            UI.renderContacts(this.units, activeTab);
            
            UI.renderUnitsList(this.units);
            
            UI.setCounts(this.units.length);
        },

        async filterContacts() {
            // üî• CUSTO ZERO: Filtragem local - zero opera√ß√µes no Firebase
            let filtered = this.units.slice();
            
            const activeMainFilter = document.querySelector('.filter-btn.active');
            if (activeMainFilter && activeMainFilter.dataset.filter !== 'all') {
                const mainFilter = activeMainFilter.dataset.filter;
                filtered = filtered.filter(u => u.type === mainFilter);
            }
            
            const activeServiceFilters = document.querySelectorAll('.service-filter-btn.active');
            if (activeServiceFilters.length > 0) {
                filtered = filtered.filter(u => {
                    return Array.from(activeServiceFilters).some(btn => {
                        const service = btn.dataset.service;
                        return u[service] === 'Sim';
                    });
                });
            }
            
            const term = (UI.elements.searchInput.value || '').trim().toLowerCase();
            if (term) {
                filtered = filtered.filter(u => {
                    return (u.name || '').toLowerCase().includes(term) ||
                           (u.phone || '').includes(term) ||
                           (u.address || '').toLowerCase().includes(term) ||
                           (u.bairro || '').toLowerCase().includes(term) ||
                           (u.enfermeiro || '').toLowerCase().includes(term) ||
                           (u.gerente || '').toLowerCase().includes(term) ||
                           (u.farmaceutico || '').toLowerCase().includes(term) ||
                           (u.responsavel || '').toLowerCase().includes(term) ||
                           (u.ramal || '').includes(term);
                });
            }
            
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            
            UI.renderContacts(filtered, activeTab);
            
            const countElement = document.getElementById(`${activeTab}-count`);
            if (countElement) {
                countElement.textContent = `Mostrando ${filtered.length} contatos`;
            }
        },

        // NOVO: Filtro para a se√ß√£o de Gerenciar Unidades
        filterAdminUnits(searchTerm) {
            UI.renderUnitsList(this.units, searchTerm);
        },

        async performSearch() {
            // üî• CUSTO ZERO: Busca local - zero opera√ß√µes no Firebase
            await this.filterContacts();
        },

        async editUnit(id) {
            if (!AuthService.isLogged()) {
                UI.showLogin();
                return;
            }
            
            const unit = this.units.find(u => u.id === id);
            if (!unit) return;
            
            document.getElementById('unitName').value = unit.name || '';
            document.getElementById('unitType').value = unit.type || '';
            document.getElementById('unitAddress').value = unit.address || '';
            document.getElementById('unitBairro').value = unit.bairro || '';
            document.getElementById('unitPhone').value = unit.phone || '';
            document.getElementById('unitTemRamal').value = unit.temRamal || 'N√£o';
            document.getElementById('unitRamal').value = unit.ramal || '';
            document.getElementById('unitEmail').value = unit.email || '';
            document.getElementById('unitEnfermeiro').value = unit.enfermeiro || '';
            document.getElementById('unitGerente').value = unit.gerente || '';
            document.getElementById('unitVacina').value = unit.vacina || 'N√£o';
            document.getElementById('unitOdonto').value = unit.odonto || 'N√£o';
            document.getElementById('unitFarmacia').value = unit.farmacia || 'N√£o';
            document.getElementById('unitFarmaceutico').value = unit.farmaceutico || '';
            document.getElementById('unitResponsavel').value = unit.responsavel || '';
            
            UI.elements.formTitle.textContent = 'Editar Unidade';
            UI.elements.submitBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Altera√ß√µes';
            UI.elements.cancelEditBtn.style.display = 'inline-flex';
            UI.elements.formUnit.setAttribute('data-edit-id', id);
            
            setTimeout(() => {
                UI.setupConditionalFormLogic();
            }, 100);
            
            UI.elements.adminTabs.forEach(t => t.classList.remove('active'));
            document.querySelector('.admin-tab[data-tab="add"]').classList.add('active');
            document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('active'));
            document.getElementById('add-content').classList.add('active');
        },

        cancelEdit() {
            UI.elements.formUnit.reset();
            UI.elements.formTitle.textContent = 'Adicionar Nova Unidade';
            UI.elements.submitBtn.innerHTML = '<i class="fas fa-plus"></i> Adicionar Unidade';
            UI.elements.cancelEditBtn.style.display = 'none';
            UI.elements.formUnit.removeAttribute('data-edit-id');
            UI.setupConditionalFormLogic();
        },

        async deleteUnit(id) {
            if (!AuthService.isLogged()) {
                UI.showLogin();
                return;
            }
            
            if (!confirm('Tem certeza que deseja excluir esta unidade?')) return;
            
            try {
                await DataService.deleteUnit(id);
                alert('Unidade exclu√≠da com sucesso!');
            } catch (error) {
                alert('Erro ao excluir unidade: ' + error.message);
            }
        },

        async saveUnitFromForm() {
            if (!AuthService.isLogged()) {
                UI.showLogin();
                return;
            }
            
            const editId = UI.elements.formUnit.getAttribute('data-edit-id');
            
            const responsibleField = document.getElementById('unitResponsavel');
            const isResponsibleVisible = !responsibleField.closest('.form-group').classList.contains('hidden');
            
            if (isResponsibleVisible && !responsibleField.value.trim()) {
                alert('Por favor, preencha o campo Respons√°vel!');
                responsibleField.focus();
                return;
            }
            
            // NOVO: Validar campo ramal se "Tem Ramal" for "Sim"
            const ramalField = document.getElementById('unitRamal');
            const temRamal = document.getElementById('unitTemRamal').value;
            
            if (temRamal === 'Sim' && !ramalField.value.trim()) {
                alert('Por favor, preencha o campo Ramal ou use o bot√£o "Auto" para preenchimento autom√°tico!');
                ramalField.focus();
                return;
            }
            
            const unitData = {
                name: document.getElementById('unitName').value,
                type: document.getElementById('unitType').value,
                address: document.getElementById('unitAddress').value,
                bairro: document.getElementById('unitBairro').value,
                phone: document.getElementById('unitPhone').value,
                temRamal: temRamal,
                ramal: ramalField.value,
                email: document.getElementById('unitEmail').value,
                enfermeiro: document.getElementById('unitEnfermeiro').value,
                gerente: document.getElementById('unitGerente').value,
                vacina: document.getElementById('unitVacina').value,
                odonto: document.getElementById('unitOdonto').value,
                farmacia: document.getElementById('unitFarmacia').value,
                farmaceutico: document.getElementById('unitFarmaceutico').value,
                responsavel: document.getElementById('unitResponsavel').value
            };
            
            if (editId) {
                unitData.id = editId;
            }
            
            try {
                UI.showLoading(editId ? 'Atualizando unidade...' : 'Adicionando unidade...');
                await DataService.saveUnit(unitData);
                
                // üî• Atualizar cache ap√≥s edi√ß√£o (apenas admin)
                await DataService.forceRefresh();
                
                this.cancelEdit();
                UI.hideLoading();
                
                alert(editId ? 'Unidade atualizada com sucesso!' : 'Unidade adicionada com sucesso!');
                
                this.refreshUI();
                
            } catch (error) {
                UI.hideLoading();
                alert('Erro ao salvar unidade: ' + error.message);
            }
        },

        backupData() {
            const data = { 
                units: this.units,
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup-telefonia-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
            
            alert('Backup realizado com sucesso!');
        },

        restoreData(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.units) {
                        alert('Arquivo de backup inv√°lido!');
                        return;
                    }
                    
                    if (confirm('Isso substituir√° todos os dados atuais. Continuar?')) {
                        UI.showLoading('Restaurando dados...');
                        
                        for (const unit of data.units) {
                            await DataService.saveUnit(unit);
                        }
                        
                        UI.hideLoading();
                        alert('Dados restaurados com sucesso!');
                    }
                } catch (err) {
                    UI.hideLoading();
                    alert('Erro ao ler arquivo: ' + err.message);
                }
            };
            reader.readAsText(file);
            UI.elements.restoreInput.value = '';
        },

        clearAllData() {
            if (!confirm('Isso apagar√° TODOS os dados locais. Esta a√ß√£o n√£o pode ser desfeita. Continuar?')) return;
            
            localStorage.removeItem('telefonia_isLogged');
            localStorage.removeItem('telefonia_displayMode');
            localStorage.removeItem('telefonia_theme');
            localStorage.removeItem('telefonia_offline_cache');
            
            this.refreshUI();
            
            alert('Dados locais limpos! Os dados do Firebase permanecem intactos.');
        },

        // NOVO: Fun√ß√£o para exportar PDF
        exportToPdf() {
            try {
                UI.showLoading('Gerando PDF...');
                
                // Usar jsPDF se dispon√≠vel, caso contr√°rio usar impress√£o nativa
                if (window.jspdf && window.jspdf.jsPDF) {
                    this.generatePdfWithJsPdf();
                } else {
                    this.printNative();
                }
                
                UI.hideLoading();
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                UI.hideLoading();
                alert('Erro ao gerar PDF. Usando impress√£o nativa...');
                this.printNative();
            }
        },

        generatePdfWithJsPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // T√≠tulo
            doc.setFontSize(20);
            doc.text('Lista de Unidades - Secretaria Municipal de Sa√∫de', 20, 20);
            
            // Data de gera√ß√£o
            doc.setFontSize(10);
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 20, 30);
            
            // Preparar dados da tabela
            const tableData = this.units.map(unit => [
                unit.name || '',
                UI.getTypeLabel(unit.type) || '',
                unit.phone || '',
                unit.temRamal === 'Sim' ? (unit.ramal || UI.getRamalFromUnit(unit)) : '',
                unit.bairro || '',
                unit.enfermeiro || unit.gerente || unit.responsavel || ''
            ]);
            
            // Adicionar tabela
            doc.autoTable({
                head: [['Nome', 'Tipo', 'Telefone', 'Ramal', 'Bairro', 'Respons√°vel']],
                body: tableData,
                startY: 40,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [44, 106, 160] }
            });
            
            // Salvar PDF
            doc.save(`unidades-sms-${new Date().toISOString().split('T')[0]}.pdf`);
        },

        printNative() {
            // Criar uma nova janela para impress√£o
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Lista de Unidades - SMS</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: #2c6aa0; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #2c6aa0; color: white; }
                            tr:nth-child(even) { background-color: #f2f2f2; }
                            .header { text-align: center; margin-bottom: 20px; }
                            .timestamp { color: #666; font-size: 12px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Lista de Unidades - Secretaria Municipal de Sa√∫de</h1>
                            <p class="timestamp">Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th>Telefone</th>
                                    <th>Ramal</th>
                                    <th>Bairro</th>
                                    <th>Respons√°vel</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.units.map(unit => `
                                    <tr>
                                        <td>${unit.name || ''}</td>
                                        <td>${UI.getTypeLabel(unit.type) || ''}</td>
                                        <td>${unit.phone || ''}</td>
                                        <td>${unit.temRamal === 'Sim' ? (unit.ramal || UI.getRamalFromUnit(unit)) : ''}</td>
                                        <td>${unit.bairro || ''}</td>
                                        <td>${unit.enfermeiro || unit.gerente || unit.responsavel || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
    };

    document.addEventListener('DOMContentLoaded', () => App.init());

    window.App = App;
    window.UI = UI;
    window.DataService = DataService;
    </script>
</body>
</html>
